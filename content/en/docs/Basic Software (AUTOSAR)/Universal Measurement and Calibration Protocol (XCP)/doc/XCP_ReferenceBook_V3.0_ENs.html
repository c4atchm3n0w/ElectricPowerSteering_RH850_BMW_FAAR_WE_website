---
title: XCP_ReferenceBook_V3.0_ENs
linkTitle: XCP_ReferenceBook_V3.0_ENs
weight: 14
---

<!DOCTYPE html><html>
<head>
<title></title>
<style type="text/css">
<!--
.xflip {
    -moz-transform: scaleX(-1);
    -webkit-transform: scaleX(-1);
    -o-transform: scaleX(-1);
    transform: scaleX(-1);
    filter: fliph;
}
.yflip {
    -moz-transform: scaleY(-1);
    -webkit-transform: scaleY(-1);
    -o-transform: scaleY(-1);
    transform: scaleY(-1);
    filter: flipv;
}
.xyflip {
    -moz-transform: scaleX(-1) scaleY(-1);
    -webkit-transform: scaleX(-1) scaleY(-1);
    -o-transform: scaleX(-1) scaleY(-1);
    transform: scaleX(-1) scaleY(-1);
    filter: fliph + flipv;
}
-->
</style>
</head>
<body>
<a name=1></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-1_1.png"/><br/>
<b>XCP –&#160;The Standard Protocol</b><br/>
for&#160;ECU Development<br/>
<b>Fundamentals&#160;and Application Areas</b><br/>
<b>Andreas Patzer&#160;| Rainer&#160;Zaiser</b><br/>
<hr/>
<a name=2></a><b>Andreas Patzer&#160;|&#160;Rainer&#160;Zaiser</b><br/>
<b>XCP –&#160;The Standard Protocol&#160;for&#160;ECU Development</b><br/>
<hr/>
<a name=3></a>Date December&#160;2016<br/>
Reproduction only&#160;with expressed permission&#160;from&#160;<br/>
Vector&#160;Informatik&#160;GmbH, Ingersheimer&#160;Str. 24, 70499 Stuttgart, Germany<br/>
© 2016 by&#160;Vector&#160;Informatik&#160;GmbH.&#160;All rights reserved.&#160;This book&#160;is only&#160;intended&#160;for&#160;personal use, but not&#160;<br/>
for&#160;technical or&#160;commercial use. It may&#160;not be used as a basis&#160;for&#160;contracts of&#160;any&#160;kind.&#160;All information in&#160;this&#160;<br/>
book&#160;was compiled&#160;with&#160;the greatest possible care, but&#160;Vector&#160;Informatik&#160;does not assume any&#160;guarantee&#160;or&#160;<br/>
warranty&#160;whatsoever&#160;for&#160;the correctness of&#160;the information it contains.&#160;The&#160;liability&#160;of&#160;Vector&#160;Informatik&#160;is&#160;<br/>
excluded, except&#160;for&#160;malicious intent or&#160;gross negligence,&#160;to&#160;the extent&#160;that laws do not make it legally&#160;liable.&#160;<br/>
&#160;&#160;<br/>
Information contained in&#160;this book&#160;may&#160;be protected by&#160;copyright and / or&#160;patent rights. Product names&#160;of&#160;<br/>
software, hardware and other&#160;product names&#160;that are used in&#160;this book&#160;may&#160;be registered brands or&#160;otherwise&#160;<br/>
protected by&#160;branding laws, regardless of&#160;whether&#160;or&#160;not&#160;they&#160;are identified&#160;as registered brands.<br/>
<hr/>
<a name=4></a><b>XCP</b><br/>
<b>The&#160;Standard Protocol</b><br/>
<b>for&#160;ECU Development</b><br/>
<b>Fundamentals&#160;and&#160;Application&#160;Areas</b><br/>
Andreas&#160;Patzer, Rainer&#160;Zaiser&#160;<br/>
Vector&#160;Informatik&#160;GmbH<br/>
<hr/>
<a name=5></a><b>Table of&#160;Contents</b><br/>
<b>Introduction</b>&#160;...........................................................................................................................................&#160;<b>7</b><br/>
<b>1&#160;&#160;Fundamentals of&#160;the&#160;XCP Protocol</b>&#160;...........................................................................................<b>13</b><br/>
<b>1.1&#160;&#160;XCP Protocol Layer</b>&#160;................................................................................................................&#160;<b>19<br/>&#160;&#160;</b><br/>
1.1.1&#160;&#160;Identification Field&#160;........................................................................................................21<br/>
&#160;&#160;<br/>
1.1.2&#160;&#160;Timestamp&#160;.....................................................................................................................21<br/>
&#160;&#160;<br/>
1.1.3&#160;&#160;Data&#160;Field&#160;......................................................................................................................&#160;22<br/>
<b>1.2&#160;&#160;Exchange of&#160;CTOs</b>&#160;..................................................................................................................&#160;<b>22<br/></b>&#160;&#160;<br/>
1.2.1&#160;&#160;XCP Command Structure&#160;..........................................................................................&#160;22<br/>
&#160;&#160;<br/>
1.2.2&#160;&#160;CMD&#160;................................................................................................................................&#160;25<br/>
&#160;&#160;<br/>
1.2.3&#160;&#160;RES&#160;..................................................................................................................................&#160;28<br/>
&#160;&#160;<br/>
1.2.4&#160;&#160;ERR&#160;..................................................................................................................................&#160;28<br/>
&#160;&#160;<br/>
1.2.5&#160;&#160;EV&#160;....................................................................................................................................&#160;29<br/>
&#160;&#160;<br/>
1.2.6&#160;&#160;SERV&#160;...............................................................................................................................&#160;29<br/>
&#160;&#160;<br/>
1.2.7&#160;&#160;Calibrating&#160;Parameters in&#160;the&#160;Slave&#160;.......................................................................&#160;29<br/>
<b>1.3&#160;&#160;Exchanging DTOs – Synchronous Data Exchange</b>&#160;.........................................................&#160;<b>32<br/></b>&#160;&#160;<br/>
1.3.1&#160;&#160;Measurement Methods:&#160;Polling&#160;versus&#160;DAQ&#160;.........................................................&#160;33<br/>
&#160;&#160;<br/>
1.3.2&#160;&#160;DAQ Measurement Method&#160;......................................................................................&#160;34<br/>
&#160;&#160;<br/>
1.3.3&#160;&#160;STIM Calibration Method&#160;...........................................................................................&#160;42<br/>
&#160;&#160;<br/>
1.3.4&#160;&#160;XCP Packet&#160;Addressing&#160;for&#160;DAQ and STIM&#160;...........................................................&#160;43<br/>
&#160;&#160;<br/>
1.3.5&#160;&#160;Bypassing&#160;= DAQ + STIM&#160;...........................................................................................&#160;45<br/>
&#160;&#160;<br/>
1.3.6&#160;&#160;Time Correlation and Synchronization&#160;...................................................................&#160;45<br/>
<b>1.4&#160;&#160;XCP&#160;Transport&#160;Layers</b>&#160;...........................................................................................................<b>49<br/></b>&#160;&#160;<br/>
1.4.1&#160;&#160;CAN&#160;.................................................................................................................................&#160;49<br/>
&#160;&#160;<br/>
1.4.2&#160;&#160;CAN&#160;FD&#160;..........................................................................................................................&#160;52<br/>
&#160;&#160;<br/>
1.4.3&#160;&#160;FlexRay&#160;...........................................................................................................................&#160;54<br/>
&#160;&#160;<br/>
1.4.4&#160;&#160;Ethernet&#160;.........................................................................................................................&#160;57<br/>
&#160;&#160;<br/>
1.4.5&#160;&#160;SxI&#160;....................................................................................................................................&#160;59<br/>
&#160;&#160;<br/>
1.4.6&#160;&#160;USB&#160;................................................................................................................................&#160;60<br/>
&#160;&#160;<br/>
1.4.7&#160;&#160;LIN&#160;..................................................................................................................................&#160;60<br/>
<b>1.5&#160;&#160;XCP Services</b>&#160;............................................................................................................................&#160;<b>61<br/></b>&#160;&#160;<br/>
1.5.1&#160;&#160;Memory&#160;Page&#160;Swapping&#160;.............................................................................................61<br/>
&#160;&#160;<br/>
1.5.2&#160;&#160;Saving&#160;Memory&#160;Pages – Data Page&#160;Freezing&#160;.......................................................&#160;63<br/>
&#160;&#160;<br/>
1.5.3&#160;&#160;Flash&#160;Programming&#160;.....................................................................................................&#160;63<br/>
&#160;&#160;<br/>
1.5.4&#160;&#160;Automatic Detection of&#160;the&#160;Slave&#160;...........................................................................&#160;65<br/>
&#160;&#160;<br/>
1.5.5&#160;&#160;Block&#160;Transfer&#160;Mode&#160;for&#160;Upload, Download and Flashing&#160;.................................66<br/>
&#160;&#160;<br/>
1.5.6&#160;&#160;Cold Start Measurement&#160;...........................................................................................&#160;67<br/>
&#160;&#160;<br/>
1.5.7&#160;&#160;Security&#160;Mechanisms&#160;with&#160;XCP&#160;................................................................................68<br/>
<hr/>
<a name=6></a><b>2&#160;&#160;ECU Description File&#160;A2L</b>&#160;.............................................................................................................<b>71</b><br/>
<b>2.1&#160;&#160;Setting Up an&#160;A2L&#160;File&#160;for&#160;an&#160;XCP Slave</b>&#160;.........................................................................&#160;<b>74<br/>2.2&#160;&#160;Manually&#160;Creating an&#160;A2L&#160;File</b>&#160;............................................................................................&#160;<b>75<br/>2.3&#160;&#160;A2L&#160;Contents&#160;versus ECU Implementation</b>&#160;.....................................................................&#160;<b>76</b><br/>
<b>3&#160;&#160;Calibration Concepts</b>&#160;...................................................................................................................&#160;<b>79</b><br/>
<b>3.1&#160;&#160;Parameters in Flash</b>&#160;..............................................................................................................&#160;<b>80<br/>3.2&#160;&#160;Parameters in RAM</b>&#160;................................................................................................................<b>82<br/>3.3&#160;&#160;Flash Overlay</b>&#160;...........................................................................................................................<b>84<br/>3.4&#160;&#160;Dynamic Flash Overlay&#160;Allocation</b>&#160;.....................................................................................<b>85<br/>3.5&#160;&#160;RAM Pointer&#160;Based Calibration Concept per&#160;AUTOSAR</b>&#160;.............................................<b>86<br/></b>&#160;&#160;<br/>
3.5.1&#160;&#160;Single&#160;Pointer&#160;Concept&#160;...............................................................................................86<br/>
&#160;&#160;<br/>
3.5.2&#160;&#160;Double Pointer&#160;Concept&#160;.............................................................................................88<br/>
<b>3.6&#160;&#160;Flash Pointer&#160;Based Calibration Concept</b>&#160;.......................................................................<b>89</b><br/>
<b>4&#160;&#160;Application&#160;Areas&#160;of&#160;XCP</b>&#160;............................................................................................................&#160;<b>91<br/></b>&#160;<br/>
<b>4.1&#160;&#160;Model in&#160;the Loop (MIL)</b>&#160;.......................................................................................................&#160;<b>93<br/>4.2&#160;&#160;Software in&#160;the Loop (SIL)</b>&#160;..................................................................................................&#160;<b>94<br/>4.3&#160;&#160;Hardware in&#160;the Loop (HIL)</b>&#160;.................................................................................................<b>95<br/>4.4&#160;&#160;Rapid Control Prototyping (RCP)</b>&#160;......................................................................................&#160;<b>97<br/>4.5&#160;Bypassing</b>&#160;..................................................................................................................................<b>98<br/>4.6&#160;&#160;Shortening Iteration Cycles&#160;with&#160;Virtual ECUs</b>&#160;...........................................................&#160;<b>101</b><br/>
<b>5&#160;&#160;Example of&#160;an&#160;XCP Implementation</b>&#160;......................................................................................<b>105<br/></b>&#160;<br/>
<b>5.1&#160;&#160;Description of&#160;Functions</b>&#160;....................................................................................................<b>108<br/>5.2&#160;&#160;Parameterization of&#160;the Driver</b>&#160;........................................................................................&#160;<b>110</b><br/>
<b>6&#160;&#160;Protocol Development Overview</b>&#160;..............................................................................................<b>111<br/></b>&#160;<br/>
<b>6.1&#160;&#160;XCP&#160;Version 1.1 (2008)</b>&#160;.........................................................................................................&#160;<b>112<br/>6.2&#160;&#160;XCP&#160;Version 1.2 (2013)</b>&#160;..........................................................................................................&#160;<b>112<br/>6.3&#160;&#160;XCP&#160;Version 1.3 (2015)</b>..........................................................................................................&#160;<b>113</b><br/>
<b>The&#160;Authors</b>.....................................................................................................................................&#160;<b>114<br/>Table&#160;of&#160;Abbreviations&#160;and&#160;Acronyms</b>&#160;.....................................................................................<b>116<br/>Literature</b>&#160;........................................................................................................................................&#160;<b>117<br/>Web&#160;Addresses</b>...............................................................................................................................&#160;<b>117<br/>Table of&#160;Figures</b>&#160;.............................................................................................................................<b>118<br/>Appendix –&#160;XCP Solutions at&#160;Vector</b>&#160;......................................................................................<b>120<br/>Index</b>&#160;.................................................................................................................................................&#160;<b>122</b><br/>
<hr/>
<a name=7></a>Introduction<br/>
7<br/>
<b>Introduction</b><br/>
In&#160;optimal parameterization&#160;(calibration)&#160;of&#160;electronic ECUs,&#160;you calibrate parameter&#160;values&#160;<br/>during&#160;the&#160;system runtime&#160;and simultaneously&#160;acquire&#160;measured signals.&#160;The physical con­<br/>nection&#160;between&#160;the&#160;development&#160;tool and&#160;the&#160;ECU is&#160;via a measurement and calibration&#160;<br/>protocol.&#160;XCP has&#160;become established&#160;as a standard here.<br/>First,&#160;the&#160;fundamentals and mechanisms of&#160;XCP&#160;will be explained briefly&#160;and&#160;then&#160;the appli­<br/>cation areas&#160;and added&#160;value&#160;for&#160;ECU calibration&#160;will be discussed.<br/>
First, some&#160;facts about&#160;XCP:<br/>&gt;&#160;&#160;XCP signifies&#160;“Universal&#160;Measurement and&#160;Calibration Protocol”.&#160;The “X” stands&#160;for&#160;the&#160;<br/>
variable and interchangeable&#160;transport layer.<br/>
&gt;&#160;&#160;It&#160;was standardized by&#160;an&#160;ASAM&#160;working&#160;committee&#160;(Association&#160;for&#160;Standardisation of&#160;<br/>
Automation&#160;and&#160;Measuring&#160;Systems).&#160;ASAM is an&#160;organization of&#160;automotive OEMs, sup­<br/>pliers and&#160;tool producers.<br/>
&gt;&#160;&#160;XCP is&#160;the&#160;protocol&#160;that succeeds&#160;CCP&#160;(CAN&#160;Calibration Protocol).<br/>&gt;&#160;&#160;The&#160;conceptual idea of&#160;the&#160;CAN&#160;Calibration Protocol&#160;was&#160;to permit read and&#160;write access&#160;<br/>
to&#160;internal&#160;ECU&#160;data&#160;over&#160;CAN.&#160;XCP&#160;was developed&#160;to&#160;implement&#160;this&#160;capability&#160;via&#160;dif­<br/>ferent&#160;transmission&#160;media.&#160;Then&#160;one&#160;speaks&#160;of&#160;XCP on&#160;CAN,&#160;XCP on FlexRay&#160;or&#160;XCP on&#160;<br/>Ethernet.&#160;<br/>
&gt;&#160;&#160;The primary&#160;applications of&#160;XCP&#160;are measurement and calibration&#160;of&#160;internal ECU&#160;para­<br/>
meters.&#160;Here,&#160;the protocol offers&#160;the&#160;ability&#160;to acquire&#160;measured&#160;values “event synchro­<br/>nous”&#160;to processes&#160;in ECUs.&#160;This ensures&#160;consistency&#160;of&#160;the&#160;data between one another.<br/>
To&#160;visualize&#160;the&#160;underlying&#160;idea,&#160;we&#160;initially&#160;view&#160;the&#160;ECU and&#160;the software running in it as a&#160;<br/>black&#160;box. In&#160;a black&#160;box, only&#160;the&#160;inputs&#160;into&#160;the&#160;ECU (e.g.&#160;CAN&#160;messages and sensor&#160;&#160;values)&#160;<br/>and&#160;the&#160;output&#160;from&#160;the&#160;ECU (e.g.&#160;CAN messages&#160;and actuator&#160;drives) are acquired. Details&#160;<br/>about&#160;the&#160;internal processing&#160;of&#160;algorithms are&#160;not immediately&#160;apparent and can only&#160;be&#160;<br/>determined&#160;from an analysis&#160;of&#160;the input and output data.&#160;<br/>
Now&#160;imagine&#160;that&#160;you&#160;had a&#160;look&#160;into&#160;the behavior&#160;of&#160;your&#160;ECU&#160;with&#160;every&#160;computation&#160;<br/>cycle.&#160;At any&#160;time,&#160;you could acquire detailed information on how&#160;the algorithm is running.&#160;<br/>You&#160;would no&#160;longer&#160;have&#160;a black&#160;box, but a&#160;white&#160;box&#160;instead&#160;with a&#160;full&#160;view&#160;of&#160;internal&#160;<br/>processes.&#160;That is precisely&#160;what&#160;you get&#160;with&#160;XCP!&#160;<br/>
What contribution&#160;can&#160;XCP make&#160;for&#160;the&#160;overall development process?&#160;To check&#160;the&#160;func­<br/>tionality&#160;of&#160;the&#160;attained&#160;development status,&#160;the&#160;developer&#160;can execute&#160;the code repeatedly.&#160;<br/>In&#160;this&#160;way,&#160;the&#160;developer&#160;finds&#160;out how&#160;the&#160;algorithm behaves&#160;and&#160;what might be opti­<br/>mized.&#160;It does&#160;not matter&#160;here&#160;whether&#160;a compiled&#160;code&#160;runs&#160;on a specific hardware or&#160;<br/>whether&#160;it is developed in a model­based&#160;way&#160;and&#160;the&#160;application runs in&#160;the&#160;form of&#160;a&#160;<br/>model.<br/>
A&#160;central&#160;focus is on&#160;the evaluation of&#160;the algorithm&#160;process.&#160;For&#160;example,&#160;if&#160;the&#160;algorithm&#160;<br/>is running as a model in a development environment, such&#160;as Simulink&#160;from&#160;The MathWorks,&#160;<br/>it is&#160;helpful&#160;to developers&#160;if&#160;they&#160;can&#160;also&#160;acquire&#160;intermediate&#160;results&#160;to&#160;their&#160;applications,&#160;<br/>in order&#160;to obtain&#160;findings&#160;about other&#160;changes.&#160;In&#160;the&#160;final&#160;analysis,&#160;this method enables&#160;<br/>nothing&#160;other&#160;than read access&#160;to parameters so&#160;that&#160;they&#160;can be&#160;visualized and analyzed –&#160;<br/>
<hr/>
<a name=8></a>8<br/>
Introduction<br/>
and&#160;all of&#160;this&#160;at model&#160;runtime&#160;or&#160;retrospectively&#160;after&#160;a&#160;time­limited&#160;test run has been&#160;<br/>completed.&#160;A&#160;write access&#160;is needed&#160;if&#160;parameterizations&#160;are changed, e.g. if&#160;the propor­<br/>tional component of&#160;a PID&#160;controller&#160;is modified&#160;to adapt&#160;the&#160;algorithm behavior&#160;to&#160;the&#160;<br/>&#160;system under&#160;control. Regardless&#160;of&#160;where&#160;your&#160;application runs –&#160;focal points are always&#160;<br/>the&#160;detailed analysis&#160;of&#160;algorithm processes&#160;and optimization by&#160;changes&#160;to&#160;the&#160;<br/>parameterization.<br/>
This&#160;generalization&#160;can&#160;be&#160;made:&#160;The&#160;algorithms&#160;may&#160;exist in&#160;any&#160;type of&#160;executable&#160;form&#160;<br/>(code or&#160;model description). Different systems may&#160;be used&#160;as&#160;the runtime environment&#160;<br/>(Simulink, as DLL&#160;on&#160;the&#160;PC, on a rapid prototyping&#160;platform, in&#160;the ECU etc.). Process&#160;flows&#160;<br/>are&#160;analyzed&#160;by&#160;read&#160;access&#160;to data and&#160;acquisition&#160;of&#160;its&#160;time­based&#160;flow. Parameter&#160;sets&#160;<br/>are modified&#160;iteratively&#160;to optimize algorithms.&#160;To simplify&#160;the&#160;representation,&#160;the acquisi­<br/>tion&#160;of&#160;data can&#160;be&#160;externalized&#160;to an&#160;external&#160;PC­based&#160;tool, although&#160;it is understood here&#160;<br/>that runtime environments&#160;themselves&#160;can even&#160;offer&#160;analysis&#160;capabilities.<br/>
Runtime Environment<br/>
Application<br/>
Communication<br/>
PC&#160;Tool<br/>
<b>Figure 1:&#160;</b><br/>
Operating System<br/>
<b>Fundamental&#160;<br/>communication with&#160;</b><br/>
<b>a runtime environment</b><br/>
The&#160;type of&#160;runtime environment and&#160;the&#160;form of&#160;communication generally&#160;differ&#160;from one&#160;<br/>another&#160;considerably.&#160;The&#160;reason is&#160;that&#160;the&#160;runtime environments are developed by&#160;differ­<br/>ent producers&#160;and&#160;are&#160;based&#160;on different solution&#160;approaches.&#160;Different&#160;types of&#160;protocols,&#160;<br/>configurations,&#160;measurement&#160;data&#160;formats,&#160;etc.&#160;make it&#160;a&#160;futile effort&#160;to&#160;try&#160;to&#160;exchange&#160;<br/>parameter&#160;sets and results in all development steps.&#160;In&#160;the&#160;end, however, all of&#160;these solu­<br/>tions&#160;can be reduced&#160;to read and&#160;write access&#160;at runtime.&#160;And&#160;there is a standard&#160;for&#160;this:&#160;<br/>XCP.<br/>
XCP&#160;is an&#160;ASAM&#160;standard&#160;whose&#160;Version 1.0&#160;was released&#160;in&#160;2003.&#160;The&#160;acronym&#160;ASAM&#160;<br/>stands&#160;for&#160;“Association&#160;for&#160;Standardisation of&#160;Automation and Measuring Systems.” Sup­<br/>pliers,&#160;vehicle&#160;OEMs&#160;and&#160;tool manufacturers are&#160;all represented&#160;in&#160;the&#160;ASAM&#160;working&#160;group.&#160;<br/>The&#160;purpose&#160;of&#160;the&#160;XCP&#160;working group is&#160;to define&#160;a generalized measurement and calibra­<br/>tion&#160;protocol&#160;that can&#160;be&#160;used&#160;independent of&#160;the&#160;specific&#160;transport medium. Experience&#160;<br/>gained&#160;from working&#160;with&#160;CCP&#160;(CAN&#160;Calibration Protocol)&#160;flowed into&#160;the development as&#160;<br/>well.<br/>
XCP&#160;was defined&#160;based on&#160;the&#160;ASAM&#160;interfaces model.&#160;The&#160;following&#160;figure&#160;shows&#160;a&#160;mea­<br/>surement&#160;and&#160;calibration&#160;tool’s&#160;interfaces&#160;to the&#160;XCP&#160;Slave, to the&#160;description file&#160;and the&#160;<br/>connection&#160;to a higher­level automation system.&#160;<br/>
<hr/>
<a name=9></a>Introduction<br/>
9<br/>
Upper&#160;Level<br/>
Automation System<br/>
ASAM MCD-3 MC<br/>
Measurement and<br/>
ASAM<br/>
Calibration System<br/>
MCD-2 MC<br/>
*.A2L<br/>
<b>XCP Driver</b><br/>
ECU Description File<br/>
ASAM MCD-1 MC<br/>
<b>XCP Driver</b><br/>
ECU&#160;<br/>
<b>Figure 2:&#160;</b><br/>
<b>The Interface Model&#160;<br/>of&#160;ASAM</b><br/>
<b>Interface 1: “ASAM&#160;MCD-1&#160;MC”&#160;between ECU&#160;and measurement&#160;&amp; calibration system<br/></b>This&#160;interface&#160;describes&#160;the&#160;physical and&#160;the&#160;protocol­specific&#160;parts. Strictly&#160;speaking, a dis­<br/>tinction&#160;was&#160;made&#160;between&#160;interfaces&#160;ASAP1a and&#160;ASAP1b here.&#160;The&#160;ASAP1b interface,&#160;<br/>however, never&#160;received&#160;general acceptance&#160;and&#160;for&#160;all practical purposes it has no relevance&#160;<br/>today.&#160;The&#160;XCP protocol is so&#160;flexible&#160;that it can practically&#160;assume&#160;the role of&#160;a general&#160;<br/>manufacturer­independent interface. For&#160;example,&#160;today&#160;all measurement and calibration&#160;<br/>hardware&#160;manufacturers&#160;offer&#160;systems&#160;(xETK,&#160;VX1000, etc.)&#160;which can be connected&#160;via&#160;<br/>the&#160;XCP on&#160;Ethernet standard.&#160;An&#160;ASAP1b interface&#160;– as&#160;it&#160;was still described&#160;for&#160;CCP – is&#160;<br/>no&#160;longer&#160;necessary.&#160;<br/>
<b>Interface 2: “ASAM&#160;MCD-2 MC”&#160;A2L&#160;ECU description&#160;file&#160;<br/></b>As already&#160;mentioned,&#160;XCP&#160;works in an address­oriented&#160;way. Read or&#160;write accesses&#160;to&#160;<br/>objects&#160;are&#160;always&#160;based&#160;on&#160;an address&#160;entry. Ultimately, however,&#160;this&#160;would mean&#160;that&#160;<br/>the&#160;user&#160;would have&#160;to search&#160;for&#160;his&#160;ECU&#160;objects in&#160;the&#160;Master&#160;based on&#160;the address.&#160;That&#160;<br/>would be extremely&#160;inconvenient.&#160;To let users&#160;work&#160;with symbolic object names,&#160;for&#160;example,&#160;<br/>a&#160;file&#160;is&#160;needed&#160;that describes&#160;the&#160;relationship&#160;between&#160;the&#160;object name and&#160;the object&#160;<br/>address.&#160;The&#160;next chapter&#160;is devoted&#160;to&#160;this&#160;A2L&#160;description&#160;file.<br/>
<b>Interface 3: “ASAM&#160;MCD-3 MC”&#160;automation&#160;interface&#160;<br/></b>This&#160;interface is used&#160;to connect another&#160;system&#160;to&#160;the&#160;measurement and calibration&#160;tool,&#160;<br/>e.g.&#160;for&#160;test&#160;bench&#160;automation.&#160;The interface is not&#160;further&#160;explained in&#160;this document,&#160;<br/>because&#160;it is irrelevant&#160;to understanding&#160;XCP.&#160;<br/>
<hr/>
<a name=10></a>10<br/>
Introduction<br/>
XCP is&#160;based&#160;on&#160;the&#160;Master­Slave&#160;principle.&#160;The&#160;ECU is&#160;the&#160;Slave and&#160;the&#160;measurement and&#160;<br/>calibration&#160;tool is&#160;the&#160;Master.&#160;A&#160;Slave&#160;may&#160;only&#160;communicate&#160;with one&#160;Master&#160;at any&#160;given&#160;<br/>time; on&#160;the&#160;other&#160;hand,&#160;the&#160;Master&#160;can simultaneous communicate&#160;with many&#160;Slaves.<br/>
Master<br/>
Bus<br/>
<b>Figure 3:&#160;<br/>An&#160;XCP Master&#160;can&#160;<br/>&#160;simultaneously&#160;</b><br/>
Slave<br/>
Slave<br/>
Slave<br/>
Slave<br/>
<b>&#160;communicate&#160;&#160;with&#160;&#160;&#160;</b><br/>
<b>multiple Slaves</b><br/>
To be&#160;able&#160;to access&#160;data and configurations&#160;over&#160;the&#160;entire&#160;development process,&#160;XCP&#160;<br/>must&#160;be used in&#160;every&#160;runtime environment.&#160;Fewer&#160;tools&#160;would&#160;need&#160;to&#160;be&#160;purchased,&#160;oper­<br/>ated and maintained.&#160;This&#160;would&#160;also&#160;eliminate&#160;the need&#160;for&#160;manual&#160;copying&#160;of&#160;configura­<br/>tions&#160;from one&#160;tool&#160;to another, a process&#160;that is susceptible&#160;to errors.&#160;This&#160;would simplify&#160;<br/>iterative loops, in&#160;which&#160;results&#160;from later&#160;work&#160;steps&#160;are&#160;transferred back&#160;to prior&#160;work&#160;<br/>steps.&#160;<br/>
But let us&#160;turn our&#160;attention away&#160;from&#160;what might be&#160;feasible&#160;to&#160;what is possible&#160;today:&#160;<br/>everything!&#160;XCP solutions&#160;are&#160;already&#160;used in a&#160;wide&#160;variety&#160;of&#160;work&#160;environments. It is&#160;the&#160;<br/>intention of&#160;this&#160;book&#160;to describe&#160;the&#160;main properties&#160;of&#160;the&#160;measurement and calibration&#160;<br/>protocol and introduce its use&#160;in&#160;the&#160;various runtime&#160;environments.&#160;What&#160;you&#160;will not&#160;find in&#160;<br/>this&#160;book: neither&#160;the&#160;entire&#160;XCP specification&#160;in&#160;detailed&#160;form, nor&#160;precise instructions&#160;for&#160;<br/>integrating&#160;XCP drivers in a specific runtime environment. It explains&#160;the relationships, but&#160;<br/>not&#160;the&#160;individual protocol and implementation details.&#160;Internet links in&#160;the appendix&#160;refer&#160;<br/>to openly&#160;available&#160;XCP driver&#160;source code and sample implementations,&#160;which let&#160;you&#160;<br/>understand and see&#160;how&#160;the&#160;implementation is made.&#160;<br/>
Screenshots of&#160;the&#160;PC&#160;tool used&#160;in&#160;this&#160;book&#160;were prepared using&#160;the CANape measurement&#160;<br/>and calibration&#160;tool&#160;from&#160;Vector. Other&#160;process&#160;flows are also explained based on CANape, in&#160;­<br/>cluding how&#160;to create an&#160;A2L&#160;file and even more.&#160;With a cost­free demo&#160;version,&#160;which is avail­<br/>able to&#160;you&#160;in the&#160;Download&#160;Center&#160;of&#160;the&#160;Vector&#160;website&#160;at www.vector.com/canape_demo,&#160;<br/>you can see&#160;for&#160;yourself<br/>
<hr/>
<a name=11></a>1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
13<br/>
<b>1&#160;Fundamentals&#160;of&#160;the&#160;XCP&#160;Protocol</b><br/>
<hr/>
<a name=12></a>14<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Interface 1 of&#160;the&#160;ASAM interfaces&#160;model describes&#160;sending&#160;and receiving commands and&#160;<br/>data between&#160;the&#160;Slave&#160;and&#160;the&#160;Master.&#160;To achieve&#160;independence&#160;from a specific physical&#160;<br/>transport layer,&#160;XCP&#160;was subdivided&#160;into a protocol layer&#160;and a&#160;transport layer.&#160;<br/>
CAN<br/>
Ethernet&#160;FlexRay<br/>
SxI<br/>
USB<br/>
...<br/>
<b>Figure 4: Subdivision of&#160;the&#160;XCP protocol into protocol layer&#160;and &#160;transport layer</b><br/>
Depending&#160;on&#160;the&#160;transport layer, one&#160;refers&#160;to&#160;XCP on&#160;CAN,&#160;XCP on Ethernet, etc.&#160;The&#160;<br/>extendibility&#160;to new&#160;transport layers&#160;was proven&#160;as&#160;early&#160;as&#160;2005&#160;when&#160;XCP on FlexRay&#160;<br/>made its debut.&#160;The&#160;current&#160;version of&#160;the&#160;XCP protocol is&#160;Version 1.3,&#160;which&#160;was approved&#160;<br/>in 2015.<br/>
Adherence&#160;to&#160;the&#160;following&#160;principles&#160;was given&#160;high&#160;priority&#160;in designing&#160;the protocol:<br/>&gt;&#160;&#160;Minimal resource usage&#160;in&#160;the&#160;ECU<br/>&gt;&#160;&#160;&#160;Efficient&#160;&#160;communication<br/>&gt;&#160;&#160;Simple Slave implementation&#160;<br/>&gt;&#160;&#160;Plug­and­play&#160;configuration&#160;with just a small number&#160;of&#160;parameters<br/>&gt;&#160;&#160;&#160;Scalability<br/>
<hr/>
<a name=13></a>1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
15<br/>
A&#160;key&#160;functionality&#160;of&#160;XCP&#160;is&#160;that&#160;it&#160;enables&#160;read and&#160;write access&#160;to&#160;the memory&#160;of&#160;the&#160;<br/>Slave.&#160;<br/>
Read access&#160;lets users measure&#160;the&#160;time response&#160;of&#160;an internal ECU parameter. ECUs are&#160;<br/>systems&#160;with&#160;discrete&#160;time&#160;behavior,&#160;whose&#160;parameters&#160;only&#160;change at specific&#160;time&#160;inter­<br/>vals:&#160;only&#160;when&#160;the&#160;processor&#160;recalculates&#160;the&#160;value&#160;and&#160;updates it in RAM. One&#160;of&#160;the great&#160;<br/>strengths of&#160;XCP lies&#160;in acquiring&#160;measured&#160;values&#160;from&#160;RAM&#160;which change&#160;synchronously&#160;<br/>to process&#160;flows or&#160;events in&#160;the&#160;ECU.&#160;This&#160;lets users evaluate direct relationships between&#160;<br/>time­based&#160;process&#160;flows&#160;in&#160;the&#160;ECU and&#160;the&#160;changing&#160;values.&#160;These are&#160;referred&#160;to as&#160;<br/>event­synchronous measurements.&#160;The&#160;related mechanisms&#160;will be explained later&#160;in detail.<br/>
Write access&#160;lets&#160;the&#160;user&#160;optimize parameters of&#160;algorithms in&#160;the Slave.&#160;The accesses&#160;are&#160;<br/>address­oriented, i.e.&#160;the&#160;communication&#160;between&#160;Master&#160;and Slave references addresses in&#160;<br/>memory. So,&#160;the&#160;measurement of&#160;a parameter&#160;is essentially&#160;implemented as a request of&#160;<br/>the&#160;Master&#160;to&#160;the&#160;Slave:&#160;“Give me&#160;the&#160;value of&#160;memory&#160;location 0x1234”. Calibration of&#160;a&#160;<br/>parameter&#160;–&#160;the&#160;write access&#160;–&#160;to&#160;the&#160;Slave means:&#160;“Set&#160;the&#160;value at address 0x9876&#160;to 5”.<br/>
An&#160;XCP&#160;Slave does not&#160;absolutely&#160;need&#160;to&#160;be used in ECUs.&#160;It&#160;may&#160;be&#160;implemented&#160;in&#160;differ­<br/>ent&#160;environments:&#160;from&#160;a&#160;model­based development&#160;environment&#160;to&#160;hardware­in­the­loop&#160;<br/>and software­in­the­loop environments&#160;to hardware&#160;interfaces&#160;that are used&#160;to access ECU&#160;<br/>memory&#160;via debug&#160;interfaces&#160;such&#160;as&#160;JTAG, NEXUS and DAP.<br/>
Simulink<br/>
Slave<br/>
Prototype or<br/>
ECU Hardware<br/>
Slave<br/>
Measurement/<br/>
<b>XCP</b><br/>
Calibration&#160;<br/>
Master<br/>
Slave<br/>
PC<br/>
Hardware*<br/>
EXE/DLL<br/>
Slave<br/>
HIL/SIL Systems<br/>
<b>Figure 5:&#160;<br/>XCP Slaves can be&#160;</b><br/>
Slave<br/>
<b>used in many&#160;<br/>different runtime&#160;</b><br/>
* Debug Interfaces, Memory Emulator ...<br/>
<b>environments</b><br/>
<hr/>
<a name=14></a>16<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
How&#160;can algorithms be optimized using read and&#160;write access&#160;to&#160;the ECU and&#160;what bene­<br/>fits does&#160;this&#160;offer?&#160;To be able&#160;to modify&#160;individual parameters at runtime in&#160;the ECU,&#160;there&#160;<br/>must be access&#160;to&#160;them. Not every&#160;type&#160;of&#160;memory&#160;permits&#160;this process. It is only&#160;possible&#160;<br/>to perform a read and&#160;write access&#160;to memory&#160;addresses&#160;in RAM&#160;(intentionally&#160;excluding&#160;<br/>the&#160;EEPROM&#160;here).&#160;The&#160;following&#160;is&#160;a brief&#160;summary&#160;of&#160;the&#160;differences between individual&#160;<br/>memory&#160;technologies:&#160;knowledge of&#160;them&#160;is&#160;very&#160;important&#160;to understanding over&#160;the&#160;fur­<br/>ther&#160;course&#160;of&#160;this&#160;book.<br/>
<b>Memory&#160;Fundamentals</b><br/>
Today,&#160;flash memories are usually&#160;integrated in&#160;the microcontroller&#160;chips&#160;for&#160;ECUs and are&#160;<br/>used&#160;for&#160;long­term storage of&#160;code and data, even&#160;without power&#160;supply.&#160;The special aspect&#160;<br/>of&#160;a&#160;flash memory&#160;is&#160;that read and&#160;write access&#160;to individual bytes is indeed possible at any&#160;<br/>time, but&#160;writing of&#160;new&#160;contents can only&#160;be done blockwise, usually&#160;in rather&#160;large blocks.&#160;<br/>
Flash memories have a limited life,&#160;which is specified in&#160;terms of&#160;a maximum number&#160;of&#160;era­<br/>sure cycles&#160;(depending on&#160;the specific&#160;technology&#160;the maximum may&#160;be up&#160;to one million&#160;<br/>cycles).&#160;This is also&#160;the maximum number&#160;of&#160;write cycles, because&#160;the memory&#160;must always&#160;<br/>be erased as a block&#160;before it can be&#160;written again.&#160;The reason&#160;for&#160;this lies in&#160;the memory&#160;<br/>structure: electrons are “pumped”&#160;via&#160;tunnel diodes.&#160;A&#160;bit is stored at a memory&#160;location as&#160;<br/>follows: electrons must be&#160;transported into&#160;the memory&#160;location over&#160;an electrically&#160;insulating&#160;<br/>layer. Once&#160;the electrons are&#160;then behind&#160;the insulating layer,&#160;they&#160;form an electric&#160;field&#160;with&#160;<br/>their&#160;charge,&#160;which is interpreted as a 1&#160;when reading&#160;the memory&#160;location. If&#160;there are no&#160;<br/>electrons behind&#160;the layer,&#160;the cell information is interpreted as a 0.&#160;A&#160;1 can indeed be set in&#160;<br/>this&#160;way, but not a 0. Setting&#160;to 0&#160;(= erasing&#160;the 1) is performed in a separate erasing routine,&#160;<br/>in&#160;which electrons existing behind&#160;the insulating layer&#160;are discharged. However,&#160;for&#160;architec­<br/>tural&#160;reasons, such&#160;an&#160;erasing&#160;routine does not just&#160;act on&#160;single bytes, rather&#160;only&#160;on&#160;the&#160;<br/>group or&#160;block&#160;level. Depending on&#160;the architecture, blocks of&#160;128 or&#160;256 bytes are usually&#160;used.&#160;<br/>If&#160;one&#160;wishes&#160;to overwrite a byte&#160;within such a block,&#160;the entire block&#160;must&#160;first be erased.&#160;<br/>Then&#160;the entire contents of&#160;the block&#160;can be&#160;written back.<br/>
When&#160;this erasing routine is repeated multiple&#160;times,&#160;the insulating layer&#160;(“Tunnel Oxide Film”)&#160;<br/>can be damaged.&#160;This means&#160;that&#160;the electrons could slowly&#160;leak&#160;away, changing some of&#160;the&#160;<br/>information&#160;from 1&#160;to 0 over&#160;the course of&#160;time.&#160;Therefore,&#160;the number&#160;of&#160;allowable&#160;flash&#160;<br/>cycles&#160;is severely&#160;limited in an ECU. In&#160;the production ECU, it is often only&#160;on&#160;the order&#160;of&#160;&#160;single&#160;<br/>digit numbers.&#160;This restriction is monitored by&#160;the Flash Boot Loader,&#160;which uses a counter&#160;to&#160;<br/>keep&#160;track&#160;of&#160;how&#160;many&#160;flash operations&#160;have already&#160;been executed.&#160;When&#160;the specified&#160;<br/>number&#160;is&#160;exceeded,&#160;the Flash Boot Loader&#160;rejects another&#160;flash request.<br/>
A&#160;RAM&#160;(Random&#160;Access Memory) requires&#160;a permanent power&#160;supply; otherwise it loses&#160;its&#160;<br/>contents.&#160;While&#160;flash&#160;memory&#160;serves&#160;the purpose&#160;of&#160;long­term&#160;storage of&#160;the application,&#160;<br/>the&#160;RAM is used&#160;to buffer&#160;computed data and other&#160;temporary&#160;information. Shutting off&#160;<br/>the&#160;power&#160;supply&#160;causes&#160;the&#160;RAM contents&#160;to be&#160;lost. In&#160;contrast&#160;to&#160;flash memory, it is easy&#160;<br/>to read and&#160;write&#160;to RAM.&#160;<br/>
<hr/>
<a name=15></a>1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
17<br/>
This&#160;fact is clear: if&#160;parameters need&#160;to be changed&#160;at runtime, it must be assured&#160;that&#160;they&#160;<br/>are&#160;located&#160;in&#160;RAM. It is&#160;really&#160;very&#160;important&#160;to understand&#160;this circumstance.&#160;That is&#160;why&#160;<br/>we&#160;will look&#160;at&#160;the&#160;execution of&#160;an application in&#160;the&#160;ECU based&#160;on&#160;the&#160;following example:&#160;<br/>
In&#160;the application,&#160;the&#160;y&#160;parameters are computed&#160;from&#160;the&#160;sensor&#160;values&#160;x.&#160;<br/>
// Pseudo­code representation<br/>a = 5;<br/>b = 2;<br/>y&#160;= a *&#160;x&#160;+ b;<br/>
If&#160;the&#160;application&#160;is&#160;flashed&#160;in&#160;the&#160;ECU,&#160;the&#160;controller&#160;handles&#160;this code as&#160;follows after&#160;<br/>booting:&#160;the&#160;values of&#160;the&#160;x&#160;parameters correspond&#160;to&#160;a&#160;sensor&#160;value.&#160;At&#160;some&#160;time&#160;point,&#160;<br/>the&#160;application must&#160;therefore poll&#160;the sensor&#160;value and&#160;the&#160;value is&#160;then stored in a mem­<br/>ory&#160;location assigned&#160;to&#160;the&#160;x&#160;parameters.&#160;Since&#160;this&#160;value always needs&#160;to be rewritten at&#160;<br/>runtime,&#160;the&#160;memory&#160;location can only&#160;lie in RAM.&#160;<br/>
The&#160;parameter&#160;y&#160;is&#160;computed.&#160;The&#160;values&#160;a and&#160;b, as&#160;factor&#160;and&#160;offset, are included as infor­<br/>mation&#160;in&#160;flash&#160;memory.&#160;They&#160;are&#160;stored&#160;as&#160;constants&#160;there.&#160;The&#160;value of&#160;y&#160;must also be&#160;<br/>stored in RAM, because once again&#160;that is&#160;the&#160;only&#160;place&#160;where&#160;write&#160;access is pos&#160;sible.&#160;At&#160;<br/>precisely&#160;which location in RAM&#160;the parameters&#160;x&#160;and&#160;y&#160;are located,&#160;or&#160;where a and&#160;b&#160;lie in&#160;<br/>flash,&#160;is set in&#160;the compiler/linker&#160;run.&#160;This&#160;is&#160;where objects are allocated&#160;to unique addresses.&#160;<br/>The relationship&#160;between&#160;object&#160;name,&#160;data&#160;type and address&#160;is&#160;documented&#160;in&#160;the&#160;linker­<br/>map&#160;file.&#160;The&#160;linker­map&#160;file&#160;is generated by&#160;the&#160;Linker&#160;run and can exist in different&#160;formats.&#160;<br/>Common&#160;to all&#160;formats, however, is&#160;that&#160;they&#160;contain&#160;the&#160;object name&#160;and address at a&#160;<br/>minimum.&#160;<br/>
In&#160;the&#160;example, if&#160;the&#160;offset b and&#160;factor&#160;a depend&#160;on&#160;the&#160;specific&#160;vehicle,&#160;the&#160;values of&#160;a and&#160;<br/>b must be individually&#160;adapted&#160;to&#160;the&#160;specific&#160;conditions&#160;of&#160;the&#160;vehicle.&#160;This&#160;means&#160;that&#160;the&#160;<br/>algorithm remains&#160;as it is, but&#160;the&#160;parameter&#160;values&#160;change&#160;from&#160;vehicle&#160;to&#160;vehicle.<br/>
In&#160;the&#160;normal operating&#160;mode&#160;of&#160;an&#160;ECU,&#160;the&#160;application&#160;runs&#160;from&#160;the&#160;flash memory. It&#160;<br/>does&#160;not permit any&#160;write accesses&#160;to individual objects.&#160;This&#160;means&#160;that parameter&#160;values&#160;<br/>which&#160;are&#160;located&#160;in&#160;the&#160;flash&#160;area&#160;cannot be&#160;modified&#160;at runtime. If&#160;a change&#160;to parameter&#160;<br/>values&#160;should&#160;be possible&#160;during&#160;runtime,&#160;the&#160;parameters&#160;to be modified must lie in RAM&#160;<br/>and not in&#160;flash. Now, how&#160;do&#160;the&#160;parameters and&#160;their&#160;initial&#160;values make&#160;their&#160;way&#160;into&#160;<br/>RAM? How&#160;does&#160;one&#160;solve&#160;the&#160;problem of&#160;needing&#160;to modify&#160;more parameters&#160;than can be&#160;<br/>simultaneously&#160;stored&#160;in&#160;RAM?&#160;These&#160;issues&#160;lead&#160;us&#160;to&#160;the&#160;topic of&#160;calibration concepts (see&#160;<br/>chapter&#160;3).<br/>
<hr/>
<a name=16></a>18<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>Summary&#160;of&#160;XCP&#160;fundamentals</b><br/>
Read&#160;and&#160;write&#160;accesses&#160;to memory&#160;contents&#160;are&#160;available&#160;with&#160;the mechanisms of&#160;the&#160;XCP&#160;<br/>protocol.&#160;The accesses&#160;are made in&#160;an address­oriented&#160;way. Read&#160;access&#160;enables&#160;measure­<br/>ment of&#160;parameters&#160;from RAM,&#160;and&#160;write access&#160;enables&#160;calibration of&#160;the parameters in&#160;<br/>RAM.&#160;XCP permits execution of&#160;the measurement synchronous&#160;to events in&#160;the ECU.&#160;This&#160;<br/>ensures&#160;that&#160;the&#160;measured&#160;values&#160;correlate&#160;with one&#160;another.&#160;With every&#160;restart of&#160;a&#160;<br/>&#160;measurement,&#160;the signals&#160;to&#160;be measured can be&#160;freely&#160;selected.&#160;For&#160;write access,&#160;the&#160;<br/>parameters&#160;to be calibrated must be stored in RAM.&#160;This&#160;requires a calibration concept<br/>
This&#160;leads&#160;to&#160;two important questions:<br/>&gt;&#160;&#160;How&#160;does&#160;the user&#160;of&#160;the&#160;XCP&#160;protocol&#160;know&#160;the correct&#160;addresses&#160;of&#160;the&#160;measurement&#160;<br/>
and calibration parameters in RAM?<br/>
&gt;&#160;&#160;What does&#160;the&#160;calibration concept look&#160;like?<br/>
The&#160;first question is answered in chapter&#160;2 “ECUs description&#160;file&#160;A2L”.&#160;The&#160;topic of&#160;the cali­<br/>bration concept is addressed&#160;in chapter&#160;3.<br/>&#160;<br/>
<hr/>
<a name=17></a>1.1&#160;XCP Protocol Layer<br/>
19<br/>
<b>1.1&#160;XCP&#160;Protocol&#160;Layer</b><br/>
XCP&#160;data&#160;is exchanged&#160;between&#160;the Master&#160;and Slave in a&#160;message­based&#160;way.&#160;The entire&#160;<br/>“XCP message&#160;frame” is&#160;embedded&#160;in a&#160;frame&#160;of&#160;the&#160;transport layer&#160;(in&#160;the case of&#160;XCP on&#160;<br/>Ethernet&#160;with UDP in a UDP packet).&#160;The&#160;frame consists of&#160;three parts:&#160;the&#160;XCP header,&#160;the&#160;<br/>XCP&#160;packet&#160;and the&#160;XCP tail.&#160;<br/>
In&#160;the&#160;following&#160;figure, part of&#160;a message&#160;is shown in red.&#160;It is used&#160;to send&#160;the current&#160;XCP&#160;<br/>frame.&#160;The&#160;XCP header&#160;and&#160;XCP&#160;tail depend&#160;on&#160;the&#160;transport protocol.<br/>
XCP Message (Frame)<br/>
XCP Header<br/>
<b>XCP Packet</b><br/>
XCP Tail<br/>
<b>PID&#160;FILL</b><br/>
<b>DAQ</b><br/>
<b>TIMESTAMP</b><br/>
<b>DATA</b><br/>
<b>Identification</b><br/>
<b>Timestamp</b><br/>
<b>Data&#160;</b><br/>
<b>Figure 6:&#160;</b><br/>
<b>Field</b><br/>
<b>Field</b><br/>
<b>Field</b><br/>
<b>XCP packet</b><br/>
The&#160;XCP&#160;packet&#160;itself&#160;is independent&#160;of&#160;the&#160;transport&#160;protocol&#160;used.&#160;It&#160;always&#160;contains&#160;three&#160;<br/>components:&#160;“Identification Field”, “Timestamp Field” and&#160;the&#160;current data&#160;field “Data&#160;<br/>Field”. Each Identification Field begins&#160;with&#160;the&#160;Packet Identifier&#160;(PID), which&#160;identifies the&#160;<br/>packet.&#160;<br/>
The&#160;following&#160;overview&#160;shows&#160;which&#160;PIDs have been&#160;defined:<br/>
PID for frames&#160;<br/>
PID for frames<br/>
from Master to Slave<br/>
from Slave to Master&#160;<br/>
0xFF<br/>
0xFF<br/>
RES<br/>
0xFE<br/>
ERR<br/>
CMD<br/>
....<br/>
0xFD<br/>
EV<br/>
0xC0<br/>
0xFC<br/>
SERV<br/>
0xBF<br/>
0xFB<br/>
absolute or<br/>
absolute or<br/>
relative<br/>
....<br/>
relative<br/>
ODT number<br/>
....<br/>
ODT number<br/>
for STIM&#160;<br/>
for DAQ&#160;<br/>
0x00<br/>
0x00<br/>
<b>Figure 7: Overview&#160;of&#160;XCP Packet Identifier&#160;(PID)</b><br/>
<hr/>
<a name=18></a>20<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Communication&#160;via&#160;the&#160;XCP packet is subdivided into one&#160;area&#160;for&#160;commands (CTO) and&#160;<br/>one&#160;area&#160;for&#160;sending&#160;synchronous data (DTO).&#160;<br/>
<b>XCP&#160;Master</b><br/>
XCP&#160;Driver<br/>
<b>CTO</b><br/>
<b>DTO</b><br/>
CMD<br/>
RES<br/>
ERR<br/>
EV<br/>
SERV<br/>
DAQ<br/>
STIM<br/>
Command&#160;/&#160;Response&#160;/&#160;Error&#160;/&#160;<br/>
DAQ<br/>
STIM<br/>
Event / Service Request Processor&#160;<br/>
Processor<br/>
Processor<br/>
Bypass<br/>
XCP Handler<br/>
PGM<br/>
CAL<br/>
DAQ<br/>
STIM<br/>
Resources<br/>
<b>Figure 8:&#160;</b><br/>
<b>XCP&#160;Slave</b><br/>
<b>XCP communication&#160;<br/>model with&#160;CTO/DTO</b><br/>
The&#160;acronyms used&#160;here stand for<br/>
CMD&#160;<br/>
Command Packet&#160;&#160;<br/>
sends&#160;commands&#160;<br/>
RES&#160;<br/>
Command Response&#160;Packet&#160;<br/>
positive response<br/>
ERR&#160;<br/>
Error&#160;<br/>
negative response<br/>
EV&#160;<br/>
Event Packet&#160;<br/>
asynchronous event<br/>
SERV&#160;&#160;<br/>
Service Request&#160;Packet&#160;<br/>
service request<br/>
DAQ&#160;<br/>
Data&#160;AcQuisition&#160;<br/>
send&#160;periodic measured&#160;values<br/>
STIM&#160;<br/>
Stimulation&#160;<br/>
periodic stimulation of&#160;the Slave<br/>
Commands are exchanged&#160;via CTOs (Command&#160;Transfer&#160;Objects).&#160;The Master&#160;initiates&#160;con­<br/>tact in&#160;this&#160;way,&#160;for&#160;example.&#160;The&#160;Slave must always respond&#160;to a CMD&#160;with RES or&#160;ERR.&#160;<br/>The&#160;other&#160;CTO messages&#160;are&#160;sent asynchronously.&#160;The&#160;Data&#160;Transfer&#160;Objects (DTO) are&#160;<br/>used&#160;to exchange&#160;synchronous measurement and stimulation data.<br/>
<hr/>
<a name=19></a>1.1&#160;XCP Protocol Layer<br/>
21<br/>
<b>1.1.1&#160;Identification&#160;Field</b><br/>
XCP Packet<br/>
<b>PID&#160;FILL</b><br/>
<b>DAQ</b><br/>
TIMESTAMP<br/>
DATA<br/>
<b>Identification Field</b><br/>
<b>Figure 9:&#160;<br/>Message identification</b><br/>
When&#160;messages&#160;are&#160;exchanged,&#160;both&#160;the&#160;Master&#160;and&#160;Slave&#160;must be able&#160;to determine&#160;which&#160;<br/>message&#160;was sent by&#160;the&#160;other.&#160;This&#160;is accomplished&#160;in&#160;the&#160;identification&#160;field.&#160;That is&#160;why&#160;<br/>each&#160;message&#160;begins&#160;with&#160;the&#160;Packet Identifier&#160;(PID).<br/>
In&#160;transmitting&#160;CTOs, the&#160;PID&#160;field&#160;is&#160;fully&#160;sufficient&#160;to identify&#160;a CMD, RES&#160;or&#160;other&#160;CTO&#160;<br/>packet. In Figure 7, it&#160;can be seen&#160;that commands&#160;from&#160;the&#160;Master&#160;to&#160;the Slave&#160;utilize a&#160;PID&#160;<br/>from 0xC0&#160;to 0xFF.&#160;The&#160;XCP Slave&#160;responds&#160;or&#160;informs&#160;the&#160;Master&#160;with PIDs&#160;from 0xFC&#160;to&#160;<br/>0xFF.&#160;This&#160;results in a unique&#160;allocation of&#160;the&#160;PIDs&#160;to&#160;the&#160;individually&#160;sent CTOs.<br/>When&#160;DTOs&#160;are&#160;transmitted, other&#160;elements of&#160;the&#160;identification&#160;field are used (see chap­<br/>ter&#160;1.3.4 “XCP Packet&#160;Addressing&#160;for&#160;DAQ and STIM”).<br/>
<b>1.1.2&#160;Timestamp</b><br/>
XCP Packet<br/>
PID&#160;FILL<br/>
DAQ<br/>
<b>TIMESTAMP</b><br/>
DATA<br/>
<b>Figure 10:&#160;<br/>Timestamp</b><br/>
DTO&#160;packets use&#160;timestamps, but&#160;this&#160;is not possible&#160;in&#160;transmission of&#160;a CTO&#160;message. The&#160;<br/>Slave&#160;uses&#160;the&#160;timestamp to&#160;supply&#160;time&#160;information with&#160;measured&#160;values.&#160;That&#160;is, the&#160;<br/>Master&#160;not only&#160;has&#160;the&#160;measured&#160;value, but also&#160;the&#160;time point at&#160;which&#160;the measured&#160;<br/>value was&#160;acquired.&#160;The&#160;amount&#160;of&#160;time&#160;it takes&#160;for&#160;the&#160;measured&#160;value to&#160;arrive&#160;at the&#160;<br/>Master&#160;is no&#160;longer&#160;important, because&#160;the&#160;relationship&#160;between&#160;the measured&#160;value and&#160;<br/>the&#160;time point comes&#160;directly&#160;from&#160;the&#160;Slave.&#160;<br/>Transmission&#160;of&#160;a&#160;timestamp&#160;from&#160;the&#160;Slave&#160;is&#160;optional.&#160;This&#160;topic is discussed&#160;further&#160;in&#160;&#160;<br/>ASAM&#160;XCP Part 2 Protocol Layer&#160;Specification.&#160;<br/>
<hr/>
<a name=20></a>22<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.1.3&#160;Data Field&#160;</b><br/>
XCP Packet<br/>
PID&#160;FILL<br/>
DAQ<br/>
TIMESTAMP<br/>
<b>DATA</b><br/>
<b>Figure 11:&#160;</b><br/>
<b>Data Field</b><br/>
<b>Data&#160;field&#160;in&#160;the&#160;<br/>XCP packet</b><br/>
Finally,&#160;the&#160;XCP packet also&#160;contains&#160;the&#160;data stored&#160;in&#160;the&#160;data&#160;field. In&#160;the case of&#160;CTO&#160;<br/>packets,&#160;the data&#160;field consists&#160;of&#160;specific&#160;parameters&#160;for&#160;the different&#160;commands.&#160;DTO&#160;<br/>packets&#160;contain the&#160;measured&#160;values&#160;from&#160;the&#160;Slave and&#160;when&#160;STIM data is sent&#160;the&#160;values&#160;<br/>from the&#160;Master.<br/>
<b>1.2&#160;Exchange&#160;of&#160;CTOs&#160;</b><br/>
CTOs&#160;are&#160;used&#160;to&#160;transmit both&#160;commands&#160;from&#160;the&#160;Master&#160;to&#160;the Slave and responses&#160;<br/>from the&#160;Slave to the&#160;Master.<br/>
<b>1.2.1&#160;XCP&#160;Command&#160;Structure</b><br/>
The&#160;Slave&#160;receives&#160;a command&#160;from the&#160;Master and&#160;must react to it with a positive&#160;or neg­<br/>ative response.&#160;The&#160;communication structure is always the&#160;same here:<br/>
Command (CMD):<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Command Packet Code CMD<br/>
1..MAX_CTO­1&#160;<br/>
BYTE&#160;<br/>
Command specific&#160;Parameters<br/>
A&#160;unique number&#160;is assigned&#160;to each&#160;command.&#160;In addition, other&#160;specific parameters may&#160;<br/>be sent&#160;with&#160;the&#160;command.&#160;The&#160;maximum number&#160;of&#160;parameters is defined as MAX_CTO­1&#160;<br/>here. MAX_CTO indicates&#160;the&#160;maximum length of&#160;the&#160;CTO packets&#160;in bytes.&#160;<br/>
Positive response:<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Command Positive Response&#160;Packet Code = RES 0xFF<br/>
1..MAX_CTO­1&#160;<br/>
BYTE&#160;<br/>
Command specific&#160;Parameters&#160;<br/>
<hr/>
<a name=21></a>1.2 Exchange of&#160;CTOs&#160;<br/>
23<br/>
Negative response:<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Error&#160;Packet Code = 0xFE<br/>
1&#160;<br/>
BYTE&#160;<br/>
Error&#160;code<br/>
2..MAX_CTO­1&#160;&#160;BYTE&#160;<br/>
Command specific&#160;Parameters<br/>
Specific&#160;parameters can be&#160;transmitted as supplemental information&#160;with negative&#160;<br/>responses&#160;as&#160;well and not just&#160;with positive responses.&#160;One&#160;example is&#160;when&#160;the connection&#160;<br/>is made between&#160;Master&#160;and Slave.&#160;At&#160;the&#160;start of&#160;a communication between Master&#160;and&#160;<br/>Slave,&#160;the&#160;Master&#160;sends&#160;a connect request&#160;to&#160;the&#160;Slave,&#160;which in&#160;turn must respond posi­<br/>tively&#160;to produce a continuous point­to­point connection.<br/>
Master&#160;à&#160;Slave:&#160;&#160;Connect&#160;<br/>Slave&#160;à&#160;Master:&#160;&#160;Positive Response&#160;<br/>
Connect&#160;command:<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Command Code = 0xFF<br/>
1&#160;<br/>
BYTE&#160;Mode&#160;<br/>
&#160;<br/>
&#160;<br/>
00 = Normal<br/>
&#160;<br/>
&#160;<br/>
01 = user&#160;defined<br/>
Mode&#160;00 means&#160;that&#160;the&#160;Master&#160;wishes&#160;XCP communication&#160;with&#160;the Slave. If&#160;the Master&#160;<br/>uses&#160;0xFF&#160;0x01&#160;when&#160;making&#160;the&#160;connection,&#160;the&#160;Master&#160;is&#160;requesting&#160;XCP communication&#160;<br/>with&#160;the&#160;Slave. Simultaneously, it informs&#160;the&#160;Slave&#160;that it should switch&#160;to a specific – user­<br/>defined&#160;– mode.&#160;<br/>
Positive response of the&#160;Slave:<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Packet ID: 0xFF<br/>
1&#160;<br/>
BYTE&#160;RESOURCE<br/>
2&#160;<br/>
BYTE&#160;COMM_MODE_BASIC<br/>
3&#160;<br/>
BYTE&#160;<br/>
MAX_CTO, Maximum CTO size [BYTE]<br/>
4&#160;<br/>
WORD&#160;<br/>
MAX_DTO, Maximum DTO size [BYTE]<br/>
6&#160;BYTE&#160;<br/>
XCP Protocol Layer&#160;Version Number&#160;(most significant byte only)<br/>
7&#160;BYTE&#160;<br/>
XCP&#160;Transport Layer&#160;Version Number&#160;(most significant byte only)<br/>
The positive response&#160;of&#160;the Slave can assume a&#160;somewhat&#160;more&#160;extensive&#160;form.&#160;The&#160;Slave&#160;<br/>already&#160;sends&#160;communication­specific&#160;information&#160;to&#160;the Master&#160;when&#160;making&#160;the connec­<br/>tion.&#160;RESOURCE,&#160;for&#160;example,&#160;is information&#160;that&#160;the Slave gives&#160;on&#160;whether&#160;it&#160;supports&#160;<br/>such&#160;features&#160;as&#160;page&#160;switching&#160;or&#160;whether&#160;flashing&#160;over&#160;XCP is possible.&#160;With MAX_DTO,&#160;<br/>the&#160;Slave&#160;informs&#160;the&#160;Master&#160;of&#160;the&#160;maximum packet length&#160;it supports&#160;for&#160;transfer&#160;of&#160;the&#160;<br/>measured&#160;values, etc.&#160;You&#160;will&#160;find details&#160;on&#160;the&#160;parameters in&#160;ASAM&#160;XCP Part 2&#160;Protocol&#160;<br/>Layer&#160;Specification.<br/>
<hr/>
<a name=22></a>24<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
XCP permits&#160;three&#160;different modes&#160;for&#160;exchanging&#160;commands and reactions between&#160;<br/>&#160;Master&#160;and Slave:&#160;Standard, Block&#160;and Interleaved mode.<br/>
<b>Standard Mode</b><br/>
<b>Block&#160;Mode</b><br/>
<b>Interleaved Mode</b><br/>
Master<br/>
Slave<br/>
Master<br/>
Slave<br/>
Master<br/>
Slave<br/>
Request&#160;k<br/>
Request&#160;k<br/>
Request&#160;k<br/>
Part1<br/>
Part2<br/>
MIN_ST<br/>
Request&#160;k+1<br/>
Part3<br/>
MAX_BS<br/>
Response&#160;k<br/>
Response&#160;k<br/>
Request&#160;k+1<br/>
Response&#160;k<br/>
Request&#160;k+1<br/>
Response&#160;k+1<br/>
Response&#160;k+1<br/>
Part1<br/>
Response&#160;k+1<br/>
Part2<br/>
Part3<br/>
Time<br/>
Time<br/>
Time<br/>
<b>Figure 12:&#160;The&#160;three modes of&#160;the&#160;XCP protocol: Standard, Block&#160;and &#160;Interleaved mode</b><br/>
In&#160;the&#160;standard communication&#160;model, each request&#160;to a Slave&#160;is&#160;followed by&#160;a single&#160;<br/>response. Except&#160;with&#160;XCP on&#160;CAN, it is not permitted&#160;for&#160;multiple Slaves&#160;to react&#160;to a com­<br/>mand&#160;from&#160;the&#160;Master.&#160;Therefore, each&#160;XCP message&#160;can always be&#160;traced back&#160;to a unique&#160;<br/>Slave.&#160;This&#160;mode is&#160;the&#160;standard case&#160;in communication.<br/>
The&#160;block&#160;transfer&#160;mode is optional and saves&#160;time in large&#160;data&#160;transfers (e.g. upload or&#160;<br/>download operations). Nonetheless,&#160;performance&#160;issues&#160;must be considered in&#160;this mode in&#160;<br/>the&#160;direction&#160;of&#160;the&#160;Slave.&#160;Therefore, minimum&#160;times&#160;between&#160;two commands (MIN_ST)&#160;<br/>must be maintained&#160;and&#160;the&#160;total number&#160;of&#160;commands&#160;must be limited&#160;to an upper&#160;limit&#160;<br/>MAX_BS. Optionally,&#160;the&#160;Master&#160;can&#160;read&#160;out&#160;these&#160;communication settings&#160;from&#160;the Slave&#160;<br/>with&#160;GET_COMM_MODE_INFO.&#160;The&#160;aforementioned&#160;limitations do not need&#160;to be observed&#160;<br/>in block&#160;transfer&#160;mode in&#160;the&#160;direction of&#160;the&#160;Master, because&#160;performance of&#160;the PC nearly&#160;<br/>always suffices&#160;to accept&#160;the&#160;data&#160;from a microcontroller.<br/>
The&#160;interleaved&#160;mode&#160;is&#160;also&#160;provided&#160;for&#160;performance&#160;reasons. But&#160;this method is also&#160;<br/>optional and – in contrast&#160;to block&#160;transfer&#160;mode – it has&#160;no&#160;relevance in practice.<br/>
&#160;<br/>
<hr/>
<a name=23></a>1.2 Exchange of&#160;CTOs&#160;<br/>
25<br/>
<b>1.2.2 CMD&#160;</b><br/>
<b>XCP CTO Packet</b><br/>
PID<br/>
DATA<br/>
Data Field<br/>
Identification Field<br/>
Timestamp Field<br/>
empty for CTO<br/>
<b>Figure 13: Overview&#160;of&#160;the CTO packet structure</b><br/>
The&#160;Master&#160;sends a&#160;general request&#160;to&#160;the Slave over&#160;CMD. The&#160;PID&#160;(Packet&#160;Identifier) field&#160;<br/>contains&#160;the identification number&#160;of&#160;the command.&#160;The additional&#160;specific&#160;parameters&#160;are&#160;<br/>transported&#160;in the&#160;data field.&#160;Then&#160;the&#160;Master&#160;waits for&#160;a&#160;reaction&#160;of&#160;the&#160;Slave&#160;in the form&#160;<br/>of&#160;a RESponse&#160;or&#160;an ERRor.<br/>
XCP is&#160;also&#160;very&#160;scalable&#160;in&#160;its implementation, so&#160;it is&#160;not necessary&#160;to implement every&#160;<br/>command.&#160;In&#160;the&#160;A2L&#160;file,&#160;the&#160;available&#160;CMDs&#160;are&#160;listed&#160;in&#160;what is known as&#160;the&#160;XCP&#160;&#160;<br/>IF_DATA.&#160;If&#160;there&#160;is&#160;a discrepancy&#160;between&#160;the&#160;definition&#160;in&#160;the&#160;A2L&#160;file and&#160;the implemen­<br/>tation&#160;in&#160;the&#160;Slave,&#160;the&#160;Master&#160;can&#160;determine, based&#160;on&#160;the&#160;Slave’s reaction,&#160;that&#160;the&#160;Slave&#160;<br/>does&#160;not even&#160;support&#160;the&#160;command. If&#160;the&#160;Master&#160;sends&#160;a command&#160;that is not imple­<br/>mented&#160;in&#160;the&#160;Slave,&#160;the&#160;Slave&#160;must acknowledge&#160;with&#160;ERR_CMD_UNKNOWN and no&#160;fur­<br/>ther&#160;activities are initiated in&#160;the Slave.&#160;This&#160;lets&#160;the Master&#160;know&#160;quickly&#160;that&#160;an&#160;optional&#160;<br/>command has&#160;not been&#160;implemented in&#160;the&#160;Slave.&#160;<br/>Some other&#160;parameters are included in&#160;the&#160;commands&#160;as&#160;well. Please&#160;take&#160;the precise&#160;<br/>details&#160;from&#160;the&#160;protocol layer&#160;specification in document&#160;ASAM&#160;XCP Part 2.&#160;<br/>&#160;<br/>The&#160;commands&#160;are&#160;organized&#160;in&#160;groups: Standard, Calibration, Page, Programming and&#160;<br/>DAQ measurement commands.&#160;If&#160;a group is&#160;not needed&#160;at all, its commands do not need&#160;to&#160;<br/>be&#160;implemented. If&#160;the&#160;group is&#160;necessary, certain&#160;commands&#160;must always be available in&#160;<br/>the&#160;Slave,&#160;while&#160;others&#160;from&#160;the&#160;group are optional.<br/>
The&#160;following&#160;overview&#160;serves&#160;as&#160;an example.&#160;The&#160;SET_CAL_PAGE&#160;and GET_CAL_PAGE&#160;<br/>commands&#160;in&#160;the&#160;page&#160;switching&#160;group are&#160;identified&#160;as&#160;not optional.&#160;This means&#160;that in an&#160;<br/>XCP Slave&#160;that supports&#160;page&#160;switching&#160;at least&#160;these&#160;two commands must be&#160;imple­<br/>mented.&#160;If&#160;page&#160;switching&#160;support is unnecessary&#160;in&#160;the&#160;Slave,&#160;these commands do not need&#160;<br/>to be implemented.&#160;The&#160;same applies&#160;to other&#160;commands.<br/>
<hr/>
<a name=24></a>26<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Standard commands:<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
CONNECT&#160;<br/>
0xFF&#160;No<br/>
DISCONNECT&#160;<br/>
0xFE&#160;No<br/>
GET_STATUS&#160;<br/>
0xFD&#160;No<br/>
SYNCH&#160;<br/>
0xFC&#160;No<br/>
GET_COMM_MODE_INFO&#160;&#160;0xFB&#160;Yes<br/>GET_ID&#160;<br/>
0xFA&#160;Yes<br/>
SET_REQUEST&#160;<br/>
0xF9&#160;Yes<br/>
GET_SEED&#160;<br/>
0xF8&#160;Yes<br/>
UNLOCK&#160;<br/>
0xF7&#160;Yes<br/>
SET_MTA&#160;<br/>
0xF6&#160;Yes<br/>
UPLOAD&#160;<br/>
0xF5&#160;Yes<br/>
SHORT_UPLOAD&#160;<br/>
0xF4&#160;Yes<br/>
BUILD_CHECKSUM&#160;<br/>
0xF3&#160;Yes<br/>
TRANSPORT_LAYER_CMD&#160;&#160;0xF2&#160;Yes<br/>USER_CMD&#160;<br/>
0xF1&#160;Yes<br/>
Calibration commands:<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
DOWNLOAD&#160;<br/>
0xF0&#160;No<br/>
DOWNLOAD_NEXT&#160;<br/>
0xEF&#160;Yes<br/>
DOWNLOAD_MAX&#160;<br/>
0xEE&#160;Yes<br/>
SHORT_DOWNLOAD&#160;<br/>
0xED&#160;Yes<br/>
MODIFY_BITS&#160;<br/>
0xEC&#160;Yes<br/>
Standard commands:<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
SET_CAL_PAGE&#160;<br/>
0xEB&#160;No<br/>
GET_CAL_PAGE&#160;<br/>
0xEA&#160;No<br/>
GET_PAG_PROCESSOR_INFO&#160;0xE9&#160;&#160;Yes<br/>GET_SEGMENT_INFO&#160;<br/>
0xE8&#160;Yes<br/>
GET_PAGE_INFO&#160;<br/>
0xE7&#160;Yes<br/>
SET_SEGMENT_MODE&#160;<br/>
0xE6&#160;Yes<br/>
GET_SEGMENT_MODE&#160;<br/>
0xE5&#160;Yes<br/>
COPY_CAL_PAGE&#160;<br/>
0xE4&#160;Yes<br/>
<hr/>
<a name=25></a>1.2 Exchange of&#160;CTOs&#160;<br/>
27<br/>
Periodic data exchange&#160;– basics:<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
SET_DAQ_PTR&#160;<br/>
0xE2&#160;No<br/>
WRITE_DAQ&#160;<br/>
0xE1&#160;No<br/>
SET_DAQ_LIST_MODE&#160;<br/>
0xE0&#160;No<br/>
START_STOP_DAQ_LIST&#160;<br/>
0xDE&#160;No<br/>
START_STOP_SYNCH&#160;<br/>
0xDD&#160;No<br/>
WRITE_DAQ_MULTIPLE&#160;<br/>
0xC7&#160;Yes<br/>
READ_DAQ&#160;<br/>
0xDB&#160;Yes<br/>
GET_DAQ_CLOCK&#160;<br/>
0xDC&#160;Yes<br/>
GET_DAQ_PROCESSOR_INFO&#160;0xDA&#160;&#160;Yes<br/>GET_DAQ_RESOLUTION_INFO&#160;0xD9&#160;<br/>
Yes<br/>
GET_DAQ_LIST_INFO&#160;<br/>
0xD8&#160;Yes<br/>
GET_DAQ_EVENT_INFO&#160;<br/>
0xD7&#160;Yes<br/>
Periodic data exchange&#160;– static configuration:&#160;<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
CLEAR_DAQ_LIST&#160;<br/>
0xE3&#160;No<br/>
GET_DAQ_LIST_INFO&#160;<br/>
0xD8&#160;Yes<br/>
Periodic data exchange&#160;– dynamic configuration:&#160;<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
FREE_DAQ&#160;<br/>
0xD6&#160;Yes<br/>
ALLOC_DAQ&#160;<br/>
0xD5&#160;Yes<br/>
ALLOC_ODT&#160;<br/>
0xD4&#160;Yes<br/>
ALLOC_ODT_ENTRY&#160;<br/>
0xD3&#160;Yes<br/>
<hr/>
<a name=26></a>28<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Flash&#160;programming:<br/>
<b>Command&#160;</b><br/>
<b>PID&#160;Optional</b><br/>
PROGRAM_START&#160;<br/>
0xD2&#160;No<br/>
PROGRAM_CLEAR&#160;<br/>
0xD1&#160;No<br/>
PROGRAM&#160;<br/>
0xD0&#160;No<br/>
PROGRAM_RESET&#160;<br/>
0xCF&#160;No<br/>
GET_PGM_PROCESSOR_INFO&#160;0xCE&#160;<br/>
Yes<br/>
GET_SECTOR_INFO&#160;<br/>
0xCD&#160;Yes<br/>
PROGRAM_PREPARE&#160;<br/>
0xCC&#160;Yes<br/>
PROGRAM_FORMAT&#160;<br/>
0xCB&#160;Yes<br/>
PROGRAM_NEXT&#160;<br/>
0xCA&#160;Yes<br/>
PROGRAM_MAX&#160;<br/>
0xC9&#160;Yes<br/>
PROGRAM_VERIFY&#160;<br/>
0xC8&#160;Yes<br/>
<b>1.2.3 RES&#160;</b><br/>
If&#160;the Slave is able&#160;to&#160;successfully&#160;comply&#160;with a&#160;Master’s request,&#160;it&#160;gives&#160;a&#160;positive acknowl­<br/>edge&#160;with&#160;RES.&#160;<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Packet Identifier&#160;= RES 0xFF<br/>
1..MAX_CTO­1&#160;<br/>
BYTE&#160;<br/>
Command response&#160;data<br/>
You&#160;will&#160;find more detailed information&#160;on&#160;the parameters in&#160;ASAM&#160;XCP&#160;Part&#160;2&#160;Protocol&#160;<br/>Layer&#160;Specification.<br/>
<b>1.2.4 ERR&#160;</b><br/>
If&#160;the&#160;request&#160;from&#160;the&#160;Master&#160;is&#160;unusable, it responds&#160;with&#160;the error&#160;message ERR&#160;and an&#160;<br/>error&#160;code.&#160;<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Packet Identifier&#160;= ERR 0xFE<br/>
1&#160;<br/>
BYTE&#160;<br/>
Error&#160;code<br/>
2..MAX_CTO­1&#160;&#160;BYTE&#160;<br/>
Optional error&#160;information data<br/>
You&#160;will&#160;find&#160;a list of&#160;possible&#160;error&#160;codes&#160;in&#160;ASAM&#160;XCP Part 2 Protocol Layer&#160;Specification.<br/>
<hr/>
<a name=27></a>1.2 Exchange of&#160;CTOs&#160;<br/>
29<br/>
<b>1.2.5 EV&#160;</b><br/>
If&#160;the Slave&#160;wishes&#160;to inform&#160;the Master&#160;of&#160;an asynchronous event, an EV&#160;can be sent&#160;to do&#160;<br/>this.&#160;Its implementation is optional.<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Packet Identifier&#160;= EV&#160;0xFD<br/>
1&#160;<br/>
BYTE&#160;<br/>
Event code<br/>
2..MAX_CTO­1&#160;&#160;BYTE&#160;<br/>
Optional event information data<br/>
You&#160;will&#160;find more detailed information&#160;on&#160;the parameters in&#160;ASAM&#160;XCP&#160;Part&#160;2&#160;Protocol&#160;<br/>Layer&#160;Specification.<br/>
Events&#160;will be&#160;discussed&#160;much&#160;more&#160;in&#160;relation&#160;to measurements and stimulation. This&#160;has&#160;<br/>nothing&#160;to&#160;do&#160;with&#160;the action of&#160;the&#160;XCP&#160;Slave&#160;that initiates&#160;sending&#160;of&#160;an&#160;EVENT.&#160;Rather&#160;it&#160;<br/>involves&#160;the&#160;Slave reporting&#160;a disturbance such&#160;as&#160;the&#160;failure of&#160;a specific&#160;functionality.<br/>
<b>1.2.6 SERV&#160;</b><br/>
The&#160;Slave can use&#160;this&#160;mechanism&#160;to request&#160;that&#160;the&#160;Master&#160;execute a service.&#160;<br/>
<b>Position&#160;</b><br/>
<b>Type&#160;Description</b><br/>
0&#160;<br/>
BYTE&#160;<br/>
Packet Identifier&#160;= SERV&#160;0xFC<br/>
1&#160;<br/>
BYTE&#160;<br/>
Service request&#160;code<br/>
2..MAX_CTO­1&#160;&#160;BYTE&#160;<br/>
Optional service request&#160;data<br/>
You&#160;will&#160;find&#160;the&#160;Service Request&#160;Code&#160;table in&#160;ASAM&#160;XCP Part 2 Protocol Layer&#160;<br/>Specification.&#160;<br/>
<b>1.2.7 Calibrating&#160;Parameters in&#160;the&#160;Slave</b><br/>
To change&#160;a parameter&#160;in an&#160;XCP Slave,&#160;the&#160;XCP Master&#160;must send&#160;the parameter’s loca­<br/>tion&#160;as well&#160;as the&#160;value&#160;itself&#160;to the&#160;Slave.<br/>XCP always&#160;defines&#160;addresses&#160;with&#160;five&#160;bytes:&#160;four&#160;for&#160;the&#160;actual address and one&#160;byte&#160;for&#160;<br/>the address&#160;extension.&#160;Based on&#160;a&#160;CAN&#160;transmission,&#160;only&#160;seven&#160;useful bytes are&#160;available&#160;<br/>for&#160;XCP messages.&#160;For&#160;example, if&#160;the&#160;calibrator&#160;sets a 4­byte&#160;value and&#160;wants&#160;to send both&#160;<br/>pieces&#160;of&#160;information&#160;in&#160;one&#160;CAN message,&#160;there&#160;is&#160;insufficient space&#160;to do&#160;this. Since a&#160;<br/>total of&#160;nine&#160;bytes&#160;are&#160;needed&#160;to&#160;transmit&#160;the&#160;address&#160;and&#160;the&#160;new&#160;value,&#160;the change can­<br/>not be&#160;transmitted in one&#160;CAN message&#160;(seven&#160;useful bytes).&#160;The calibration request is&#160;<br/>therefore&#160;made&#160;with&#160;two messages&#160;from Master&#160;to Slave.&#160;The&#160;Slave must acknowledge&#160;<br/>both messages&#160;and in sum&#160;four&#160;messages&#160;are exchanged.<br/>
<hr/>
<a name=28></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-28_1.png"/><br/>
30<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
The&#160;following&#160;figure&#160;shows&#160;the&#160;communication between&#160;Master&#160;and Slave,&#160;which is neces­<br/>sary&#160;to&#160;set&#160;a&#160;parameter&#160;value.&#160;The actual&#160;message&#160;is located in&#160;the&#160;line&#160;with&#160;the envelope&#160;<br/>symbol.&#160;The&#160;interpretation of&#160;the&#160;message&#160;is shown by&#160;“expanding” it&#160;with&#160;the mouse.&#160;<br/>
&#160;<br/>
<b>Figure 14:&#160;Trace example&#160;from a calibration process in CANape</b><br/>
In&#160;the&#160;first message&#160;of&#160;the&#160;Master&#160;(highlighted&#160;in&#160;blue&#160;in&#160;Figure&#160;14),&#160;the Master&#160;sends&#160;the&#160;&#160;<br/>command&#160;SET_MTA&#160;to the&#160;Slave&#160;with&#160;the&#160;address&#160;to&#160;which&#160;a new&#160;value should be&#160;written.&#160;<br/>In&#160;the second message,&#160;the&#160;Slave gives&#160;a positive acknowledge&#160;to&#160;the command&#160;with&#160;<br/>Ok:SET_MTA.<br/>
The&#160;third message&#160;DOWNLOAD&#160;transmits&#160;the&#160;hex&#160;value&#160;as&#160;well as&#160;the&#160;valid number&#160;of&#160;<br/>bytes.&#160;In&#160;this&#160;example,&#160;the&#160;valid number&#160;of&#160;bytes&#160;is&#160;four, because it is a&#160;float&#160;value.&#160;The Slave&#160;<br/>gives&#160;another&#160;positive acknowledge&#160;in&#160;the&#160;fourth message.<br/>
This&#160;completes&#160;the&#160;current calibration process. In&#160;the&#160;Trace display,&#160;you can recognize a&#160;ter­<br/>minating&#160;SHORT_UPLOAD&#160;– a special&#160;aspect of&#160;CANape,&#160;the&#160;measurement and calibration&#160;<br/>tool&#160;from&#160;Vector.&#160;To make sure&#160;that&#160;the&#160;calibration&#160;was performed successfully,&#160;the&#160;value is&#160;<br/>read&#160;out again&#160;after&#160;the&#160;process and&#160;the&#160;display&#160;is&#160;updated&#160;with&#160;the&#160;read­out&#160;value.&#160;This lets&#160;<br/>the&#160;user&#160;directly&#160;recognize&#160;whether&#160;the calibration command&#160;was implemented.&#160;This com­<br/>mand also&#160;gets a positive acknowledge&#160;with Ok:SHORT_UPLOAD.&#160;<br/>
When&#160;the&#160;parameter&#160;changes&#160;in&#160;the ECU’s RAM,&#160;the&#160;application processes&#160;the new&#160;value.&#160;A&#160;<br/>reboot of&#160;the&#160;ECU, however,&#160;would lead&#160;to erasure&#160;of&#160;the&#160;value and overwriting of&#160;the&#160;value&#160;<br/>in RAM&#160;with&#160;the original&#160;value&#160;from&#160;the&#160;flash&#160;(see&#160;chapter&#160;3 “Calibration Concepts”). So,&#160;<br/>how&#160;can&#160;the&#160;modified&#160;parameter&#160;set be permanently&#160;saved?<br/>
<hr/>
<a name=29></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-29_1.png"/><br/>
1.2 Exchange of&#160;CTOs&#160;<br/>
31<br/>
Essentially, there&#160;are two&#160;possibilities:&#160;<br/>
<b>A) Save&#160;the parameters in&#160;the ECU<br/></b>The&#160;changed&#160;data in&#160;RAM could&#160;for&#160;example&#160;be&#160;saved&#160;in&#160;the&#160;ECU’s EEPROM: either&#160;auto­<br/>matically&#160;when&#160;ramping&#160;down&#160;the&#160;ECU, or&#160;manually&#160;by&#160;the&#160;user.&#160;A&#160;prerequisite is&#160;that&#160;the&#160;<br/>data can be stored in a nonvolatile memory&#160;of&#160;the&#160;Slave. In an ECU,&#160;this&#160;would be&#160;the&#160;<br/>EEPROM&#160;or&#160;flash.&#160;ECUs&#160;with&#160;thousands of&#160;parameters, however, are seldom able&#160;to provide&#160;<br/>so&#160;much unused&#160;EEPROM memory&#160;space, so&#160;this&#160;method is rare.<br/>
Another&#160;possibility&#160;is to write the&#160;RAM&#160;parameters back&#160;into&#160;the ECU’s&#160;flash memory.&#160;This&#160;<br/>method is&#160;relatively&#160;complex.&#160;A&#160;flash memory&#160;must&#160;first be&#160;erased before it can be rewrit­<br/>ten.&#160;This, in&#160;turn, can&#160;only&#160;be&#160;done&#160;as&#160;a block. Consequently, it is not simply&#160;a matter&#160;of&#160;writ­<br/>ing&#160;back&#160;individual&#160;bytes.&#160;You&#160;will&#160;find&#160;more&#160;on&#160;this&#160;topic in chapter&#160;3 “Calibration&#160;<br/>Concepts”.&#160;<br/>
<b>B) Save&#160;the parameters in&#160;the&#160;form of&#160;a&#160;file&#160;on&#160;the PC<br/></b>It&#160;is much more common&#160;to store&#160;the parameters on&#160;the&#160;PC.&#160;All parameters&#160;– or&#160;subsets of&#160;<br/>them&#160;– are stored in&#160;the&#160;form of&#160;a&#160;file. Different&#160;formats are available&#160;for&#160;this;&#160;the simplest&#160;<br/>case is&#160;that of&#160;an&#160;ASCII&#160;text&#160;file,&#160;which&#160;only&#160;contains&#160;the name&#160;of&#160;the object&#160;and its&#160;value.&#160;<br/>Other&#160;formats&#160;also&#160;permit saving&#160;other&#160;information, such&#160;as&#160;findings&#160;about&#160;the maturity&#160;<br/>level of&#160;the&#160;parameter&#160;of&#160;the&#160;history&#160;of&#160;revisions.&#160;<br/>
Scenario:&#160;After&#160;finishing&#160;his&#160;or&#160;her&#160;work,&#160;the&#160;calibrator&#160;wishes&#160;to enjoy&#160;a&#160;free&#160;evening. So,&#160;the&#160;<br/>calibrator&#160;saves&#160;the&#160;executed&#160;changes&#160;in&#160;the&#160;ECU’s&#160;RAM&#160;in&#160;the&#160;form of&#160;a parameter&#160;set&#160;file&#160;<br/>on a PC.&#160;The&#160;next day,&#160;the&#160;calibrator&#160;wants&#160;to continue&#160;working&#160;where he or&#160;she left off.&#160;The&#160;<br/>calibrator&#160;starts&#160;the&#160;ECU. Upon booting,&#160;the&#160;parameters are initialized in RAM. However,&#160;<br/>the&#160;ECU does&#160;this&#160;using&#160;values&#160;stored&#160;in&#160;flash.&#160;This&#160;means&#160;that&#160;the changes of&#160;the&#160;previous&#160;<br/>day&#160;are no&#160;longer&#160;available in&#160;the ECU.&#160;To now&#160;continue&#160;where&#160;work&#160;was left off&#160;on&#160;the pre­<br/>vious day,&#160;the&#160;calibrator&#160;transfers&#160;the contents of&#160;the&#160;parameter&#160;set&#160;file&#160;to&#160;the ECU’s RAM&#160;<br/>by&#160;XCP using&#160;the&#160;DOWNLOAD&#160;command.<br/>
<b>Figure 15:&#160;Transfer&#160;of&#160;a parameter&#160;set&#160;file&#160;to an ECU’s RAM</b><br/>
<hr/>
<a name=30></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-30_1.png"/><br/>
32<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>Saving parameter&#160;set&#160;file&#160;in hex&#160;files and&#160;flashing</b><br/>
Flashing&#160;an&#160;ECU is&#160;another&#160;way&#160;to change&#160;the&#160;parameters&#160;in&#160;flash.&#160;They&#160;are&#160;then&#160;written&#160;to&#160;<br/>RAM as new&#160;parameters&#160;when&#160;the ECU is booted.&#160;A&#160;parameter&#160;set&#160;file can also be&#160;trans­<br/>ferred&#160;to&#160;a&#160;C&#160;or&#160;H&#160;file and be made into&#160;the new&#160;flash&#160;file&#160;with another&#160;compiler/linker&#160;run.&#160;<br/>However, depending&#160;on&#160;the&#160;parameters&#160;of&#160;the&#160;code,&#160;the&#160;process of&#160;generating a&#160;flashable&#160;<br/>hex&#160;file&#160;could&#160;take&#160;a considerable&#160;amount of&#160;time. In&#160;addition,&#160;the calibrator&#160;might not have&#160;<br/>any&#160;ECU source code&#160;– depending&#160;on&#160;the&#160;work&#160;process.&#160;That&#160;would prevent&#160;this method&#160;<br/>from being&#160;available&#160;to&#160;the&#160;calibrator.&#160;<br/>
As an alternative,&#160;the&#160;calibrator&#160;can copy&#160;the&#160;parameter&#160;set&#160;file&#160;into&#160;the existing&#160;flash&#160;file.<br/>
<b>Figure 16: Hex&#160;window</b><br/>
In&#160;the&#160;flash&#160;file,&#160;there is a hex&#160;file&#160;that contains&#160;both&#160;the&#160;addresses and&#160;the&#160;values. Now&#160;a&#160;<br/>parameter&#160;file&#160;can&#160;be&#160;copied&#160;to a hex&#160;file.&#160;To do&#160;this,&#160;CANape&#160;takes&#160;the&#160;address and&#160;the&#160;<br/>value&#160;from&#160;the&#160;parameter&#160;set&#160;file&#160;and&#160;updates&#160;the&#160;parameter&#160;value at&#160;the relevant location&#160;<br/>in&#160;the&#160;hex&#160;file.&#160;This&#160;results&#160;in&#160;a new&#160;hex&#160;file,&#160;which&#160;contains&#160;the&#160;changed&#160;parameter&#160;values.&#160;<br/>However,&#160;this&#160;Hex&#160;file&#160;must now&#160;possibly&#160;run&#160;through&#160;further&#160;process steps&#160;to obtain a&#160;flash­<br/>able&#160;file. One&#160;recurring&#160;problem here&#160;is&#160;the&#160;checksums,&#160;which&#160;the ECU checks&#160;to determine&#160;<br/>whether&#160;it received&#160;the&#160;data correctly. If&#160;the&#160;flashable&#160;file&#160;exists, it can be&#160;flashed in&#160;the ECU&#160;<br/>and after&#160;the&#160;reboot&#160;the&#160;new&#160;parameter&#160;values&#160;are available in&#160;the ECU.&#160;<br/>
<b>1.3&#160;Exchanging&#160;DTOs&#160;– Synchronous Data Exchange&#160;</b><br/>
As depicted in Figure 8, DTOs (Data&#160;Transfer&#160;Objects) are available&#160;for&#160;exchanging synchro­<br/>nous&#160;measurement and&#160;calibration&#160;data. Data&#160;from&#160;the&#160;Slave&#160;are sent&#160;to&#160;the Master&#160;by&#160;<br/>DAQ&#160;– synchronous&#160;to internal events.&#160;This&#160;communication is subdivided&#160;into&#160;two phases:&#160;<br/>In an initialization phase,&#160;the&#160;Master&#160;communicates&#160;to&#160;the&#160;Slave&#160;which data&#160;the Slave&#160;<br/>should send&#160;for&#160;different events.&#160;After&#160;this&#160;phase,&#160;the&#160;Master&#160;initiates&#160;the&#160;measurement in&#160;<br/>the Slave and&#160;the actual&#160;measurement phase&#160;begins.&#160;From&#160;this&#160;point&#160;in&#160;time,&#160;the&#160;Slave&#160;<br/>sends&#160;the&#160;desired&#160;data&#160;to&#160;the&#160;Master,&#160;which&#160;only&#160;listens&#160;until it sends a “measurement stop”&#160;<br/>to&#160;the Slave.&#160;Triggering&#160;of&#160;measurement data acquisition and&#160;transmission is controlled by&#160;<br/>events in&#160;the&#160;ECU.<br/>
<hr/>
<a name=31></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-31_1.png"/><br/>
1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
33<br/>
The&#160;Master&#160;sends data&#160;to&#160;the&#160;Slave by&#160;STIM.&#160;This&#160;communication also consists of&#160;two&#160;<br/>phases:<br/>In&#160;the initialization phase,&#160;the Master&#160;communicates&#160;to&#160;the Slave&#160;which&#160;data&#160;it&#160;will&#160;send&#160;to&#160;<br/>the&#160;Slave.&#160;After&#160;this&#160;phase,&#160;the&#160;Master&#160;sends&#160;the&#160;data&#160;to&#160;the&#160;Slave and&#160;the STIM processor&#160;<br/>saves&#160;the&#160;data.&#160;As soon as a related STIM event is&#160;triggered in&#160;the Slave,&#160;the data is&#160;trans­<br/>ferred to the&#160;application&#160;memory.&#160;<br/>
<b>1.3.1&#160;Measurement&#160;Methods:&#160;Polling&#160;versus&#160;DAQ&#160;</b><br/>
Before explaining&#160;how&#160;event­synchronous, correlated data is measured&#160;from a Slave, here is&#160;<br/>a brief&#160;description&#160;of&#160;another&#160;measurement method known&#160;as Polling. It is not based on&#160;<br/>DTOs, but on CTOs instead.&#160;Actually,&#160;this&#160;topic should be explained in a separate chapter,&#160;<br/>but a description&#160;of&#160;polling&#160;lets us&#160;derive, in&#160;a&#160;very&#160;elegant&#160;way,&#160;the&#160;necessity&#160;of&#160;DTO­based&#160;<br/>measurement, so a minor&#160;side&#160;discussion at&#160;this&#160;point makes&#160;sense.&#160;<br/>
The&#160;Master&#160;can use&#160;the&#160;SHORT_UPLOAD&#160;command&#160;to request&#160;the&#160;value of&#160;a measurement&#160;<br/>para&#160;meter&#160;from&#160;the Slave.&#160;This&#160;is referred&#160;to as polling.&#160;This&#160;is&#160;the simplest case of&#160;a&#160;<br/>measure&#160;ment: sending&#160;the&#160;measured&#160;value of&#160;a measurement parameter&#160;at&#160;the&#160;time at&#160;<br/>which&#160;the&#160;SHORT_UPLOAD command has&#160;been&#160;received and executed.&#160;<br/>
In&#160;the&#160;following&#160;example,&#160;the&#160;measurement parameter&#160;“Triangle” is measured&#160;from&#160;the&#160;<br/>Slave:&#160;<br/>
<b>Figure 17:&#160;<br/>Address information&#160;<br/>of&#160;the&#160;parameter&#160;<br/>&#160;“Triangle”&#160;from&#160;the&#160;&#160;<br/>A2L&#160;file</b><br/>
The&#160;address&#160;0x60483&#160;is&#160;expressed&#160;as an&#160;address&#160;with&#160;five&#160;bytes in&#160;the CAN&#160;frame: one byte&#160;<br/>for&#160;the&#160;address&#160;extension&#160;and&#160;four&#160;bytes&#160;for&#160;the&#160;actual address.<br/>
<hr/>
<a name=32></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-32_1.png"/><br/>
34<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>Figure 18: Polling communication in&#160;the CANape&#160;Trace&#160;window</b><br/>
The&#160;XCP specification&#160;sets a requirement&#160;for&#160;polling:&#160;that&#160;the&#160;value of&#160;each measurement&#160;<br/>parameter&#160;must be&#160;polled&#160;individually. For&#160;each&#160;value&#160;to be&#160;measured&#160;via polling,&#160;two mes­<br/>sages&#160;must go&#160;over&#160;the&#160;bus:&#160;the&#160;Master’s request&#160;to&#160;the&#160;Slave and&#160;the Slave’s response&#160;to&#160;<br/>the&#160;Master.<br/>
Besides&#160;this&#160;additional&#160;bus load,&#160;there is&#160;another&#160;disadvantage&#160;of&#160;the polling&#160;method:&#160;When&#160;<br/>polling&#160;multiple&#160;data&#160;values,&#160;the&#160;user&#160;normally&#160;wants&#160;the&#160;data&#160;to correlate&#160;to one another.&#160;<br/>However, multiple&#160;values&#160;that are measured sequentially&#160;with polling do not necessarily&#160;<br/>stand in correlation&#160;to one&#160;another, i.e.&#160;they&#160;might not originate&#160;from&#160;the same ECU com­<br/>puting&#160;cycle.&#160;<br/>This&#160;limits&#160;the&#160;suitability&#160;of&#160;polling&#160;for&#160;measurement, because&#160;it produces unnecessarily&#160;high&#160;<br/>data&#160;traffic and&#160;the&#160;measured&#160;values&#160;are not evaluated in relation&#160;to&#160;the process&#160;flows in&#160;<br/>the&#160;ECU.&#160;<br/>
So, an optimized measurement must solve&#160;two&#160;tasks:<br/>&gt;&#160;&#160;&#160;Bandwidth&#160;&#160;optimization&#160;during&#160;the&#160;measurement<br/>&gt;&#160;&#160;Assurance of&#160;data correlation<br/>
This&#160;task&#160;is handled by&#160;the&#160;already&#160;mentioned&#160;DAQ&#160;method. DAQ stands&#160;for&#160;Data&#160;Acquisi­<br/>tion and it is implemented by&#160;sending&#160;DTOs (Data&#160;Transfer&#160;Objects)&#160;from&#160;the Slave&#160;to&#160;the&#160;<br/>Master.<br/>
<b>1.3.2&#160;DAQ&#160;Measurement&#160;Method&#160;</b><br/>
The&#160;DAQ method solves&#160;the&#160;two problems of&#160;polling&#160;as&#160;follows:<br/>&gt;&#160;&#160;The&#160;correlation&#160;of&#160;measured&#160;values&#160;is achieved&#160;by&#160;coupling&#160;the acquisition of&#160;measured&#160;<br/>
values&#160;to&#160;the&#160;events in&#160;the&#160;ECU.&#160;The&#160;measured&#160;values&#160;are not acquired and&#160;transferred&#160;<br/>until it has been&#160;assured&#160;that all computations&#160;have been&#160;completed.<br/>
&gt;&#160;&#160;To reduce&#160;bus load,&#160;the&#160;measurement process&#160;is&#160;subdivided&#160;into&#160;two phases: In a configu­<br/>
ration&#160;phase,&#160;the&#160;Master&#160;communicates&#160;which&#160;values&#160;it is&#160;interested in&#160;to&#160;the&#160;Slave and&#160;<br/>the&#160;second&#160;phase&#160;just involves&#160;transferring&#160;the&#160;measured&#160;values of&#160;the Slave&#160;to&#160;the&#160;<br/>Master.&#160;<br/>
<hr/>
<a name=33></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-33_1.png"/><br/>
1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
35<br/>
How&#160;can&#160;the&#160;acquisition of&#160;measured&#160;values&#160;now&#160;be coupled&#160;to processes in&#160;the ECU?&#160;&#160;Figure&#160;<br/>19 shows&#160;the&#160;relationship&#160;between&#160;calculation cycles&#160;in&#160;the&#160;ECU and&#160;the changes in para­<br/>meters&#160;X&#160;and&#160;Y.<br/>
Calculation<br/>
Calculation<br/>
Calculation<br/>
cycle n<br/>
cycle n+1<br/>
cycle n+2<br/>
time<br/>
10<br/>
&#160; 8<br/>
&#160; 6<br/>
<b>X&#160;</b>&#160; 4&#160; 2&#160; 0<br/>
10<br/>
&#160; 8<br/>
&#160; 6<br/>
<b>Y&#160;</b>&#160; 4&#160; 2&#160; 0<br/>
E1<br/>
E1<br/>
E1<br/>
Read sensor X<br/>
Calculate Y = X<br/>
<b>Figure 19:&#160;<br/>Events in&#160;the ECU</b><br/>
Let’s&#160;have&#160;a look&#160;at&#160;the&#160;sequence&#160;in&#160;the&#160;ECU:&#160;When&#160;event E1 (= end of&#160;computation cycle) is&#160;<br/>reached,&#160;then&#160;all parameters&#160;have&#160;been&#160;acquired&#160;and&#160;calculations have been made.&#160;This&#160;<br/>means&#160;that all&#160;values&#160;must match one&#160;another&#160;and&#160;correlate&#160;at&#160;this&#160;time point.&#160;This means&#160;<br/>that&#160;we use&#160;an event­synchronous measurement method.&#160;This&#160;is precisely&#160;what is imple­<br/>mented with&#160;the&#160;help&#160;of&#160;the&#160;DAQ&#160;mechanism:&#160;When&#160;the&#160;algorithm in&#160;the Slave&#160;reaches&#160;the&#160;<br/>“Computational&#160;cycle&#160;completed” event,&#160;the&#160;XCP Slave&#160;collects&#160;the&#160;values of&#160;the measure­<br/>ment parameters, saves&#160;them&#160;in&#160;a buffer&#160;and&#160;sends&#160;them&#160;to&#160;the&#160;Master.&#160;This assumes&#160;that&#160;<br/>the&#160;Slave knows&#160;which&#160;parameters should be measured&#160;for&#160;which event.&#160;<br/>
An&#160;event&#160;does&#160;not absolutely&#160;have&#160;to be a cyclic,&#160;time­equidistant event, rather&#160;in&#160;the case&#160;<br/>of&#160;an engine&#160;controller,&#160;for&#160;example, it might be angle­synchronous.&#160;This makes&#160;the&#160;time&#160;<br/>interval between&#160;two events dependent on&#160;the&#160;engine&#160;rpm.&#160;A&#160;singular&#160;event, such as activa­<br/>tion of&#160;a switch by&#160;the&#160;driver, is also&#160;an event&#160;that is not by&#160;any&#160;means equidistant in&#160;time.&#160;<br/>
The&#160;user&#160;selects&#160;the&#160;signals.&#160;Besides&#160;the&#160;actual measurement object,&#160;the user&#160;must select&#160;<br/>the&#160;underlying&#160;event&#160;for&#160;the&#160;measurement parameters.&#160;The&#160;events as&#160;well as&#160;the possible&#160;<br/>assignments of&#160;the&#160;measurement objects&#160;to&#160;the&#160;events must be stored in&#160;the&#160;A2L&#160;file.<br/>
<b>Figure 20:&#160;<br/>Event definition&#160;<br/>in&#160;an&#160;A2L</b><br/>
<hr/>
<a name=34></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-34_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-34_2.png"/><br/>
36<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
In&#160;the normal&#160;case,&#160;it&#160;does not&#160;make any&#160;sense&#160;to&#160;be able&#160;to&#160;simultaneously&#160;assign&#160;a&#160;mea­<br/>sured&#160;value&#160;to&#160;multiple events.&#160;Generally,&#160;a&#160;parameter&#160;is only&#160;modified&#160;within&#160;a&#160;single&#160;cycle&#160;<br/>(e.g.&#160;only&#160;at 10­ms intervals) and&#160;not in&#160;multiple&#160;cycles&#160;(e.g.&#160;at 10­ms and 100­ms&#160;<br/>intervals).&#160;<br/>
<b>Figure 21:&#160;<br/>Allocation of&#160;<br/>“Triangle”&#160;to&#160;possible&#160;</b><br/>
<b>events&#160;in&#160;the&#160;A2L</b><br/>
Figure&#160;21&#160;shows&#160;that&#160;the&#160;“Triangle” parameter&#160;can&#160;in&#160;principle&#160;be measured&#160;with&#160;the 1 ms,&#160;&#160;<br/>10 ms and 100 ms events.&#160;The&#160;default setting&#160;is 10 ms.<br/>
Measurement parameters are allocated&#160;to events in&#160;the&#160;ECU during measurement configu­<br/>ration by&#160;the&#160;user.<br/>
<b>Figure 22:&#160;<br/>Selecting events&#160;<br/>&#160;(measurement&#160;&#160;mode)&#160;<br/>for&#160;each measurement&#160;<br/>parameter</b><br/>
After&#160;configuring&#160;the measured signals,&#160;the user&#160;starts&#160;the&#160;measurement.&#160;The&#160;XCP Master&#160;<br/>lists&#160;the&#160;desired&#160;measurement parameters&#160;in&#160;what are&#160;known&#160;as DAQ&#160;lists. In&#160;these lists,&#160;the&#160;<br/>measured&#160;signals&#160;are&#160;each&#160;allocated&#160;to selected&#160;events.&#160;This&#160;configuration information is&#160;<br/>sent&#160;to&#160;the&#160;Slave before&#160;the&#160;actual start of&#160;measurement.&#160;Then&#160;the Slave knows&#160;which&#160;<br/>addresses&#160;it should read out and&#160;transmit&#160;when&#160;an event occurs.&#160;This distribution of&#160;the&#160;<br/>measurement into a&#160;configuration phase&#160;and a measurement phase&#160;was already&#160;mentioned&#160;<br/>at&#160;the&#160;very&#160;beginning&#160;of&#160;this&#160;chapter.&#160;<br/>
This solves both&#160;problems&#160;that&#160;occur&#160;in polling:&#160;bandwidth is used&#160;optimally,&#160;because&#160;the&#160;<br/>Master&#160;no&#160;longer&#160;needs&#160;to poll each&#160;value&#160;individually&#160;during&#160;the measurement and&#160;the&#160;<br/>&#160;measured&#160;values correlate&#160;with one&#160;another.&#160;<br/>
<hr/>
<a name=35></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-35_1.png"/><br/>
1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
37<br/>
<b>Figure 23: Excerpt&#160;from&#160;the CANape&#160;Trace&#160;window&#160;of&#160;a DAQ measurement</b><br/>
Figure 23&#160;illustrates&#160;an example of&#160;command­response&#160;communication (color&#160;highlighting)&#160;<br/>between&#160;Master&#160;and Slave (overall&#160;it&#160;is significantly&#160;more extensive&#160;and&#160;is&#160;only&#160;shown&#160;in&#160;part&#160;<br/>here&#160;for&#160;reasons&#160;of&#160;space).&#160;This&#160;involves&#160;transmitting&#160;the&#160;DAQ&#160;configuration to the&#160;Slave.&#160;<br/>Afterwards,&#160;the&#160;measurement start is&#160;triggered and&#160;the&#160;Slave sends&#160;the requested&#160;values&#160;<br/>while&#160;the&#160;Master&#160;just listens.&#160;<br/>
Until now,&#160;the&#160;selection of&#160;a signal&#160;was described based&#160;on its name and allocation&#160;to a&#160;<br/>measurement event. But how&#160;exactly&#160;is&#160;the&#160;configuration&#160;transferred&#160;to&#160;the&#160;XCP Slave?<br/>
Let us look&#160;at&#160;the problem&#160;from&#160;the&#160;perspective of&#160;memory&#160;structure in&#160;the ECU:&#160;The user&#160;<br/>has&#160;selected signals&#160;and&#160;wishes&#160;to measure&#160;them. So&#160;that sending a signal&#160;value does not&#160;<br/>require&#160;the&#160;use&#160;of&#160;an entire message,&#160;the&#160;signals&#160;from&#160;the&#160;Slave are combined into message&#160;<br/>packets.&#160;The Slave does not&#160;create&#160;this definition of&#160;the combination&#160;independently,&#160;or&#160;else&#160;<br/>the Master&#160;would not&#160;be able&#160;to interpret&#160;the data&#160;when&#160;it&#160;received&#160;the&#160;messages.&#160;There­<br/>fore,&#160;the&#160;Slave&#160;receives&#160;an&#160;instruction&#160;from&#160;the&#160;Master&#160;describing how&#160;it should distribute&#160;<br/>the&#160;values&#160;to the&#160;messages.&#160;<br/>
The&#160;sequence&#160;in&#160;which&#160;the&#160;Slave should assemble&#160;the&#160;bytes&#160;into messages is defined in&#160;what&#160;<br/>are&#160;known&#160;as&#160;Object Description&#160;Tables&#160;(ODTs).&#160;The&#160;address&#160;and object length are impor­<br/>tant&#160;to uniquely&#160;identify&#160;a measurement object.&#160;An&#160;ODT&#160;provides&#160;the allocations of&#160;RAM&#160;<br/>contents&#160;from&#160;the&#160;Slave&#160;to assemble&#160;a message&#160;on&#160;the&#160;bus.&#160;According&#160;to&#160;the communica­<br/>tion model,&#160;this&#160;message&#160;is&#160;transmitted as a DAQ&#160;DTO&#160;(Data&#160;Transfer&#160;Object).<br/>
<hr/>
<a name=36></a>38<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
RAM Cells<br/>
ODT<br/>
0<br/>
address, length<br/>
1<br/>
address, length<br/>
2<br/>
address, length<br/>
3<br/>
address, length<br/>
...<br/>
PID&#160;0<br/>
1<br/>
2<br/>
3&#160;...<br/>
<b>Figure 24:&#160;<br/>ODT:&#160;Allocation of&#160;RAM&#160;<br/>addresses&#160;to DAQ DTO</b><br/>
Stated more precisely,&#160;an entry&#160;in&#160;an ODT&#160;list&#160;references a&#160;memory&#160;area in&#160;RAM&#160;by&#160;the&#160;<br/>address&#160;and length of&#160;the&#160;object.&#160;<br/>
After&#160;receiving&#160;the&#160;measurement start command, at some point an event occurs&#160;that is&#160;<br/>associated&#160;with a measurement.&#160;The&#160;XCP Slave&#160;begins&#160;to acquire&#160;the data. It combines&#160;the&#160;<br/>individual objects into&#160;packets and sends&#160;them&#160;on&#160;the bus.&#160;The&#160;Master&#160;reads&#160;the&#160;bus&#160;mes­<br/>sage&#160;and can interpret&#160;the&#160;individual data, because&#160;it has&#160;defined&#160;the allocation of&#160;individ­<br/>ual objects&#160;to packets itself&#160;and&#160;therefore it knows&#160;their&#160;relationships.&#160;<br/>
However,&#160;each packet&#160;has a&#160;maximum&#160;number&#160;of&#160;useful&#160;bytes,&#160;which&#160;depends&#160;on&#160;the&#160;trans­<br/>port medium&#160;that is&#160;used.&#160;In&#160;the&#160;case&#160;of&#160;CAN,&#160;this&#160;amounts&#160;to seven bytes.&#160;If&#160;more data&#160;<br/>needs&#160;to be measured, an ODT&#160;is no&#160;longer&#160;sufficient.&#160;If&#160;two or&#160;more ODTs need&#160;to&#160;be used&#160;<br/>to&#160;transmit&#160;the&#160;measured&#160;values,&#160;then&#160;the&#160;Slave&#160;must be&#160;able&#160;to copy&#160;the data into&#160;the cor­<br/>rect ODT&#160;and&#160;the&#160;Master&#160;must be&#160;able&#160;to uniquely&#160;identify&#160;the&#160;received ODTs. If&#160;multiple&#160;<br/>measurement intervals of&#160;the&#160;ECU are used,&#160;the&#160;relationship&#160;between&#160;ODT&#160;and measure­<br/>ment interval must also&#160;be uniquely&#160;identifiable.&#160;<br/>
<hr/>
<a name=37></a>1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
39<br/>
The ODTs are combined&#160;into DAQ&#160;lists in&#160;the&#160;XCP&#160;protocol.&#160;Each DAQ list contains&#160;a num­<br/>ber&#160;of&#160;ODTs and is assigned&#160;to an event.<br/>
<b>ODT&#160;#2&#160;</b>0&#160;address, length<br/>
1&#160;address, length<br/>
<b>ODT&#160;#1&#160;</b>0&#160;address, length<br/>
2&#160;address, length<br/>
1&#160;address, length<br/>
<b>ODT&#160;#0&#160;</b>0&#160;address, length<br/>
3&#160;address, length<br/>
2&#160;address, length<br/>
1&#160;address, length&#160;...<br/>
PID=2&#160;0<br/>
1<br/>
2<br/>
3<br/>
...<br/>
3&#160;address, length<br/>
2&#160;address, length<br/>
...<br/>
PID=1&#160;0<br/>
1<br/>
2<br/>
3<br/>
...<br/>
3&#160;address, length<br/>
...<br/>
PID=0&#160;0<br/>
1<br/>
2<br/>
3<br/>
...<br/>
<b>Figure 25:&#160;<br/>DAQ list&#160;with&#160;three ODTs</b><br/>
For&#160;example, if&#160;the&#160;user&#160;uses&#160;two measurement intervals&#160;(=&#160;two different events in&#160;the&#160;<br/>ECU), then&#160;two&#160;DAQ&#160;lists are used as&#160;well.&#160;One&#160;DAQ list is needed per&#160;event&#160;used.&#160;Each DAQ&#160;<br/>list contains&#160;the&#160;entries&#160;related&#160;to&#160;the&#160;ODTs&#160;and&#160;each&#160;ODT&#160;contains&#160;references&#160;to the&#160;values&#160;<br/>in the&#160;RAM&#160;cells.<br/>
It is&#160;also&#160;possible&#160;for&#160;the&#160;Slave&#160;to&#160;transfer&#160;time&#160;information.&#160;A&#160;DAQ list represents&#160;the&#160;val­<br/>ues&#160;belonging&#160;to a specific&#160;time event. Before&#160;these&#160;values&#160;in&#160;the Slave are recorded,&#160;the&#160;<br/>point&#160;in&#160;time of&#160;the&#160;event&#160;is noted and&#160;transferred&#160;within&#160;the&#160;first&#160;ODT.&#160;The&#160;timestamp is&#160;<br/>implemented using&#160;a counter.&#160;The&#160;time interval at&#160;which&#160;the&#160;counter&#160;is incremented is spec­<br/>ified&#160;in&#160;the&#160;A2L.&#160;<br/>
DAQ&#160;lists are subdivided&#160;into&#160;the&#160;types:&#160;static, predefined&#160;and dynamic.&#160;<br/>
<hr/>
<a name=38></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-38_1.png"/><br/>
40<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>Static&#160;DAQ&#160;lists:<br/></b>If&#160;the&#160;DAQ&#160;lists and ODT&#160;tables are permanently&#160;defined&#160;in&#160;the ECU, as&#160;is&#160;familiar&#160;from CCP,&#160;<br/>they&#160;are&#160;referred&#160;to as&#160;static DAQ lists.&#160;There&#160;is&#160;no&#160;definition&#160;of&#160;which measurement para­<br/>meters&#160;exist in&#160;the&#160;ODT&#160;lists, rather&#160;only&#160;the&#160;framework&#160;that can be&#160;filled (in contrast&#160;to&#160;<br/>this,&#160;see&#160;predefined&#160;DAQ lists).<br/>
In static DAQ&#160;lists,&#160;the&#160;definitions are set in&#160;the&#160;ECU code and are described in&#160;the&#160;A2L.&#160;<br/>&#160;Figure 26&#160;shows an excerpt of&#160;an&#160;A2L, in&#160;which&#160;static DAQ lists are defined:&#160;<br/>
<b>Figure 26:&#160;<br/>Static DAQ lists</b><br/>
In&#160;the above example,&#160;there is a DAQ&#160;list&#160;with&#160;the&#160;number&#160;0,&#160;which is allocated&#160;to a 10­ms&#160;<br/>event&#160;and can carry&#160;a maximum of&#160;two ODTs.&#160;The&#160;DAQ list&#160;with&#160;the number&#160;1 has&#160;four&#160;ODTs&#160;<br/>and is linked&#160;to&#160;the&#160;100 ms event.<br/>The&#160;A2L&#160;matches&#160;the&#160;contents of&#160;the&#160;ECU. In&#160;the&#160;case&#160;of&#160;static DAQ lists,&#160;the number&#160;of&#160;<br/>DAQ lists and&#160;the&#160;ODT&#160;lists&#160;they&#160;each&#160;contain are defined&#160;with&#160;the download of&#160;the applica­<br/>tion into&#160;the&#160;ECU. If&#160;the&#160;user&#160;now&#160;attempts&#160;to measure more signals&#160;with an event&#160;than&#160;fit&#160;<br/>in&#160;the allocated DAQ&#160;list,&#160;the&#160;Slave in&#160;the&#160;ECU&#160;will not be able&#160;to&#160;fulfill&#160;the requirements and&#160;<br/>the&#160;configuration&#160;attempt is&#160;terminated&#160;with an error. It does not matter&#160;that&#160;the other&#160;<br/>DAQ list is still&#160;fully&#160;available and&#160;therefore actually&#160;still has&#160;transmission capacity.<br/>
<b>Predefined DAQ&#160;lists:<br/></b>Entirely&#160;predefined&#160;DAQ&#160;lists&#160;can&#160;also be&#160;set up in&#160;the&#160;ECU. However,&#160;this method is practi­<br/>cally&#160;never&#160;used&#160;in ECUs due&#160;to&#160;the lack&#160;of&#160;flexibility&#160;for&#160;the user.&#160;It&#160;is&#160;different&#160;for&#160;analog&#160;<br/>measurement systems&#160;which&#160;transmit&#160;their&#160;data by&#160;XCP: Flexibility&#160;is unnecessary&#160;here,&#160;<br/>since&#160;the&#160;physical structure of&#160;the measurement system remains&#160;the same over&#160;its life.<br/>
<hr/>
<a name=39></a>1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
41<br/>
<b>Dynamic&#160;DAQ&#160;lists:&#160;<br/></b>A&#160;special&#160;aspect of&#160;the&#160;XCP protocol are&#160;the&#160;dynamic DAQ&#160;lists. It is not&#160;the absolute&#160;param­<br/>eters of&#160;the&#160;DAQ and ODT&#160;lists&#160;that are permanently&#160;defined in&#160;the ECU code here, but just&#160;<br/>the&#160;parameters of&#160;the&#160;memory&#160;area&#160;that can&#160;be&#160;used&#160;for&#160;the&#160;DAQ lists.&#160;The advantage is&#160;<br/>that&#160;the&#160;measurement&#160;tool has&#160;more&#160;latitude&#160;in&#160;putting&#160;together&#160;the DAQ&#160;lists and it can&#160;<br/>manage&#160;the&#160;structure of&#160;the&#160;DAQ lists dynamically.<br/>
Various&#160;functions&#160;especially&#160;designed&#160;for&#160;this dynamic management are available in&#160;XCP&#160;<br/>such&#160;as&#160;ALLOC_ODT&#160;which&#160;the&#160;Master&#160;can&#160;use&#160;to define&#160;the&#160;structure of&#160;a DAQ&#160;list in&#160;the&#160;<br/>Slave.<br/>
MIN_DAQ + DAQ_COUNT<br/>
DAQ1<br/>
DAQ0<br/>
ALLOC_DAQ<br/>
ALLOC_ODT_ENTRY<br/>
ODT_ENTERIES_COUNT<br/>
T<br/>
OC_OD<br/>ALL<br/>
GRANULARITY_ODT_ENTRY_SIZE_DAQ<br/>
<b>Figure 27:&#160;</b><br/>
ODT_COUNT<br/>
<b>Dynamic DAQ lists</b><br/>
In&#160;putting together&#160;the&#160;DAQ&#160;lists,&#160;the&#160;Master&#160;must be able&#160;to distinguish&#160;whether&#160;dynamic&#160;<br/>or&#160;static DAQ lists&#160;are&#160;being&#160;used, how&#160;the&#160;parameters&#160;and&#160;structures&#160;of&#160;the DAQ lists look,&#160;<br/>etc.<br/>
<hr/>
<a name=40></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-40_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-40_2.png"/><br/>
42<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.3.3&#160;STIM&#160;Calibration&#160;Method</b><br/>
The&#160;XCP&#160;calibration method&#160;was already&#160;introduced in&#160;the chapter&#160;about&#160;exchanging&#160;CTOs.&#160;<br/>This&#160;type of&#160;calibration exists in every&#160;XCP driver&#160;and&#160;forms&#160;the basis&#160;for&#160;calibrating objects&#160;<br/>in&#160;the&#160;ECU. However, no&#160;synchronization exists&#160;between&#160;sending a calibration command and&#160;<br/>an event in&#160;the&#160;ECU.<br/>
In contrast&#160;to&#160;this,&#160;the&#160;use&#160;of&#160;STIM&#160;is not based&#160;on exchanging CTOs, rather&#160;on&#160;the&#160;use of&#160;<br/>DTOs&#160;with communication&#160;that is synchronized&#160;to an event in&#160;the Slave.&#160;The Master&#160;must&#160;<br/>therefore know&#160;to&#160;which&#160;events in&#160;the&#160;Slave&#160;it can&#160;even&#160;synchronize at all.&#160;This information&#160;<br/>must also&#160;exist in&#160;the&#160;A2L.&#160;<br/>
<b>Figure 28: Event&#160;for&#160;DAQ and STIM</b><br/>
If&#160;the Master&#160;sends&#160;data&#160;to&#160;the Slave by&#160;STIM,&#160;the&#160;XCP&#160;Slave must&#160;be&#160;informed&#160;of&#160;the&#160;loca­<br/>tion in&#160;the packets at&#160;which&#160;the calibration parameters can be&#160;found.&#160;The&#160;same&#160;mechanisms&#160;<br/>are used&#160;here as are used&#160;for&#160;the&#160;DAQ&#160;lists.<br/>
<hr/>
<a name=41></a>1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
43<br/>
<b>1.3.4&#160;XCP&#160;Packet&#160;Addressing&#160;for&#160;DAQ&#160;and STIM&#160;</b><br/>
Addressing&#160;of&#160;the&#160;XCP packets&#160;was already&#160;discussed&#160;at&#160;the&#160;beginning of&#160;this chapter. Now&#160;<br/>that&#160;the&#160;concepts&#160;of&#160;DAQ, ODT&#160;and&#160;STIM&#160;have&#160;been&#160;introduced,&#160;XCP packet addressing&#160;will&#160;<br/>be presented in greater&#160;detail.&#160;<br/>
During&#160;transmission of&#160;CTOs,&#160;the use of&#160;a PID&#160;is&#160;fully&#160;sufficient&#160;to uniquely&#160;identify&#160;a packet;&#160;<br/>however, this&#160;is&#160;no&#160;longer&#160;sufficient for&#160;transmitting&#160;measured&#160;values.&#160;The following&#160;figure&#160;<br/>offers an overview&#160;of&#160;the&#160;possible addressing&#160;that could occur&#160;with&#160;the DTOs:<br/>
<b>XCP DTO Packet</b><br/>
Identification Field<br/>
Timestamp Field<br/>
Data Field<br/>
PID<br/>
PID&#160;DAQ<br/>
TS<br/>
PID<br/>
DAQ<br/>
TS<br/>
<b>Figure 29:&#160;</b><br/>
PID&#160;FILL<br/>
DAQ<br/>
TIMESTAMP<br/>
DATA<br/>
<b>Structure&#160;of&#160;the&#160;<br/>XCP&#160;packet&#160;for&#160;</b><br/>
<b>DTO&#160;transmissions</b><br/>
<b>Transmission&#160;type: “absolute ODT&#160;numbers”</b><br/>
Absolute means&#160;that&#160;the&#160;ODT&#160;numbers are unique&#160;throughout&#160;the entire communication –&#160;<br/>i.e. across&#160;all DAQ lists.&#160;In&#160;turn,&#160;this&#160;means&#160;that&#160;the&#160;use&#160;of&#160;absolute ODT&#160;numbers assumes&#160;<br/>a&#160;transformation step&#160;that utilizes&#160;a so­called “FIRST_PID&#160;for&#160;the&#160;DAQ&#160;list.<br/>
If&#160;a&#160;DAQ&#160;list starts&#160;with&#160;the&#160;PID&#160;j,&#160;then&#160;the PID of&#160;the&#160;first packet has&#160;the&#160;value j,&#160;the second&#160;<br/>packet&#160;has&#160;the PID&#160;value j + 1,&#160;the&#160;third&#160;packet has&#160;the PID&#160;value j + 2,&#160;etc.&#160;Naturally,&#160;the&#160;<br/>Slave&#160;must ensure&#160;here&#160;that&#160;the&#160;sum of&#160;FIRST_PID + relative&#160;ODT&#160;number&#160;remains below&#160;<br/>the&#160;PID of&#160;the&#160;next DAQ list.<br/>
DAQ­list: 0&#160;<br/>
≤ PID ≤ k<br/>
DAQ­list: k&#160;+ 1&#160;&#160;≤ PID ≤ m<br/>DAQ­list: m + 1&#160;≤ PID ≤ n<br/>etc.<br/>
<hr/>
<a name=42></a>44<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
In&#160;this case,&#160;the&#160;identification&#160;field is&#160;very&#160;simple:<br/>
Identification Field<br/>
PID<br/>
<b>Figure 30:&#160;</b><br/>
absolute ODT number<br/>
<b>Identification&#160;field with&#160;absolute&#160;<br/>ODT&#160;numbers</b><br/>
<b>Transmission&#160;type: “relative ODT&#160;numbers and absolute DAQ&#160;lists numbers”</b><br/>
In&#160;this case, both&#160;the DAQ&#160;lists number&#160;and&#160;the&#160;ODT&#160;number&#160;can be&#160;transmitted in&#160;the Iden­<br/>tification Field.&#160;However,&#160;there is still space left over&#160;in&#160;the&#160;number&#160;of&#160;bytes&#160;that is available&#160;<br/>for&#160;the&#160;information:<br/>
Identification Field<br/>
PID&#160;DAQ<br/>
absolute DAQ list number<br/>
<b>Figure 31:&#160;</b><br/>
relative ODT number<br/>
<b>ID&#160;field&#160;with relative ODT&#160;and absolute&#160;<br/>DAQ numbers (one byte)</b><br/>
In&#160;the&#160;figure, one&#160;byte is available&#160;for&#160;the&#160;DAQ&#160;number&#160;and one&#160;byte&#160;for&#160;the ODT&#160;number.<br/>
The&#160;maximum number&#160;of&#160;DAQ&#160;lists can be&#160;transmitted using&#160;two bytes:&#160;<br/>
Identification Field<br/>
PID<br/>
DAQ<br/>
absolute DAQ list number<br/>
<b>Figure 32:&#160;</b><br/>
relative ODT number<br/>
<b>ID&#160;field&#160;with relative ODT&#160;and absolute&#160;<br/>DAQ numbers (two bytes)</b><br/>
<hr/>
<a name=43></a>1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
45<br/>
If&#160;it is not possible&#160;to send&#160;three bytes,&#160;it is also&#160;possible&#160;to&#160;work&#160;with&#160;four&#160;bytes by&#160;using a&#160;<br/>fill byte:<br/>
Identification Field<br/>
PID&#160;FILL<br/>
DAQ<br/>
absolute DAQ list number<br/>
for alignement<br/>
<b>Figure 33:&#160;</b><br/>
<b>ID&#160;field&#160;with relative ODT&#160;and&#160;</b><br/>
relative ODT number<br/>
<b>absolute DAQ numbers as&#160;well as&#160;</b><br/>
<b>fill byte (total of&#160;four&#160;bytes)</b><br/>
How&#160;does&#160;the&#160;XCP Master&#160;now&#160;learn&#160;which&#160;method&#160;the&#160;Slave&#160;is using? First, by&#160;the entry&#160;in&#160;<br/>the&#160;A2L&#160;and second by&#160;the request&#160;to&#160;the Slave&#160;to determine&#160;which&#160;communication&#160;version&#160;<br/>it has implemented.<br/>
The&#160;response&#160;to the&#160;GET_DAQ_PROCESSOR_INFO request also sets&#160;the DAQ_KEY_BYTE&#160;<br/>that&#160;the&#160;Slave uses&#160;to inform&#160;the&#160;Master&#160;which&#160;transmission&#160;type is being used.&#160;If&#160;not only&#160;<br/>DAQ is&#160;being&#160;used, but also&#160;STIM,&#160;the&#160;Master&#160;must use&#160;the&#160;same method&#160;for&#160;STIM&#160;that&#160;the&#160;<br/>Slave uses&#160;for&#160;DAQ.<br/>
<b>1.3.5&#160;Bypassing&#160;=&#160;DAQ&#160;+ STIM&#160;</b><br/>
Bypassing&#160;can be implemented by&#160;joint use&#160;of&#160;DAQ&#160;and STIM&#160;(see Figure 8) and it repre­<br/>sents a special&#160;form of&#160;a rapid prototyping&#160;solution.&#160;For&#160;a deeper&#160;understanding, however,&#160;<br/>further&#160;details are necessary, so&#160;this method is not explained&#160;until chapter&#160;4.5 “Bypassing”.<br/>
<b>1.3.6.&#160;Time&#160;Correlation&#160;and Synchronization</b><br/>
Various mechanisms are available&#160;to&#160;the Master&#160;for&#160;correlating&#160;the&#160;timestamp of&#160;the mea­<br/>surement data of&#160;a Slave&#160;to&#160;the&#160;timestamps of&#160;other&#160;measurement data. In&#160;the simplest&#160;<br/>form of&#160;a Slave implementation,&#160;the&#160;Slave&#160;features&#160;a clock&#160;and can access its&#160;value at any&#160;<br/>time.&#160;The&#160;DAQ&#160;timestamps sent by&#160;the&#160;XCP Slave are based&#160;on&#160;this clock. Here,&#160;the Slave&#160;<br/>transfers&#160;the&#160;time information in&#160;the&#160;first ODT&#160;of&#160;each&#160;DAQ event.&#160;The Slave retrieves&#160;the&#160;<br/>timestamp at&#160;the&#160;point in&#160;time at&#160;which&#160;the&#160;event&#160;was&#160;initiated and at&#160;which it copies&#160;the&#160;<br/>measurement data&#160;from RAM.&#160;<br/>The&#160;correlation&#160;of&#160;this&#160;clock&#160;to other&#160;clocks is&#160;unknown&#160;to&#160;the&#160;Master, as&#160;the DAQ messages&#160;<br/>require an undefined&#160;amount&#160;of&#160;time&#160;to&#160;reach&#160;the&#160;Master&#160;from&#160;the Slave.&#160;The&#160;clocks can be&#160;<br/>correlated using&#160;the GET_DAQ_CLOCK&#160;command.&#160;Before&#160;the&#160;start of&#160;measurement,&#160;and&#160;<br/>usually&#160;at regular&#160;intervals,&#160;the&#160;Master&#160;sends&#160;the&#160;GET_DAQ_CLOCK&#160;command and&#160;the&#160;<br/>
<hr/>
<a name=44></a>46<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Slave&#160;responds&#160;with&#160;the&#160;current&#160;value&#160;of&#160;the&#160;Slave&#160;clock. Since&#160;the Master&#160;knows&#160;the point&#160;<br/>in&#160;time at&#160;which&#160;it sent&#160;the&#160;command, it can calculate a&#160;time offset between&#160;the Master&#160;<br/>clock&#160;and&#160;the&#160;Slave clock&#160;using&#160;the&#160;timestamp of&#160;the&#160;Slave and&#160;the point in&#160;time&#160;the com­<br/>mand was&#160;sent.&#160;<br/>Naturally,&#160;this method is also afflicted&#160;with inaccuracies if&#160;the run&#160;time of&#160;the GET_DAQ_CLOCK&#160;<br/>command&#160;is&#160;not precisely&#160;defined&#160;or&#160;the&#160;point in&#160;time&#160;at&#160;which&#160;the&#160;clocks are read in&#160;the&#160;<br/>Master&#160;and Slave cannot&#160;be determined precisely&#160;when&#160;sending/receiving&#160;the&#160;command.&#160;<br/>This&#160;is&#160;why&#160;version&#160;1.3&#160;of&#160;the&#160;XCP specification&#160;provides&#160;improved methods enabling correla­<br/>tion of&#160;the&#160;Master&#160;and Slave clocks&#160;with a precision of&#160;just a&#160;few&#160;microseconds.<br/>
<b>1.3.6.1&#160;Multicast</b><br/>
For&#160;better&#160;correlation of&#160;the&#160;clocks of&#160;multiple Slaves&#160;to one&#160;another,&#160;the Master&#160;reads&#160;the&#160;<br/>clocks of&#160;multiple Slaves&#160;at&#160;the&#160;same&#160;time. For&#160;this&#160;purpose,&#160;the Master&#160;sends a command&#160;<br/>to&#160;all&#160;Slaves&#160;which are accessible using&#160;the same&#160;transport&#160;medium.&#160;Each&#160;Slave&#160;records&#160;the&#160;<br/>point&#160;in time&#160;at which&#160;it&#160;receives&#160;the&#160;command&#160;and transfers the&#160;value to the&#160;Master.&#160;To&#160;<br/>achieve maximum precision,&#160;two requirements must be&#160;fulfilled&#160;to&#160;the greatest degree&#160;<br/>possible:<br/>On&#160;the&#160;one&#160;hand,&#160;the&#160;Slave implementation should ensure (as in&#160;the past)&#160;that&#160;the record­<br/>ing&#160;of&#160;the&#160;timestamp is initiated as soon as possible&#160;upon receipt of&#160;the command. On&#160;the&#160;<br/>other&#160;hand,&#160;the&#160;latency&#160;times&#160;between&#160;the&#160;Slaves&#160;and&#160;the&#160;Master&#160;should be&#160;the&#160;same&#160;to&#160;the&#160;<br/>greatest&#160;degree&#160;possible.<br/>
The&#160;GET_DAQ_CLOCK_MULTICAST&#160;command&#160;is&#160;available&#160;for&#160;this purpose.&#160;The Slave&#160;<br/>responds&#160;with&#160;an&#160;EV_TIME_SYNC&#160;message,&#160;in which&#160;the&#160;timestamp&#160;is transferred.&#160;<br/>
<b>XCP Slave</b><br/>
<b>XCP Master</b><br/>
XCP Slave Clock<br/>
free&#160;running<br/>
GET_DAQ_CLOCK_MULTICAST<br/>
EV_TIME_SYNC<br/>
GET_DAQ_CLOCK_MULTICAST<br/>
EV_TIME_SYNC<br/>
<b>Figure 34:&#160;</b><br/>
t<br/>
<b>XCP&#160;Slave with&#160;<br/>free-running clock</b><br/>
<hr/>
<a name=45></a>1.3 Exchanging DTOs – Synchronous Data Exchange&#160;<br/>
47<br/>
<b>1.3.6.2.&#160;Grandmaster&#160;Clock</b><br/>
A&#160;further&#160;solution&#160;involves&#160;the&#160;time&#160;of&#160;the&#160;Slave&#160;already&#160;being&#160;synchronized/coordinated&#160;<br/>with another&#160;clock,&#160;the&#160;so­called grandmaster&#160;clock.<br/>
<b>First, an explanation&#160;of&#160;the&#160;terms “synchronized”&#160;and “coordinated”:<br/></b>Stated simply,&#160;two&#160;clocks are synchronized&#160;with one another&#160;if&#160;they&#160;supply&#160;the&#160;identical&#160;<br/>timestamp when they&#160;are&#160;read&#160;at the&#160;same time.<br/>In&#160;contrast, clocks&#160;which&#160;are&#160;coordinated&#160;to one&#160;another&#160;do not necessarily&#160;need&#160;to sup­<br/>ply&#160;the&#160;same&#160;timestamp. In both clocks, 1 second is exactly&#160;the&#160;same length.<br/>
IEEE&#160;1588&#160;with&#160;PTP (Precision&#160;Time&#160;Protocol) is used.&#160;In&#160;the&#160;first step,&#160;the&#160;XCP Master&#160;must&#160;<br/>know&#160;whether&#160;the Slave is linked&#160;to an external clock.&#160;As&#160;there can be more&#160;than&#160;one grand­<br/>master&#160;clock&#160;in an overall&#160;system,&#160;information on&#160;the exact&#160;clock&#160;to&#160;which&#160;the Slave&#160;is&#160;linked&#160;<br/>must be available&#160;to&#160;the&#160;XCP Master.&#160;<br/>
<b>XCP Slave</b><br/>
<b>XCP Master</b><br/>
XCP Slave Clock<br/>
synchronized&#160;to a<br/>
<b>Grandmaster&#160;Clock</b><br/>
Grandmaster Clock<br/>
e.g.&#160;<br/>
IEEE&#160;1588<br/>
GET_DAQ_CLOCK_MULTICAST<br/>
EV_TIME_SYNC<br/>
GET_DAQ_CLOCK_MULTICAST<br/>
EV_TIME_SYNC<br/>
t<br/>
<b>Figure 35:&#160;The clock&#160;of&#160;the&#160;XCP Slave is synchronized&#160;with&#160;the grandmaster&#160;clock</b><br/>
<hr/>
<a name=46></a>48<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
The&#160;XCP standard supports&#160;additional&#160;scenarios&#160;which&#160;can&#160;only&#160;briefly&#160;be sketched out here&#160;<br/>briefly. Further&#160;details can be&#160;found in&#160;the&#160;XCP specifications.&#160;<br/>
&gt;&#160;&#160;Should it be possible&#160;to coordinate&#160;the&#160;XCP Slave clock&#160;with&#160;the external clock, but&#160;&#160;<br/>
not synchronize&#160;them,&#160;there&#160;will be an offset between&#160;the&#160;grandmaster&#160;clock&#160;and&#160;&#160;<br/>the Slave clock.&#160;The&#160;XCP&#160;Master&#160;can request&#160;the details&#160;from&#160;the Slave&#160;using&#160;the&#160;TIME_<br/>CORRELATION_PROPERTIES command.&#160;<br/>
&gt;&#160;&#160;The&#160;free­running clock&#160;of&#160;the Slave cannot&#160;be synchronized&#160;with&#160;a&#160;grandmaster&#160;clock,&#160;but&#160;<br/>
there is&#160;another&#160;clock&#160;in&#160;the&#160;Slave, e.g.&#160;a clock&#160;synchronized&#160;with&#160;the grandmaster&#160;clock&#160;in&#160;<br/>the&#160;Ethernet PHY&#160;of&#160;the&#160;Slave. If&#160;the&#160;Master&#160;receives&#160;both&#160;times&#160;at&#160;the same point in&#160;time,&#160;<br/>it can correlate&#160;the&#160;DAQ&#160;timestamp of&#160;the&#160;free­running&#160;clock&#160;with&#160;the grandmaster&#160;clock&#160;<br/>and its own&#160;time domain.&#160;<br/>
&gt;&#160;&#160;Another&#160;scenario arises&#160;when&#160;there is a&#160;free­running&#160;clock&#160;of&#160;the&#160;XCP Slave and an ECU&#160;<br/>
clock&#160;and&#160;the&#160;DAQ&#160;timestamps originate&#160;from&#160;the&#160;ECU clock.&#160;This is&#160;the case&#160;when&#160;an&#160;<br/>external&#160;XCP Slave, such&#160;as&#160;the&#160;VX1000 measurement and calibration hardware is used&#160;<br/>from&#160;Vector, is used.&#160;<br/>
&gt;&#160;&#160;If&#160;all of&#160;the&#160;sketched&#160;solutions are combined,&#160;a&#160;total of&#160;three&#160;different clocks are involved:&#160;<br/>
the&#160;free­running&#160;Slave clock, a clock&#160;which&#160;is synchronized&#160;with a grandmaster&#160;clock&#160;and&#160;<br/>the&#160;ECU clock.&#160;<br/>
&gt;&#160;&#160;&#160;In&#160;the&#160;last scenario,&#160;there is no&#160;Slave clock, but&#160;there is an ECU clock&#160;which is synchronized&#160;<br/>
with a grandmaster&#160;clock.<br/>
Synchronization between&#160;the&#160;DAQ&#160;timestamps and&#160;the&#160;Master&#160;domain&#160;time can be realized&#160;<br/>for&#160;all scenarios in&#160;the&#160;Master&#160;using&#160;the&#160;XCP mechanisms.<br/>
<hr/>
<a name=47></a>1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
49<br/>
<b>1.4&#160;XCP&#160;Transport&#160;Layers&#160;</b><br/>
A&#160;main&#160;requirement in&#160;designing&#160;the&#160;XCP protocol&#160;was&#160;that it must support different&#160;trans­<br/>port&#160;layers.&#160;At&#160;the&#160;time&#160;this document&#160;was defined,&#160;the&#160;following&#160;layers&#160;had&#160;been&#160;defined:&#160;<br/>XCP on&#160;CAN, FlexRay, Ethernet, SxI and USB.&#160;The&#160;bus systems CAN, LIN and FlexRay&#160;are&#160;<br/>explained on&#160;the&#160;Vector&#160;E­Learning&#160;platform, as&#160;well as an introduction&#160;to&#160;AUTOSAR.&#160;For&#160;<br/>details&#160;see&#160;the&#160;website www.vector­elearning.com.<br/>
<b>1.4.1&#160;CAN&#160;</b><br/>
XCP&#160;was developed as a successor&#160;protocol of&#160;the&#160;CAN&#160;Calibration Protocols (CCP) and&#160;<br/>must absolutely&#160;satisfy&#160;the&#160;requirements of&#160;the&#160;CAN bus.&#160;The&#160;communication over&#160;the CAN&#160;<br/>bus&#160;is&#160;defined&#160;by&#160;the&#160;associated description&#160;file. Usually&#160;the&#160;DBC&#160;format is used, but in some&#160;<br/>isolated cases&#160;the&#160;AUTOSAR&#160;format&#160;ARXML&#160;is being&#160;used&#160;too.&#160;<br/>
A&#160;CAN&#160;message&#160;is identified by&#160;a&#160;unique CAN&#160;identifier.&#160;The communication&#160;matrix&#160;is&#160;defined&#160;<br/>in&#160;the description&#160;file:&#160;Who&#160;sends&#160;which&#160;message&#160;and how&#160;are&#160;the eight useful bytes of&#160;the&#160;<br/>CAN bus being&#160;used?&#160;The&#160;following&#160;figure illustrates&#160;the&#160;process:&#160;<br/>
<b>Data</b><br/>
<b>CAN&#160;</b><br/>
<b>CAN</b><br/>
<b>CAN</b><br/>
<b>CAN</b><br/>
<b>Frame</b><br/>
<b>Node&#160;A</b><br/>
<b>Node B</b><br/>
<b>Node C</b><br/>
<b>Node D</b><br/>
ID=0x12<br/>
Sender<br/>
Receiver<br/>
ID=0x34<br/>
Sender<br/>
Receiver<br/>
Receiver<br/>
ID=0x52<br/>
Receiver<br/>
Sender<br/>
ID=0x67<br/>
Receiver<br/>
Receiver<br/>
Sender<br/>
Receiver<br/>
ID=0xB4<br/>
Receiver<br/>
Sender<br/>
<b>Figure 36:&#160;<br/>Definition&#160;of&#160;which&#160;</b><br/>
ID=0x3A5<br/>
Sender<br/>
Receiver<br/>
Receiver<br/>
Receiver<br/>
<b>bus nodes send&#160;which&#160;<br/>messages</b><br/>
The&#160;message&#160;with&#160;ID 0x12&#160;is&#160;sent by&#160;CAN node&#160;A&#160;and&#160;all other&#160;nodes&#160;on&#160;the bus receive&#160;this&#160;<br/>message.&#160;In&#160;the&#160;framework&#160;of&#160;acceptance&#160;testing,&#160;CAN&#160;nodes&#160;C&#160;and&#160;D&#160;conclude&#160;that&#160;they&#160;<br/>do not need&#160;the&#160;message&#160;and&#160;they&#160;reject it. CAN node&#160;B, on&#160;the&#160;other&#160;hand, determines&#160;that&#160;<br/>its&#160;higher­level&#160;layers&#160;need&#160;the&#160;message&#160;and&#160;they&#160;provide&#160;them&#160;via&#160;the Rx&#160;buffer.&#160;The CAN&#160;<br/>nodes&#160;are interlinked as&#160;follows:<br/>
<hr/>
<a name=48></a>50<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>CAN Node&#160;A</b><br/>
<b>CAN Node&#160;B</b><br/>
Host<br/>
Host<br/>
CAN Interface<br/>
CAN Interface<br/>
Tx<br/>
Rx<br/>
Tx<br/>
Rx<br/>
Buffer<br/>
Buffer&#160;<br/>
Buffer<br/>
Buffer&#160;<br/>
Acceptance<br/>
Acceptance<br/>
Test<br/>
Test<br/>
Send<br/>
Receive<br/>
Send<br/>
Receive<br/>
<b>CAN</b><br/>
Receive<br/>
Send<br/>
Receive<br/>
Send<br/>
Acceptance<br/>
Acceptance<br/>
Test<br/>
Test<br/>
Rx<br/>
Tx<br/>
Rx<br/>
Tx<br/>
Buffer&#160;<br/>
Buffer<br/>
Buffer&#160;<br/>
Buffer<br/>
CAN Interface<br/>
CAN Interface<br/>
Host<br/>
Host<br/>
<b>Figure 37:&#160;</b><br/>
<b>CAN Node&#160;C</b><br/>
<b>CAN Node&#160;D</b><br/>
<b>Representation of&#160;a&#160;<br/>CAN network</b><br/>
The&#160;XCP messages&#160;are not described in&#160;the&#160;communication matrix! If&#160;measured&#160;values are&#160;<br/>sent&#160;from&#160;the&#160;Slave&#160;via dynamic DAQ lists, e.g.&#160;with&#160;the&#160;help of&#160;XCP,&#160;the messages are&#160;<br/>assembled according&#160;to&#160;the&#160;signals&#160;selected by&#160;the&#160;user. If&#160;the&#160;signal selection changes,&#160;the&#160;<br/>message&#160;contents&#160;change&#160;as&#160;well.&#160;Nonetheless,&#160;there&#160;is&#160;a relationship between&#160;the commu­<br/>nication&#160;matrix&#160;and&#160;XCP: CAN identifiers are&#160;needed&#160;to&#160;transmit&#160;the&#160;XCP messages over&#160;<br/>CAN.&#160;To minimize&#160;the&#160;number&#160;of&#160;CAN identifiers used,&#160;the&#160;XCP communication is limited&#160;to&#160;<br/>the&#160;use&#160;of&#160;just&#160;two CAN identifiers&#160;that are not being&#160;used&#160;in&#160;the DBC&#160;for&#160;“normal” commu­<br/>nication.&#160;One&#160;identifier&#160;is&#160;needed&#160;to send&#160;information&#160;from&#160;the&#160;Master&#160;to&#160;the Slave;&#160;the&#160;<br/>other&#160;is used&#160;by&#160;the&#160;Slave&#160;for&#160;the&#160;response&#160;to&#160;the&#160;Master.<br/>
The&#160;excerpt&#160;from&#160;the&#160;CANape&#160;Trace window&#160;shows the&#160;CAN&#160;identifiers&#160;that&#160;are used under&#160;<br/>the&#160;“ID” column. In&#160;this&#160;example, just&#160;two different identifiers are used: 554 as&#160;the ID&#160;for&#160;the&#160;<br/>message&#160;from Master&#160;to Slave (direction&#160;Tx) and 555&#160;for&#160;sending messages&#160;from&#160;the Slave&#160;<br/>to&#160;the Master&#160;(direction Rx).&#160;<br/>
<hr/>
<a name=49></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-49_1.png"/><br/>
1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
51<br/>
<b>Figure 38: Example of&#160;XCP-on-CAN communication</b><br/>
In&#160;this example,&#160;the&#160;entire&#160;XCP communication is handled&#160;by&#160;the&#160;two CAN&#160;identifiers 554&#160;<br/>and 555.&#160;These&#160;two IDs may&#160;not be allocated&#160;for&#160;other&#160;purposes&#160;in&#160;this network.&#160;<br/>
The&#160;CAN&#160;bus&#160;transmits a maximum of&#160;eight useful bytes&#160;per&#160;message. In&#160;the case of&#160;XCP,&#160;<br/>however,&#160;we&#160;need information&#160;on&#160;the&#160;command&#160;used&#160;or&#160;the&#160;sent response.&#160;This is provided&#160;<br/>in&#160;the&#160;first byte&#160;of&#160;the&#160;CAN useful data.&#160;This&#160;means&#160;that seven&#160;bytes are available per&#160;CAN&#160;<br/>message&#160;for&#160;transporting&#160;useful&#160;data.&#160;<br/>
<b>XCP on CAN Message (Frame)</b><br/>
XCP Packet<br/>
XCP Tail<br/>
XCP Header<br/>
empty for CAN&#160;PID&#160;FILL&#160;DAQ&#160;TIMESTAMP<br/>
DATA<br/>
FILL<br/>
Control Field<br/>
Control Field<br/>
&#160;empty for CAN<br/>
for CAN<br/>
<b>Figure 39: Representation of&#160;an&#160;XCP-on-CAN message</b><br/>
In CANape,&#160;you&#160;will&#160;find&#160;an&#160;XCP­on­CAN&#160;demo&#160;with&#160;the&#160;virtual ECU&#160;XCPsim.&#160;You can learn&#160;<br/>about more details of&#160;the&#160;standard in&#160;ASAM&#160;XCP on CAN Part 3&#160;Transport Layer&#160;<br/>Specification.<br/>
<hr/>
<a name=50></a>52<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.4.2 CAN FD</b><br/>
CAN FD (CAN&#160;with&#160;flexible data rate) is an extension of&#160;the&#160;CAN protocol developed by&#160;&#160;<br/>Robert Bosch&#160;GmbH.&#160;Its&#160;primary&#160;difference&#160;to CAN involves&#160;extending&#160;the useful data&#160;from&#160;<br/>8&#160;to&#160;&#160;64 bytes.&#160;CAN FD also&#160;offers&#160;the&#160;option of&#160;sending&#160;the&#160;useful data at a higher&#160;data&#160;<br/>rate.&#160;After&#160;the&#160;arbitration&#160;phase,&#160;the&#160;data bytes&#160;are&#160;sent at a higher&#160;transmission rate&#160;than&#160;<br/>during&#160;the&#160;arbitration phase.&#160;This&#160;covers&#160;the&#160;need&#160;for&#160;greater&#160;bandwidth in automotive net­<br/>works&#160;while&#160;preserving&#160;valuable experience gained&#160;from CAN development.<br/>The&#160;XCP­on­CAN­FD specification&#160;was&#160;defined&#160;in&#160;the&#160;XCP­on­CAN&#160;description of&#160;the&#160;XCP&#160;<br/>standard,&#160;Version 1.2 (June&#160;2013).&#160;<br/>
F<br/>
r1<br/>
K<br/>
O<br/>
r0<br/>
S<br/>
IDE<br/>
EDL<br/>
BRS<br/>
ESI<br/>
DLC<br/>
Data<br/>
CRC<br/>
elim.<br/>
AC<br/>
elim.<br/>
EOF<br/>
IFS<br/>
tifier<br/>
&#160;D<br/>
Iden<br/>
CK<br/>
CRC D<br/>
A<br/>
1<br/>
11<br/>
1<br/>
1<br/>
1<br/>
1<br/>
1<br/>
1<br/>
4<br/>
0…512<br/>
17/21<br/>
1<br/>
1<br/>
1<br/>
7<br/>
3<br/>
<b>Arbitration phase</b><br/>
<b>Data phase</b><br/>
<b>Arbitration phase</b><br/>
(standard bit rate)<br/>
(optional high bit rate)<br/>
(standard bit rate)<br/>
EDL =&#160;Extended Data Length:<br/>
ESI =&#160;Error&#160;State Indicator:<br/>
&#160;<br/>
CAN (dominant (0)&#160;=&#160;CAN frame<br/>
&#160;<br/>
Dominant (0) =&#160;CAN FD node is error active<br/>
&#160;<br/>
Recessive (1) =&#160;CAN FD frame<br/>
&#160;<br/>
Recessive (1) =&#160;CAN FD node is error passive<br/>
BRS =&#160;Bit&#160;Rate Switch:<br/>
&#160;<br/>
CAN&#160;FD&#160;data&#160;phase&#160;starts&#160;immediately&#160;at&#160;sampling&#160;point of BRS:<br/>
&#160;<br/>
Dominant (0) =&#160;No&#160;change of bit&#160;rate&#160;for data phase<br/>
&#160;<br/>
Recessive (1) = Change&#160;to higher bit&#160;rate&#160;for data phase<br/>
<b>Figure 40: Illustration of&#160;a CAN FD&#160;frame</b><br/>
Despite&#160;the&#160;largely&#160;similar&#160;modes&#160;of&#160;operation,&#160;this&#160;protocol requires extensions and modifi­<br/>cations&#160;to&#160;the hardware and software.&#160;Among other&#160;things,&#160;CAN&#160;FD&#160;introduces&#160;three&#160;new&#160;<br/>bits to the&#160;control field:<br/>&gt;&#160;&#160;Extended&#160;Data Length (EDL)<br/>&gt;&#160;&#160;Bit Rate Switch (BRS)&#160;<br/>&gt;&#160;&#160;Error&#160;State Indicator&#160;(ESI)<br/>
<hr/>
<a name=51></a>1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
53<br/>
A&#160;recessive EDL&#160;bit (high&#160;level)&#160;distinguishes&#160;frames&#160;in extended CAN­FD&#160;format&#160;from&#160;those&#160;<br/>in&#160;standard CAN&#160;format, because&#160;they&#160;are&#160;identified&#160;by&#160;a dominant EDL&#160;bit (low&#160;level). Sim­<br/>ilarly, a recessive BRS bit causes&#160;the&#160;transmission of&#160;the&#160;data&#160;field&#160;to be switched&#160;to&#160;the&#160;<br/>higher&#160;bit rate.&#160;The&#160;ESI bit identifies&#160;the&#160;error&#160;state&#160;of&#160;a CAN FD node.&#160;Another&#160;four&#160;bits&#160;<br/>make&#160;up&#160;what is&#160;known&#160;as&#160;the&#160;Data Length&#160;Code&#160;(DLC),&#160;which represents&#160;the&#160;extended&#160;<br/>useful data length as a possible&#160;value of&#160;12, 16, 20, 24, 32, 48 and 64 bytes.&#160;<br/>
The&#160;use&#160;of&#160;XCP on CAN FD assumes&#160;that a second&#160;transmission rate has been defined&#160;for&#160;<br/>the&#160;useful data in&#160;the&#160;A2L&#160;file.&#160;This&#160;is&#160;fully&#160;transparent&#160;to&#160;the&#160;user,&#160;who gets a complete&#160;A2L&#160;<br/>parameterization.&#160;A&#160;measurement configuration&#160;in&#160;the&#160;XCP Master&#160;considers&#160;the maximum&#160;<br/>packet length, and&#160;the&#160;user&#160;does not need&#160;to make any&#160;other&#160;settings.&#160;<br/>
CAN FD is supported in CANape,&#160;Version 12.0 and higher. Every&#160;CAN hardware product&#160;from&#160;<br/>&#160;Vector&#160;which&#160;begins&#160;with “VN” supports&#160;the&#160;CAN FD&#160;transport protocol.<br/>
<hr/>
<a name=52></a>54<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.4.3 FlexRay</b><br/>
A&#160;basic idea in&#160;the&#160;development of&#160;FlexRay&#160;was&#160;to implement a redundant system&#160;with&#160;<br/>deterministic&#160;time&#160;behavior.&#160;The&#160;connection&#160;redundancy&#160;was&#160;achieved&#160;by&#160;using&#160;two chan­<br/>nels:&#160;channel&#160;A&#160;and&#160;channel&#160;B. If&#160;multiple&#160;FlexRay&#160;nodes&#160;(= ECUs) are redundantly&#160;intercon­<br/>nected&#160;and&#160;one&#160;branch&#160;fails,&#160;the&#160;nodes&#160;can&#160;switch&#160;over&#160;to&#160;the&#160;other&#160;channel&#160;to make use of&#160;<br/>the&#160;connection redundancy.&#160;<br/>
Node K<br/>
Node L<br/>
Node M<br/>
Node N<br/>
Node O<br/>
CH&#160;A<br/>CH&#160;B<br/>
<b>Figure 41: Nodes K&#160;and L&#160;are redundantly&#160;interconnected</b><br/>
Deterministic behavior&#160;is&#160;achieved&#160;by&#160;transmitting&#160;data&#160;within defined&#160;time&#160;slots.&#160;Also&#160;<br/>defined&#160;here is&#160;which&#160;node sends&#160;which&#160;content in&#160;which&#160;time slot.&#160;These&#160;time slots are com­<br/>bined&#160;to&#160;form one cycle.&#160;The&#160;cycles&#160;repeat&#160;here, as long&#160;as&#160;the&#160;bus is active.&#160;The assembly&#160;of&#160;<br/>the&#160;time slots and&#160;their&#160;transport&#160;contents (who&#160;sends&#160;what&#160;at&#160;which&#160;time)&#160;is&#160;known&#160;as&#160;<br/>scheduling.&#160;<br/>
Node K<br/>
Node L<br/>
Node M<br/>
Slot<br/>
Direction&#160;Frame<br/>
Slot<br/>
Direction&#160;Frame<br/>
Slot<br/>
Direction&#160;Frame<br/>
1<br/>
Tx<br/>
a<br/>
1<br/>
Tx<br/>
a<br/>
1<br/>
Tx<br/>
a<br/>
3<br/>
Rx<br/>
x<br/>
3<br/>
Rx<br/>
b<br/>
3<br/>
Rx<br/>
x<br/>
Frame: a<br/>
Frame: b<br/>
Frame:&#160;x<br/>
Frame: a<br/>
Frame: b<br/>
Frame:&#160;x<br/>
Slot 1<br/>
Slot 2<br/>
Slot 3<br/>
Slot 1<br/>
Slot 2<br/>
...<br/>
Real-time<br/>
t1<br/>
t2<br/>
t3<br/>
t4<br/>
t5<br/>
t6<br/>
Communication Cycle<br/>
Next Communication&#160;Cycle<br/>
<b>Figure 42: Communication by&#160;slot definition</b><br/>
<hr/>
<a name=53></a>1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
55<br/>
In&#160;the&#160;first communication cycle, node K&#160;sends&#160;frame a in slot 1.&#160;The scheduling is also stored&#160;<br/>in&#160;the software of&#160;nodes&#160;L&#160;and M.&#160;Therefore,&#160;the&#160;contents of&#160;frame a are passed&#160;to&#160;the next&#160;<br/>higher&#160;communication levels.&#160;<br/>
Scheduling&#160;is&#160;consolidated&#160;in&#160;a description&#160;file.&#160;This&#160;is&#160;not a DBC&#160;file, as in&#160;the case of&#160;CAN,&#160;<br/>rather&#160;it&#160;is a&#160;FIBEX&#160;file.&#160;FIBEX&#160;stands&#160;for&#160;“Field Bus Exchange&#160;Format”&#160;and&#160;could&#160;also&#160;be&#160;<br/>used&#160;for&#160;other&#160;bus&#160;systems.&#160;However, its&#160;current use&#160;is&#160;practically&#160;restricted&#160;to&#160;the descrip­<br/>tion of&#160;the&#160;FlexRay&#160;bus.&#160;FIBEX&#160;is an&#160;XML&#160;format and&#160;the&#160;XCP­on­FlexRay&#160;specification&#160;<br/>relates&#160;to FIBEX&#160;Version 1.1.5 and FlexRay&#160;specification&#160;Version 2.1.<br/>
<b>Cycles</b><br/>
<b>Slot</b><br/>
<b>ECU</b><br/>
<b>Channel</b><br/>
<b>0</b><br/>
<b>1</b><br/>
<b>2</b><br/>
<b>3</b><br/>
<b>4</b><br/>
<b>5</b><br/>
<b>6</b><br/>
<b>...</b><br/>
<b>63</b><br/>
A<br/>
b&#160;[rep:&#160;1]&#160;<br/>
b&#160;[rep:&#160;1]&#160;<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
&#160;1<br/>
Node&#160;K<br/>
<b>ent</b><br/>
B<br/>
b [rep:&#160;1]&#160;<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
b&#160;[rep:&#160;1]<br/>
<b>egm</b><br/>
A<br/>
c&#160;[rep:&#160;4]<br/>
x&#160;[rep:&#160;2]<br/>
y&#160;[rep:&#160;4]<br/>
x&#160;[rep:&#160;2]<br/>
c&#160;[rep:&#160;4]<br/>
x&#160;[rep:&#160;2]<br/>
y&#160;[rep:&#160;4]<br/>
x&#160;[rep:&#160;2]<br/>
&#160;2<br/>
Node&#160;M<br/>
B<br/>
<b>tatic&#160;S</b><br/>
A<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a [rep:&#160;1]&#160;<br/>
a&#160;[rep:&#160;1]<br/>
<b>S</b><br/>
&#160;3<br/>
Node&#160;L<br/>
B<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d [rep:&#160;1]&#160;<br/>
d&#160;[rep:&#160;1]<br/>
Node&#160;L<br/>
A<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n [rep:&#160;1]&#160;<br/>
n&#160;[rep:&#160;1]<br/>
&#160;4<br/>
Node&#160;O<br/>
B<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]&#160;<br/>
m&#160;[rep:&#160;1]<br/>
Node&#160;N<br/>
A<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r [rep:&#160;1]&#160;<br/>
r&#160;[rep:&#160;1]<br/>
<b>ent</b><br/>
&#160;5<br/>
B<br/>
<b>egm</b><br/>
A<br/>
&#160;6<br/>
<b>ic&#160;S</b><br/>
Node&#160;K<br/>
B<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
o&#160;[rep:&#160;1]<br/>
Node&#160;M<br/>
A<br/>
t&#160;[rep:&#160;2]<br/>
p&#160;[rep:&#160;4]<br/>
t&#160;[rep:&#160;2]<br/>
t&#160;[rep:&#160;2]<br/>
p&#160;[rep:&#160;4]<br/>
t&#160; [rep:&#160;2]<br/>
<b>ynam<br/>D</b><br/>
B<br/>
Node&#160;L<br/>
A<br/>
&#160;u&#160;[rep:&#160;4]&#160;<br/>
&#160;u&#160;[rep:&#160;4]<br/>
&#160;7<br/>
Node&#160;L<br/>
B<br/>
v&#160;[rep:&#160;8]<br/>
A<br/>
Node&#160;O<br/>
B<br/>
w&#160;[rep:&#160;4]&#160;<br/>
w&#160;[rep:&#160;4]<br/>
<b>Figure 43: Representation of&#160;a FlexRay&#160;communication matrix</b><br/>
Another&#160;format&#160;for&#160;describing&#160;bus communication has&#160;been&#160;defined as a result of&#160;the devel­<br/>opment of&#160;AUTOSAR solutions:&#160;the&#160;AUTOSAR Description File,&#160;which is available in&#160;XML&#160;for­<br/>mat.&#160;The definition of&#160;XCP­on­FlexRay&#160;was&#160;taken&#160;into account in&#160;the&#160;AUTOSAR 4.0 specifi­<br/>cation.&#160;However, at&#160;the&#160;time of&#160;publication of&#160;this&#160;book&#160;this&#160;specification has not&#160;yet been&#160;<br/>officially&#160;approved and&#160;therefore it&#160;will not be discussed&#160;further.&#160;<br/>
Due&#160;to other&#160;properties&#160;of&#160;the&#160;FlexRay&#160;bus, it is&#160;not sufficient&#160;to just give&#160;the slot number&#160;as&#160;<br/>a reference&#160;to&#160;the&#160;contents.&#160;One&#160;reason is&#160;that multiplexing&#160;is supported:&#160;whenever&#160;a cycle&#160;<br/>is repeated,&#160;the&#160;transmitted contents are not necessarily&#160;the&#160;same. Multiplexing might spec­<br/>ify&#160;that a certain piece of&#160;information is only&#160;sent in&#160;the&#160;slot in every&#160;second pass.&#160;<br/>
<hr/>
<a name=54></a>56<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Instead of&#160;indicating&#160;the&#160;pure slot number, “FlexRay&#160;Data Link&#160;Layer&#160;Protocol Data Unit&#160;<br/>Identifiers” (FLX_LPDU_ID) are used,&#160;which&#160;can be&#160;understood as a&#160;type of&#160;generalized Slot&#160;<br/>ID. Four&#160;pieces&#160;of&#160;information are needed&#160;to describe such&#160;an LPDU:<br/>&gt;&#160;&#160;FlexRay&#160;Slot Identifier&#160;(FLX_SLOT_ID)<br/>&gt;&#160;&#160;Cycle Counter&#160;Offset (OFFSET)<br/>&gt;&#160;&#160;Cycle Counter&#160;Repetition (CYCLE_REPETITION)<br/>&gt;&#160;&#160;FlexRay&#160;Channel&#160;(FLX_CHANNEL)<br/>
<b>LPDU_ID</b><br/>
...<br/>
Channel&#160;A<br/>
...&#160;...<br/>
Channel B<br/>
ycle ID<br/>C&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.<br/>
&#160; .&#160;&#160;.&#160;.&#160;...<br/>
.<br/>
.&#160;.&#160;.&#160;.&#160;.<br/>
.&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..<br/>
..&#160;..&#160;..&#160;..&#160;..<br/>
..&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;&#160; .&#160;&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.<br/>
.&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..<br/>
.<br/>
...<br/>
.&#160;..&#160;..&#160;..&#160;..<br/>
...&#160;...<br/>
...&#160;...<br/>
...<br/>
<b>Figure 44:&#160;</b><br/>
Slot ID<br/>
<b>Representation&#160;of&#160;the&#160;<br/>FlexRay&#160;LPDUs</b><br/>
Scheduling&#160;also&#160;has&#160;effects&#160;on&#160;the&#160;use&#160;of&#160;XCP on FlexRay, because&#160;it defines&#160;what is sent&#160;<br/>precisely.&#160;This&#160;cannot be readily&#160;defined in&#160;XCP;&#160;not until&#160;the measurement runtime does&#160;the&#160;<br/>user&#160;define&#160;which&#160;measured&#160;values&#160;are sent by&#160;assembling&#160;signals.&#160;This means&#160;that it is only&#160;<br/>possible&#160;to&#160;choose&#160;which aspect of&#160;XCP communication can be used&#160;in&#160;which&#160;LPDU:&#160;CTO or&#160;<br/>DTO&#160;from Master&#160;to Slave or&#160;from Slave&#160;to Master.<br/>
The&#160;following&#160;example illustrates&#160;this&#160;process:&#160;the&#160;XCP Master&#160;may&#160;send a&#160;command (CMD)&#160;<br/>in slot n and Slave&#160;A&#160;gives&#160;the&#160;response&#160;(RES) in slot n + 2.&#160;XCP­on­FlexRay&#160;messages&#160;are&#160;<br/>always defined&#160;using&#160;LPDUs.<br/>
The&#160;A2L&#160;description&#160;file&#160;is needed&#160;for&#160;access&#160;to internal ECU parameters;&#160;the objects&#160;with&#160;<br/>their&#160;addresses&#160;in&#160;the ECU are defined&#160;in&#160;this&#160;file. In addition,&#160;the FIBEX&#160;file&#160;is&#160;necessary,&#160;so&#160;<br/>that&#160;the&#160;XCP Master&#160;knows&#160;which LPDUs&#160;it may&#160;send&#160;and&#160;to&#160;which LPDUs&#160;the&#160;XCP Slaves&#160;<br/>send&#160;their&#160;responses.&#160;Communication&#160;between&#160;XCP Master&#160;and&#160;XCP Slave(s) can only&#160;func­<br/>tion&#160;through&#160;combination of&#160;the&#160;two&#160;files,&#160;i.e. by&#160;having&#160;an&#160;A2L&#160;file reference a FIBEX&#160;file.<br/>
<hr/>
<a name=55></a>1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
57<br/>
Excerpt of&#160;an&#160;A2L&#160;with&#160;XCP­on­FlexRay&#160;parameter&#160;setting:<br/>&#160;…<br/>/begin&#160;XCP_ON_FLX<br/>&#160;…&#160;<br/>„XCPsim.xml“<br/>„Cluster_1“<br/>&#160;…&#160;<br/>
In this&#160;example,&#160;“XCPsim.xml”&#160;is the&#160;reference from the&#160;A2L&#160;file to the&#160;FIBEX&#160;file.&#160;<br/>
<b>XCP-dedicated LPDU_IDs</b><br/>
...<br/>
Channel&#160;A<br/>
...&#160;...<br/>
Channel B<br/>
ycle ID<br/>C&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.<br/>
&#160; .&#160;&#160;.&#160;.&#160;...<br/>
.<br/>
.&#160;.&#160;.&#160;.&#160;.<br/>
.&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..<br/>
..&#160;..&#160;..&#160;..&#160;..<br/>
..&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;&#160; .&#160;&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.&#160;.<br/>
.&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..&#160;..<br/>
.<br/>
...<br/>
.&#160;..&#160;..&#160;..&#160;..<br/>
...&#160;...<br/>
...&#160;...<br/>
<b>Figure 45:&#160;</b><br/>
...<br/>
<b>Allocation&#160;of&#160;XCP&#160;</b><br/>
Slot ID<br/>
<b>communication&#160;</b><br/>
<b>to LPDUs</b><br/>
You can read&#160;more&#160;details&#160;about&#160;XCP on&#160;FlexRay&#160;in&#160;CANape’s Online Help. Supplied&#160;with&#160;<br/>CANape is&#160;the&#160;FIBEX&#160;Viewer,&#160;which lets users conveniently&#160;view&#160;the scheduling. It is easy&#160;to&#160;<br/>allocate&#160;the&#160;XCP messages&#160;to&#160;the&#160;LPDUs&#160;by&#160;making&#160;driver&#160;settings&#160;for&#160;the&#160;XCP­on­FlexRay&#160;<br/>device in CANape.<br/>
The&#160;protocol is&#160;explained&#160;in&#160;detail in&#160;ASAM&#160;XCP on&#160;FlexRay&#160;Part 3&#160;Transport Layer&#160;Specifi­<br/>cation.&#160;You&#160;will&#160;find&#160;an&#160;XCP­on­FlexRay&#160;demo in&#160;CANape&#160;with&#160;the&#160;virtual ECU&#160;XCPsim.&#160;The&#160;<br/>demo requires&#160;real&#160;Vector&#160;FlexRay&#160;hardware.<br/>
<b>1.4.4 Ethernet</b><br/>
XCP&#160;on Ethernet&#160;can be used&#160;with either&#160;TCP/IP&#160;or&#160;UDP/IP.&#160;TCP&#160;is&#160;a&#160;protected&#160;transport&#160;<br/>protocol on Ethernet, in&#160;which&#160;the handshake method is used&#160;to detect any&#160;loss of&#160;a packet.&#160;<br/>In&#160;case&#160;of&#160;packet loss,&#160;TCP organizes&#160;a repetition of&#160;the&#160;packet. UDP does&#160;not offer&#160;this pro­<br/>tection mechanism. If&#160;a&#160;packet is&#160;lost,&#160;UDP does not offer&#160;any&#160;mechanisms&#160;for&#160;repeated&#160;<br/>sending&#160;of&#160;the&#160;lost packet on&#160;the&#160;protocol level.&#160;<br/>
Not only&#160;can&#160;XCP on&#160;Ethernet be&#160;used&#160;with&#160;real&#160;ECUs, it can&#160;also be used&#160;for&#160;measurement&#160;<br/>and calibration of&#160;virtual&#160;ECUs.&#160;Here,&#160;a&#160;virtual&#160;ECU&#160;is understood&#160;as&#160;the use of&#160;code&#160;that&#160;<br/>would other&#160;wise&#160;run&#160;in&#160;the&#160;ECU as&#160;an&#160;executable&#160;program (e.g. DLL) on&#160;the PC. Entirely&#160;dif­<br/>ferent resources&#160;are available here compared&#160;to an ECU (CPU, memory, etc.).&#160;<br/>
<hr/>
<a name=56></a>58<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
But&#160;first&#160;the&#160;actual protocol&#160;will be discussed.&#160;IP packets always contain&#160;the addresses&#160;of&#160;<br/>the&#160;sender&#160;and&#160;receiver.&#160;The&#160;simplest&#160;way&#160;to&#160;visualize&#160;an&#160;IP packet is as a&#160;type&#160;of&#160;letter&#160;that&#160;<br/>contains&#160;the&#160;addresses&#160;of&#160;the&#160;recipient and&#160;the&#160;sender.&#160;The&#160;addresses of&#160;individual nodes&#160;<br/>must always be unique.&#160;A&#160;unique address&#160;comprises&#160;the&#160;IP address and port number.&#160;<br/>
<b>XCP on Ethernet (TCP/IP and UDP/IP) Message (Frame)</b><br/>
XCP Header<br/>
XCP Packet<br/>
XCP Tail<br/>
empty for Ethernet<br/>
(TCP/IP and UDP/IP)<br/>
LEN<br/>
CTR<br/>
PID&#160;FILL&#160;DAQ<br/>
TIMESTAMP<br/>
DATA<br/>
Control Field<br/>
Length (LEN)<br/>
Control Field<br/>
for Ethernet<br/>
empty for Ethernet<br/>
(TCP/ IP and UDP/IP) &#160;<br/>
(TCP&amp;IP and UDP&amp;IP)<br/>
<b>Figure 46:&#160;XCP packet&#160;with&#160;TCP/IP&#160;or&#160;UDP/IP</b><br/>
The&#160;header&#160;consists&#160;of&#160;a Control Field&#160;with&#160;two&#160;words&#160;in&#160;Intel&#160;format (=&#160;four&#160;bytes).&#160;These&#160;<br/>words&#160;contain&#160;the&#160;length&#160;(LEN) and a counter&#160;(CTR). LEN indicates&#160;the&#160;number&#160;of&#160;bytes in&#160;<br/>the&#160;XCP packet.&#160;The&#160;CTR&#160;is used&#160;to detect&#160;the packet loss.&#160;UDP/IP&#160;is not a protected proto­<br/>col. If&#160;a packet is lost,&#160;this&#160;is not recognized by&#160;the&#160;protocol layer. Packet loss is monitored by&#160;<br/>counter&#160;information.&#160;When&#160;the&#160;Master&#160;sends its&#160;first message&#160;to&#160;the Slave, it generates a&#160;<br/>counter&#160;number&#160;that is incremented&#160;with each&#160;additional&#160;transmission of&#160;a&#160;frame.&#160;The Slave&#160;<br/>responds&#160;with&#160;the&#160;same pattern:&#160;It increments its own counter&#160;with each&#160;frame&#160;that it&#160;<br/>sends.&#160;The&#160;counters of&#160;the&#160;Slave and&#160;the&#160;Master&#160;operate independently&#160;of&#160;one another.&#160;<br/>UDP/IP is&#160;well suited&#160;for&#160;sending&#160;measured&#160;values.&#160;If&#160;a packet is lost,&#160;then&#160;the measured&#160;<br/>&#160;values&#160;it contains&#160;are&#160;lost, resulting&#160;in&#160;a measurement gap. If&#160;this occurs infrequently,&#160;the&#160;<br/>loss&#160;might just be&#160;ignored.&#160;But if&#160;the&#160;measured&#160;data is&#160;to be&#160;used as&#160;the&#160;basis&#160;for&#160;fast con­<br/>trol, it might be advisable&#160;to use&#160;TCP/IP.<br/>
An&#160;Ethernet&#160;packet can&#160;transport multiple&#160;XCP packets, but an&#160;XCP packet may&#160;never&#160;<br/>exceed&#160;the&#160;limits&#160;of&#160;a UDP/IP packet. In&#160;the&#160;case&#160;of&#160;XCP on&#160;Ethernet,&#160;there is no “Tail”, i.e.&#160;<br/>an empty&#160;control&#160;field.<br/>
<hr/>
<a name=57></a>1.4&#160;XCP&#160;Transport&#160;Layers&#160;<br/>
59<br/>
<b>Detection&#160;of&#160;XCP-on-Ethernet&#160;Slaves</b><br/>
With&#160;version 1.3 of&#160;the&#160;XCP standard, an expansion&#160;for&#160;XCP Slave detection&#160;was defined&#160;<br/>specifically&#160;for&#160;XCP on Ethernet.&#160;<br/>The&#160;Master&#160;can detect&#160;the&#160;XCP Slaves&#160;using&#160;the&#160;GET_SLAVE_ID command. Here,&#160;the&#160;&#160;Master&#160;<br/>broadcasts a multicast message&#160;(IPv4)&#160;with&#160;the IP address&#160;239.255.0.0&#160;on port 5556.&#160;<br/>Regardless&#160;of&#160;whether&#160;or&#160;not an&#160;XCP Slave already&#160;has&#160;a connection&#160;to a Master,&#160;the Slave&#160;<br/>must process&#160;the&#160;request&#160;and return a response.&#160;<br/>
The&#160;response&#160;of&#160;the&#160;Slave contains, among&#160;other&#160;things:<br/>&gt;&#160;&#160;The&#160;IP address&#160;(IPv4)<br/>&gt;&#160;&#160;The&#160;port number&#160;<br/>&gt;&#160;&#160;TCP, UDP or&#160;both<br/>&gt;&#160;&#160;Information on&#160;the&#160;status of&#160;whether&#160;or&#160;not&#160;there is already&#160;a connection&#160;to an&#160;XCP&#160;<br/>
Master<br/>
You&#160;will&#160;find&#160;more&#160;detailed&#160;information on&#160;the&#160;protocol in&#160;ASAM&#160;XCP on Ethernet Part 3&#160;<br/>Transport&#160;Layer&#160;Specification.&#160;In CANape,&#160;you&#160;will&#160;also&#160;find an&#160;XCP&#160;on&#160;Ethernet&#160;demo&#160;with&#160;<br/>the&#160;virtual ECU&#160;XCPsim or&#160;with&#160;virtual ECUs in&#160;the&#160;form of&#160;DLLs,&#160;which have been imple­<br/>mented by&#160;Simulink&#160;models&#160;and&#160;the Simulink&#160;Coder.<br/>
<b>1.4.5 SxI&#160;</b><br/>
SxI is&#160;a collective&#160;term&#160;for&#160;SPI or&#160;SCI. Since&#160;they&#160;are&#160;not buses, but instead are controller&#160;<br/>interfaces&#160;which&#160;are only&#160;suited&#160;for&#160;point­to­point connections,&#160;there is no addressing in&#160;this&#160;<br/>type of&#160;transmission.&#160;The&#160;communication between&#160;any&#160;two nodes&#160;runs either&#160;synchronously&#160;<br/>or&#160;asynchronously.<br/>
<b>XCP on Sxl Message (Frame)</b><br/>
XCP Header<br/>
XCP Packet<br/>
XCP Tail<br/>
LEN<br/>
CTR<br/>
PID&#160;FILL&#160;DAQ<br/>
TIMESTAMP<br/>
DATA<br/>
FILL<br/>
CS<br/>
Control Field<br/>
Length (LEN)<br/>
Control Field<br/>
for SxI&#160;<br/>
for SxI<br/>
Checksum (CS)<br/>
<b>Figure 47:&#160;XCP-on-SxI packet</b><br/>
The&#160;XCP header&#160;consists of&#160;a control&#160;field&#160;with&#160;two pieces&#160;of&#160;information:&#160;the length LEN&#160;<br/>and&#160;the&#160;counter.&#160;The&#160;length of&#160;these&#160;parameters may&#160;be in bytes&#160;or&#160;words (Intel&#160;format).&#160;<br/>LEN&#160;indicates&#160;the number&#160;of&#160;bytes&#160;of&#160;the&#160;XCP&#160;packet.&#160;The CTR&#160;is&#160;used&#160;to&#160;detect&#160;the loss&#160;of&#160;<br/>a&#160;packet.&#160;This is&#160;monitored in&#160;the same&#160;way&#160;as&#160;for&#160;XCP&#160;on Ethernet:&#160;with&#160;counter&#160;informa­<br/>
<hr/>
<a name=58></a>60<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
tion.&#160;Under&#160;certain circumstances&#160;it may&#160;be necessary&#160;to add&#160;fill bytes&#160;to&#160;the packet, e.g.&#160;if&#160;<br/>SPI is used in&#160;WORD or&#160;DWORD mode or&#160;to avoid&#160;the&#160;message being shorter&#160;than&#160;the&#160;<br/>&#160;minimal packet length.&#160;These&#160;fill bytes&#160;are appended&#160;in&#160;the&#160;control&#160;field.<br/>
You&#160;will&#160;find&#160;more detailed information on&#160;the&#160;protocol in&#160;ASAM&#160;XCP on SxI Part 3&#160;Transport&#160;<br/>Layer&#160;Specification.<br/>
<b>1.4.6 USB&#160;</b><br/>
Currently,&#160;XCP on USB&#160;has&#160;no&#160;practical significance.&#160;Therefore, no&#160;further&#160;mention&#160;will be&#160;<br/>made&#160;of&#160;this&#160;topic;&#160;rather&#160;we&#160;refer&#160;you to&#160;ASAM&#160;documents&#160;that describe&#160;the standard:&#160;<br/>ASAM&#160;XCP on USB Part 3&#160;Transport Layer&#160;Specification.<br/>
<b>1.4.7 LIN&#160;</b><br/>
At&#160;this&#160;time,&#160;ASAM&#160;has not&#160;yet defined&#160;an&#160;XCP­on­LIN standard. However,&#160;a&#160;solution exists&#160;<br/>from&#160;Vector&#160;(XCP­on­LIN driver&#160;and CANape as&#160;XCP­on­LIN Master),&#160;which&#160;violates&#160;neither&#160;<br/>the&#160;LIN nor&#160;the&#160;XCP specification&#160;and&#160;is&#160;already&#160;being&#160;used&#160;on&#160;some customer&#160;projects. For&#160;<br/>more detailed information, please&#160;contact&#160;Vector.<br/>
<hr/>
<a name=59></a>1.5 XCP&#160;Services<br/>
61<br/>
<b>1.5&#160;XCP&#160;Services</b><br/>
This&#160;chapter&#160;contains&#160;a listing&#160;and explanation of&#160;other&#160;services&#160;that can be realized over&#160;<br/>XCP.&#160;They&#160;are&#160;all based&#160;on&#160;the&#160;already&#160;described&#160;mechanisms of&#160;communication&#160;with&#160;the&#160;<br/>help&#160;of&#160;CTOs and DTOs.&#160;Some&#160;XCP services&#160;have already&#160;been explained, e.g.&#160;synchronous&#160;<br/>data acquisition/stimulation and read/write access&#160;to device memory.&#160;<br/>The&#160;XCP specification does&#160;indeed&#160;uniquely&#160;define&#160;the&#160;different services; at&#160;the same&#160;time it&#160;<br/>indicates&#160;whether&#160;the service always needs&#160;to&#160;be implemented or&#160;whether&#160;it&#160;is&#160;optional.&#160;For&#160;<br/>example, an&#160;XCP Slave&#160;must support “Connect”&#160;for&#160;the&#160;Master&#160;to set up a connection. On&#160;<br/>the other&#160;hand,&#160;flashing&#160;over&#160;XCP&#160;is not&#160;absolutely&#160;necessary&#160;and&#160;the&#160;XCP&#160;Slave does&#160;not&#160;<br/>need&#160;to support it.&#160;This&#160;simply&#160;depends&#160;on&#160;the&#160;requirements of&#160;the project and&#160;the software.&#160;<br/>All of&#160;the services&#160;described in&#160;this&#160;chapter&#160;are optional.&#160;<br/>
<b>1.5.1&#160;Memory&#160;Page Switching&#160;</b><br/>
As already&#160;explained in&#160;the description&#160;of&#160;calibration concepts,&#160;parameters&#160;are&#160;normally&#160;<br/>located&#160;in&#160;flash&#160;memory&#160;and&#160;are&#160;copied&#160;to RAM as&#160;necessary. Some&#160;calibration concepts&#160;<br/>offer&#160;the&#160;option of&#160;switching&#160;memory&#160;segment pages&#160;from RAM and Flash.&#160;XCP describes a&#160;<br/>somewhat more general, generic approach, in&#160;which&#160;a memory&#160;segment may&#160;contain multi­<br/>ple switchable pages.&#160;Normally,&#160;this&#160;consists of&#160;a RAM page and a&#160;flash page. But multiple&#160;<br/>RAM pages&#160;or&#160;the&#160;lack&#160;of&#160;a&#160;flash&#160;page&#160;are conceivable as&#160;well.&#160;<br/>
For&#160;a&#160;better&#160;understanding&#160;of&#160;the&#160;XCP&#160;commands&#160;for&#160;page switching,&#160;the concepts&#160;of&#160;sec­<br/>tor, segment and page&#160;will be explained&#160;once again&#160;at&#160;this&#160;point.<br/>
XCP access<br/>
Segment 1<br/>
t 1<br/>
Segment 1<br/>
Segment 1<br/>
&#160;2<br/>
Page 0<br/>
Page 1<br/>
Page 2<br/>
egmem<br/>S<br/>
tor<br/>ec<br/>S<br/>
ECU access<br/>
Segment 0<br/>
t 0<br/>
Page 0<br/>
&#160;1<br/>
egmem<br/>S<br/>
tor<br/>ec<br/>S<br/>
&#160;0<br/>tor<br/>ec<br/>
address<br/>
S<br/>
<b>Figure 48:&#160;<br/>Memory&#160;representation</b><br/>
<hr/>
<a name=60></a>62<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
From an&#160;XCP perspective,&#160;the&#160;memory&#160;of&#160;a Slave&#160;consists&#160;of&#160;a continuous memory&#160;that is&#160;<br/>addressed&#160;with&#160;a 40­bit&#160;width.&#160;The&#160;physical layout of&#160;the&#160;memory&#160;is based on sectors.&#160;<br/>Know&#160;ledge&#160;of&#160;the&#160;flash&#160;sectors&#160;is absolutely&#160;necessary&#160;in&#160;flashing, because&#160;the&#160;flash mem­<br/>ory&#160;can only&#160;be erased&#160;a block&#160;at a&#160;time.&#160;<br/>
The&#160;logical structure is based&#160;on&#160;what are known as segments;&#160;they&#160;describe&#160;where calibra­<br/>tion data is located in memory.&#160;The&#160;start address&#160;and parameters of&#160;a segment do not have&#160;<br/>to&#160;be aligned&#160;with&#160;the start&#160;addresses&#160;and parameters of&#160;the physical&#160;sectors.&#160;Each&#160;seg­<br/>ment&#160;can&#160;be&#160;subdivided&#160;into multiple&#160;pages.&#160;The&#160;pages&#160;of&#160;a segment describe&#160;the same&#160;<br/>parameters&#160;at&#160;the&#160;same&#160;addresses.&#160;The&#160;values&#160;of&#160;these&#160;parameters and read/write rights&#160;<br/>can be controlled individually&#160;for&#160;each page.&#160;<br/>
The&#160;allocation&#160;of&#160;an&#160;algorithm&#160;to a page&#160;within&#160;a segment must always be unique. Only&#160;one&#160;<br/>page may&#160;be active in a&#160;segment&#160;at any&#160;given&#160;time.&#160;This page is&#160;known&#160;as&#160;the&#160;“active page&#160;<br/>for&#160;the&#160;ECU in&#160;this&#160;segment.”&#160;The&#160;particular&#160;page&#160;that&#160;the&#160;ECU and&#160;the&#160;XCP driver&#160;actively&#160;<br/>access&#160;can be individually&#160;switched.&#160;No interdependency&#160;exists between&#160;these settings. Sim­<br/>ilar&#160;to&#160;the naming convention&#160;for&#160;the ECU,&#160;the active page&#160;for&#160;XCP&#160;access&#160;is&#160;referred&#160;to&#160;as&#160;<br/>the&#160;“active page&#160;for&#160;XCP access&#160;in&#160;this&#160;segment“.&#160;<br/>
In&#160;turn,&#160;this&#160;applies&#160;to each&#160;individual segment. Segments&#160;must be listed in&#160;the&#160;A2L&#160;file&#160;and&#160;<br/>each&#160;segment gets a number&#160;that is used&#160;to reference&#160;the&#160;segment.&#160;Within an&#160;XCP Slave,&#160;<br/>the&#160;SEGMENT_NUMBER&#160;must always&#160;begin&#160;at 0 and it is&#160;then&#160;incremented in consecutive&#160;<br/>numbers.&#160;Each segment has&#160;at least one&#160;page.&#160;The&#160;pages&#160;are&#160;also referenced by&#160;numbers.&#160;<br/>The&#160;first page&#160;is PAGE 0. One&#160;byte is available&#160;for&#160;the&#160;number, so&#160;that a maximum of&#160;255&#160;<br/>pages&#160;can be defined&#160;per&#160;segment.&#160;<br/>
The Slave must initialize all pages&#160;for&#160;all&#160;segments.&#160;The&#160;Master&#160;uses&#160;the&#160;command&#160;&#160;<br/>GET_CAL_PAGE&#160;to ask&#160;the&#160;Slave&#160;which page&#160;is currently&#160;active&#160;for&#160;the ECU and&#160;which page&#160;<br/>for&#160;XCP access.&#160;It can&#160;certainly&#160;be&#160;the&#160;case&#160;that mutual blocking&#160;may&#160;be necessary&#160;for&#160;the&#160;<br/>accesses.&#160;For&#160;example,&#160;the&#160;XCP Slave&#160;may&#160;not access&#160;a page, if&#160;this page&#160;is currently&#160;active&#160;<br/>for&#160;the&#160;ECU.&#160;As mentioned,&#160;there may&#160;be a dependency&#160;– but not necessarily. It is a question&#160;<br/>of&#160;how&#160;the&#160;Slave has&#160;been&#160;implemented.&#160;<br/>
If&#160;the Slave supports&#160;the&#160;optional commands&#160;GET_CAL_PAGE&#160;and SET_CAL_PAGE, then&#160;it&#160;<br/>also&#160;supports&#160;what is known as page&#160;switching.&#160;These&#160;two commands let&#160;the Master&#160;poll&#160;<br/>which&#160;pages&#160;are currently&#160;being&#160;used and if&#160;necessary&#160;it can switch pages&#160;for&#160;the ECU&#160;and&#160;<br/>XCP access.&#160;The&#160;XCP Master&#160;has&#160;full control over&#160;switching&#160;of&#160;pages.&#160;The&#160;XCP Slave cannot&#160;<br/>initiate&#160;switching&#160;by&#160;itself. But naturally&#160;the&#160;Master&#160;must respect any&#160;restrictions of&#160;the&#160;<br/>Slave implementation.&#160;<br/>
What is&#160;the&#160;benefit of&#160;switching?<br/>First, switching&#160;permits&#160;very&#160;quick&#160;changing of&#160;entire parameter&#160;sets – essentially&#160;a before­<br/>and­after&#160;comparison.&#160;Second,&#160;the plant&#160;remains&#160;in a&#160;stable state,&#160;while&#160;the&#160;calibrator&#160;per­<br/>forms extensive parameter&#160;changes&#160;on another&#160;page&#160;in&#160;the&#160;ECU.&#160;This prevents&#160;the plant&#160;<br/>from going&#160;into a critical or&#160;unstable state, e.g.&#160;due&#160;to incomplete datasets during para­<br/>meter&#160;setting.&#160;<br/>
<hr/>
<a name=61></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-61_1.png"/><br/>
1.5 XCP&#160;Services<br/>
63<br/>
<b>1.5.2&#160;Saving&#160;Memory&#160;Pages – Data Page Freezing&#160;</b><br/>
When&#160;a calibrator&#160;calibrates&#160;parameters on a page,&#160;there is&#160;the conceptual ability&#160;in&#160;XCP&#160;to&#160;<br/>save&#160;the data&#160;directly&#160;in&#160;the ECU.&#160;This involves saving&#160;the data&#160;of&#160;a&#160;RAM&#160;page&#160;to&#160;a&#160;page in&#160;<br/>nonvolatile memory. If&#160;the&#160;nonvolatile&#160;memory&#160;is&#160;flash,&#160;it must be&#160;taken into account&#160;that&#160;<br/>the&#160;segment&#160;start address&#160;and&#160;the&#160;segment size&#160;might not necessarily&#160;agree&#160;with&#160;the&#160;flash&#160;<br/>sectors,&#160;which&#160;represents a problem in erasing&#160;and rewriting&#160;the&#160;flash memory&#160;(see&#160;ASAM&#160;<br/>XCP Part 2 Protocol Layer&#160;Specification).<br/>
<b>1.5.3&#160;Flash&#160;Programming&#160;</b><br/>
Flashing&#160;means&#160;writing&#160;data in&#160;an area of&#160;flash&#160;memory.&#160;This&#160;requires precise knowledge of&#160;<br/>how&#160;the&#160;memory&#160;is&#160;laid out.&#160;A&#160;flash&#160;memory&#160;is&#160;subdivided&#160;into multiple&#160;sectors (physical sec­<br/>tions),&#160;which are described by&#160;a&#160;start&#160;address&#160;and a&#160;length.&#160;To&#160;distinguish&#160;them&#160;from&#160;one&#160;<br/>another,&#160;they&#160;each get&#160;a&#160;consecutive identification number.&#160;One&#160;byte&#160;is&#160;available&#160;for&#160;this&#160;<br/>number, resulting in a maximum of&#160;255 sectors.&#160;<br/>
SECTOR_NUMBER [0, 1, 2 … 255]<br/>
The&#160;information about&#160;the&#160;flash&#160;sectors is also&#160;part of&#160;the&#160;A2L&#160;data set.<br/>
<b>Figure 49:&#160;<br/>Representation&#160;<br/>of&#160;driver&#160;settings&#160;<br/>for&#160;the&#160;flash&#160;area</b><br/>
<hr/>
<a name=62></a>64<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
Flashing&#160;can be implemented using&#160;what are referred&#160;to as “flash kernels”.&#160;A&#160;flash kernel is&#160;<br/>executable code&#160;that is sent&#160;to&#160;the&#160;Slave’s RAM area before&#160;the actual&#160;flashing;&#160;the kernel&#160;<br/>then&#160;handles&#160;communication&#160;with&#160;the&#160;XCP Master. It might contain&#160;the algorithm&#160;that is&#160;<br/>responsible&#160;for&#160;erasing&#160;the&#160;flash memory. For&#160;security&#160;and space reasons,&#160;very&#160;frequently&#160;<br/>this&#160;code&#160;is&#160;not permanently&#160;stored&#160;in&#160;the&#160;ECU’s&#160;flash&#160;memory.&#160;Under&#160;some circumstances,&#160;<br/>a converter&#160;might be used,&#160;e.g.&#160;if&#160;checksum&#160;or&#160;similar&#160;computations need&#160;to be performed.<br/>
Flashing&#160;with&#160;XCP roughly&#160;subdivides&#160;the overall&#160;flash&#160;process&#160;into&#160;three areas:<br/>&gt;&#160;&#160;Preparation (e.g.&#160;for&#160;version control and&#160;therefore&#160;to check&#160;whether&#160;the new&#160;contents&#160;can&#160;<br/>
even&#160;be flashed)<br/>
&gt;&#160;&#160;Execution (the&#160;new&#160;contents are sent&#160;to&#160;the&#160;ECU)&#160;<br/>&gt;&#160;&#160;Post­processing&#160;(e.g.&#160;checksum checking&#160;etc.)<br/>
In&#160;the&#160;XCP&#160;standard,&#160;the&#160;primary&#160;focus is directed&#160;to&#160;the&#160;actual&#160;execution&#160;of&#160;flashing.&#160;Any­<br/>one&#160;who&#160;compares&#160;this&#160;operation to flashing&#160;over&#160;diagnostic&#160;protocols will&#160;discover&#160;that the&#160;<br/>process­specific&#160;elements, such&#160;as serial number&#160;handling&#160;with meta­data, are supported in&#160;<br/>a&#160;rather&#160;spartan&#160;fashion in&#160;XCP.&#160;Flashing&#160;in&#160;the development phase&#160;was clearly&#160;the main&#160;<br/>focus in its definition and not&#160;the&#160;complex&#160;process&#160;steps&#160;that are necessary&#160;in end­of­line&#160;<br/>flashing.<br/>
Therefore,&#160;what is&#160;important in&#160;the&#160;preparation phase&#160;is&#160;to determine&#160;whether&#160;the new&#160;con­<br/>tents are even&#160;relevant&#160;to&#160;the&#160;ECU.&#160;There are no&#160;special&#160;commands&#160;for&#160;version control.&#160;<br/>Rather&#160;the&#160;practice has&#160;been&#160;to support&#160;those&#160;commands&#160;specific&#160;to&#160;the project.&#160;<br/>
The&#160;following&#160;XCP commands&#160;are available:<br/>
PROGRAM_START: Beginning&#160;of&#160;the&#160;flash&#160;procedure<br/>This&#160;command&#160;indicates&#160;the&#160;beginning&#160;of&#160;the&#160;flash&#160;process.&#160;If&#160;the&#160;ECU is in a state&#160;that does&#160;<br/>not permit&#160;flashing&#160;(e.g.&#160;vehicle&#160;speed&#160;&gt; 0),&#160;the&#160;XCP Slave must acknowledge&#160;with an ERRor.&#160;<br/>The&#160;actual&#160;flash&#160;process&#160;may&#160;not begin&#160;until&#160;the&#160;PROGRAM_START&#160;has been successfully&#160;<br/>acknowledged&#160;by&#160;the&#160;Slave.<br/>
PROGRAM_CLEAR: Call&#160;the&#160;current&#160;flash&#160;memory&#160;erasing&#160;routine&#160;<br/>Before&#160;flash&#160;memory&#160;can&#160;be&#160;overwritten&#160;with&#160;new&#160;contents, it must&#160;first be&#160;cleared.&#160;The call&#160;<br/>of&#160;the&#160;erasing&#160;routine&#160;via&#160;this&#160;command&#160;must be&#160;implemented in&#160;the ECU or&#160;be made&#160;avail­<br/>able to the&#160;ECU with the&#160;help&#160;of&#160;the&#160;flash&#160;kernel.<br/>
PROGRAM_FORMAT:&#160;Select the&#160;data format for&#160;the&#160;flash&#160;data&#160;<br/>The&#160;XCP Master&#160;uses&#160;this&#160;command&#160;to define&#160;the&#160;format (e.g.&#160;compressed or&#160;encrypted) in&#160;<br/>which&#160;the&#160;data are&#160;transmitted&#160;to&#160;the&#160;Slave. If&#160;the&#160;command is not sent,&#160;the default setting&#160;<br/>is non­compressed and non­encrypted&#160;transmission.<br/>
PROGRAM:&#160;Transfer&#160;the&#160;data to the&#160;XCP&#160;Slave<br/>For&#160;the&#160;users&#160;who&#160;are&#160;very&#160;familiar&#160;with&#160;flashing&#160;via&#160;diagnostics: this&#160;command&#160;corresponds&#160;<br/>to&#160;TRANSFERDATA&#160;in&#160;diagnostics.&#160;Using&#160;this command, data is&#160;transmitted&#160;to&#160;the&#160;XCP&#160;<br/>Slave,&#160;which&#160;is&#160;then&#160;stored in&#160;flash&#160;memory.<br/>
<hr/>
<a name=63></a>1.5 XCP&#160;Services<br/>
65<br/>
PROGRAM_VERIFY: Request&#160;to check&#160;the&#160;new&#160;flash&#160;contents<br/>The&#160;Master&#160;can request&#160;that&#160;the Slave perform an internal check&#160;to determine&#160;whether&#160;the&#160;<br/>new&#160;contents are OK.&#160;<br/>
PROGRAM_RESET: Reset request&#160;to&#160;the&#160;Slave<br/>Request&#160;by&#160;the&#160;Master&#160;to the&#160;Slave&#160;to&#160;execute&#160;a&#160;Reset.&#160;Afterwards, the&#160;connection to the&#160;<br/>Slave is always&#160;terminated and a new&#160;CONNECT&#160;must be sent.<br/>
<b>1.5.4&#160;Automatic&#160;Detection&#160;of&#160;the&#160;Slave&#160;</b><br/>
The&#160;XCP protocol lets&#160;the&#160;Master&#160;poll&#160;the&#160;Slave about its protocol­specific properties.&#160;A&#160;<br/>number&#160;of&#160;commands&#160;are available&#160;for&#160;this.<br/>
GET_COMM_MODE_INFO<br/>The&#160;response&#160;to&#160;this&#160;command gives&#160;the&#160;Master&#160;information about&#160;the&#160;various communica­<br/>tion&#160;options&#160;of&#160;the&#160;Slave, e.g.&#160;whether&#160;it supports&#160;block&#160;transfer&#160;or&#160;interleaved mode or&#160;<br/>which&#160;minimum&#160;time intervals&#160;the&#160;Master&#160;must maintain between requests in&#160;these modes.&#160;<br/>
GET_STATUS<br/>The&#160;response&#160;to&#160;this&#160;request&#160;returns all current status information of&#160;the Slave.&#160;Which&#160;<br/>resources (calibration,&#160;flashing,&#160;measurement, etc.) are supported?&#160;Are any&#160;types&#160;of&#160;mem­<br/>ory&#160;activities&#160;(DAQ&#160;list configuration, etc.) still running&#160;currently?&#160;Are DTOs (DAQ, STIM)&#160;<br/>being&#160;exchanged&#160;right now?<br/>
GET_DAQ_PROCESSOR_INFO<br/>The&#160;Master&#160;gets general information,&#160;which it needs&#160;to know&#160;about&#160;the Slave limitations:&#160;<br/>number&#160;of&#160;predefined&#160;DAQ&#160;lists, available DAQ lists and events, etc.<br/>
GET_DAQ_RESOLUTION_INFO<br/>Other&#160;information about&#160;the&#160;DAQ&#160;capabilities&#160;of&#160;the&#160;Slave is exchanged&#160;via&#160;this command:&#160;<br/>maximum number&#160;of&#160;parameters&#160;for&#160;an ODT&#160;for&#160;DAQ and&#160;for&#160;STIM, granularity&#160;of&#160;the ODT&#160;<br/>entries,&#160;number&#160;of&#160;bytes&#160;in&#160;timestamp&#160;transmission, etc.<br/>
GET_DAQ_EVENT_INFO<br/>When&#160;this command is used,&#160;the call&#160;is made once per&#160;ECU&#160;event.&#160;Information&#160;is&#160;transmit­<br/>ted here&#160;on&#160;whether&#160;the&#160;event can be&#160;used&#160;for&#160;DAQ, STIM&#160;or&#160;DAQ/STIM,&#160;whether&#160;the event&#160;<br/>occurs periodically&#160;and if&#160;so&#160;which cycle&#160;time it has,&#160;etc.<br/>
<hr/>
<a name=64></a>66<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.5.5&#160;Block&#160;Transfer&#160;Mode&#160;for&#160;Upload,&#160;Download&#160;and Flashing&#160;</b><br/>
In&#160;the&#160;“normal” communication&#160;mode, each command&#160;from&#160;the&#160;Master&#160;is acknowledged by&#160;<br/>a response&#160;of&#160;the&#160;Slave. However, in&#160;some&#160;cases&#160;it may&#160;be&#160;desirable,&#160;for&#160;performance rea­<br/>sons,&#160;to use&#160;what is referred&#160;to as&#160;the&#160;block&#160;transfer&#160;mode.&#160;<br/>
Master<br/>
Slave<br/>
Request&#160;k<br/>
Part1<br/>
Part2<br/>
MIN_ST<br/>
Part3<br/>
MAX_BS<br/>
Response&#160;k<br/>
Request&#160;k+1<br/>
Time<br/>
<b>Figure 50:&#160;<br/>Representation of&#160;the block&#160;transfer&#160;mode</b><br/>
The&#160;use&#160;of&#160;such&#160;a method accelerates&#160;the&#160;procedure&#160;when&#160;transmitting large amounts of&#160;<br/>data (UPLOAD, SHORT_UPLOAD, DOWNLOAD, SHORT_DOWNLOAD and PROGRAM).&#160;The&#160;<br/>Master&#160;can&#160;find&#160;out&#160;whether&#160;the Slave supports&#160;this&#160;method&#160;with&#160;the request GET_COMM_<br/>MODE_INFO.&#160;You&#160;will&#160;find&#160;more on&#160;this&#160;in&#160;ASAM&#160;XCP Part 2 Protocol Layer&#160;Specification.<br/>
<hr/>
<a name=65></a>1.5 XCP&#160;Services<br/>
67<br/>
<b>1.5.6&#160;Cold&#160;Start&#160;Measurement&#160;(during&#160;Power-On)&#160;</b><br/>
Even&#160;with&#160;the&#160;capabilities&#160;of&#160;XCP described&#160;to&#160;this&#160;point, it&#160;would be impossible&#160;to imple­<br/>ment an event­driven&#160;measurement&#160;that can in&#160;practice&#160;be&#160;executed early&#160;in&#160;the&#160;ECU’s start&#160;<br/>phase.&#160;The&#160;reason is&#160;that&#160;the&#160;measurement must be configured before&#160;the actual measure­<br/>ment&#160;takes&#160;place. If&#160;one&#160;attempts&#160;to do&#160;this,&#160;the&#160;ECU’s&#160;start phase has long&#160;been over&#160;by&#160;<br/>the&#160;time the&#160;first&#160;measured&#160;values&#160;are&#160;transmitted.&#160;The&#160;approach that&#160;is&#160;used to&#160;overcome&#160;<br/>this&#160;problem is based&#160;on a simple idea.&#160;<br/>
It involves&#160;separating&#160;the&#160;configuration and&#160;the&#160;measurement in&#160;time.&#160;After&#160;the configura­<br/>tion phase,&#160;the&#160;measurement is&#160;not started&#160;immediately; rather&#160;the ECU is shut down.&#160;After&#160;<br/>a reboot,&#160;the&#160;XCP Slave&#160;accesses&#160;the&#160;existing&#160;configuration&#160;directly&#160;and immediately&#160;begins&#160;<br/>to send&#160;the&#160;first messages.&#160;The&#160;difficulties&#160;associated&#160;with&#160;this&#160;are obvious:&#160;the configura­<br/>tion of&#160;the&#160;DAQ&#160;lists is stored in RAM,&#160;and&#160;therefore&#160;the&#160;information no longer&#160;exists after&#160;<br/>a reboot.&#160;<br/>
To enable&#160;what is known as&#160;the RESUME mode&#160;to enable&#160;a Cold&#160;Start Measurement, a&#160;non­<br/>volatile&#160;memory&#160;is&#160;needed&#160;in&#160;the&#160;XCP Slave&#160;which&#160;preserves&#160;its data even&#160;when it is not&#160;<br/>being&#160;supplied&#160;with power. EEPROMs&#160;are used&#160;in&#160;this&#160;method. In&#160;this context, it is&#160;irrelevant&#160;<br/>whether&#160;it is a real EEPROM or&#160;one&#160;that is emulated by&#160;a&#160;flash&#160;memory.<br/>
You&#160;will&#160;find more details in&#160;ASAM&#160;XCP&#160;Part 1&#160;Overview&#160;Specification&#160;in&#160;the&#160;chapter&#160;1.4.2.2&#160;<br/>“Advanced Features”.<br/>
<hr/>
<a name=66></a>68<br/>
1 Fundamentals of&#160;the&#160;XCP Protocol<br/>
<b>1.5.7 Security&#160;Mechanisms&#160;with&#160;XCP&#160;</b><br/>
An unauthorized user&#160;should be prevented as much as possible&#160;from being able&#160;to make a&#160;<br/>connection&#160;to an&#160;ECU.&#160;The&#160;“seed &amp; key” method is&#160;available&#160;for&#160;checking&#160;whether&#160;or&#160;not a&#160;<br/>connection&#160;attempt is&#160;authorized.&#160;The&#160;three&#160;different access&#160;types can be protected by&#160;seed&#160;<br/>&amp; key: measurement / stimulation, calibration and&#160;flashing.<br/>
The&#160;“seed &#160;&amp; &#160;key” method operates&#160;as&#160;follows:&#160;in&#160;the&#160;connect request by&#160;the Master,&#160;the&#160;<br/>Slave sends&#160;a random number&#160;(= seed)&#160;to&#160;the&#160;Master. Now,&#160;the Master&#160;must use an algo­<br/>rithm&#160;to generate&#160;a response&#160;(= key).&#160;The&#160;key&#160;is&#160;sent&#160;to&#160;the&#160;Slave.&#160;The Slave also computes&#160;<br/>the&#160;expected response&#160;and compares&#160;the&#160;key&#160;of&#160;the&#160;Master&#160;with&#160;its own result. If&#160;the&#160;two&#160;<br/>results agree, both&#160;the&#160;Master&#160;and Slave have used&#160;the&#160;same algorithm.&#160;Then&#160;the Slave&#160;<br/>accepts&#160;the&#160;connection&#160;to&#160;the&#160;Master. If&#160;there is no&#160;agreement,&#160;the Slave declines commu­<br/>nication with the&#160;Master.<br/>
Normally,&#160;the&#160;algorithm is&#160;available&#160;as a DLL&#160;in&#160;the&#160;Master. So, if&#160;a user&#160;has&#160;the “seed &amp; key”&#160;<br/>DLL&#160;and the&#160;A2L&#160;file, nothing&#160;stands&#160;in&#160;the&#160;way&#160;of&#160;accessing&#160;the&#160;ECU’s memory.&#160;When&#160;the&#160;<br/>ECU is&#160;approaching&#160;a production&#160;launch,&#160;the&#160;XCP driver&#160;is&#160;often deactivated.&#160;A&#160;unique&#160;<br/>sequence of&#160;individual diagnostic commands&#160;is usually&#160;used&#160;to restore&#160;XCP access&#160;to&#160;the&#160;<br/>ECU.&#160;This&#160;makes&#160;the&#160;XCP driver&#160;largely&#160;available even&#160;in production&#160;vehicles, but it is nor­<br/>mally&#160;deactivated&#160;to protect against&#160;unauthorized manipulation of&#160;the ECU (see&#160;ASAM&#160;XCP&#160;<br/>Part 2 Protocol Layer&#160;Specification).&#160;<br/>
Whether&#160;or&#160;not seed&#160;&amp; key&#160;or&#160;deactivation of&#160;the&#160;XCP driver&#160;is used in a project is implemen­<br/>tation­specific&#160;and independent of&#160;the&#160;XCP specification.&#160;<br/>
<hr/>
<a name=67></a>2 ECU Description File&#160;A2L<br/>
71<br/>
<b>2 ECU Description&#160;File&#160;A2L&#160;</b><br/>
<hr/>
<a name=68></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-68_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-68_2.png"/><br/>
72<br/>
2 ECU Description File&#160;A2L<br/>
One&#160;reason&#160;why&#160;an&#160;A2L&#160;file&#160;is&#160;needed&#160;has&#160;already&#160;been&#160;named:&#160;to allocate symbolic names&#160;<br/>to addresses.&#160;For&#160;example, if&#160;a software developer&#160;has&#160;implemented a PID controller&#160;and&#160;<br/>assigned&#160;the&#160;names&#160;P1, I1 and D1 in his&#160;application&#160;for&#160;the&#160;proportional, integral and differ­<br/>ential components,&#160;then&#160;the&#160;calibrator&#160;should be able&#160;to access&#160;these parameters&#160;with&#160;their&#160;<br/>symbolic names. Let us&#160;take&#160;the&#160;following&#160;figure as an example:<br/>
<b>Figure 51:&#160;<br/>Parameters in a calibration&#160;window</b><br/>
The&#160;user&#160;can conveniently&#160;modify&#160;values&#160;using&#160;symbolic names.&#160;Another&#160;example is provided&#160;<br/>by&#160;viewing&#160;signal&#160;variables&#160;that are measured&#160;from&#160;the&#160;ECU:<br/>
<b>Figure 52: Signal response over&#160;time</b><br/>
In&#160;the legend,&#160;the user&#160;can read&#160;the logical&#160;names of&#160;the signals.&#160;The addresses&#160;at&#160;which&#160;the&#160;<br/>parameters&#160;were located in&#160;the&#160;ECU are of&#160;secondary&#160;importance in&#160;the offline analysis of&#160;<br/>values.&#160;Naturally,&#160;the&#160;correct address&#160;is needed&#160;to request&#160;the&#160;values in&#160;the ECU, but&#160;the&#160;<br/>numeric&#160;value of&#160;the&#160;address&#160;itself&#160;is of&#160;no&#160;importance&#160;to&#160;the&#160;user.&#160;The user&#160;uses&#160;the logical&#160;<br/>name&#160;for&#160;selection and&#160;visualization purposes.&#160;That is,&#160;the&#160;user&#160;selects&#160;the object by&#160;its&#160;<br/>name and&#160;the&#160;XCP Master&#160;looks&#160;for&#160;the&#160;associated address&#160;and data&#160;type in&#160;the&#160;A2L.<br/>
<hr/>
<a name=69></a>2 ECU Description File&#160;A2L<br/>
73<br/>
Another&#160;attribute&#160;of&#160;a parameter&#160;might be&#160;the&#160;definition&#160;of&#160;a minimum or&#160;maximum&#160;value.&#160;<br/>The&#160;value&#160;of&#160;the&#160;object would then&#160;have to&#160;lie within&#160;these&#160;limits.&#160;Imagine that&#160;you&#160;as the&#160;<br/>software developer&#160;define&#160;a parameter&#160;that has&#160;a direct effect on a power&#160;output stage.&#160;<br/>You must now&#160;prevent&#160;the&#160;user&#160;–&#160;whatever&#160;the&#160;user’s&#160;reasons&#160;might be&#160;–&#160;from configuring&#160;<br/>the&#160;output stage&#160;that&#160;would result in catastrophic damage.&#160;You can accomplish&#160;this by&#160;<br/>defining&#160;minimum and maximum&#160;values&#160;in&#160;the&#160;A2L&#160;to limit&#160;the&#160;permitted&#160;values.&#160;<br/>
Rules&#160;for&#160;conversion between&#160;physical and raw&#160;values&#160;are also&#160;defined in&#160;the&#160;A2L.&#160;You&#160;can&#160;<br/>visualize a simple example of&#160;such a conversion rule in a sensor&#160;that has an 8­bit&#160;value.&#160;The&#160;<br/>numeric&#160;values&#160;output by&#160;the&#160;sensor&#160;lie&#160;between&#160;0 and&#160;255, but&#160;you&#160;wish&#160;to see&#160;the&#160;value as&#160;<br/>a percentage&#160;value. Mapping&#160;of&#160;the sensor&#160;value [0 … 255]&#160;to [0 … 100 %] is performed&#160;with&#160;<br/>a conversion&#160;rule,&#160;which&#160;in&#160;turn is&#160;stored in&#160;the&#160;A2L. If&#160;an&#160;object is measured,&#160;which exists as&#160;<br/>a raw&#160;value&#160;in&#160;the&#160;ECU and&#160;is&#160;also&#160;transmitted&#160;as&#160;such,&#160;the&#160;measurement and calibration&#160;<br/>tool uses&#160;the&#160;stored&#160;formula and&#160;visualizes&#160;the&#160;physical&#160;value.<br/>
Besides&#160;scalar&#160;parameters, characteristic curves&#160;and maps&#160;are&#160;frequently&#160;used. Some might&#160;<br/>utilize a proximity&#160;sensor&#160;such&#160;as a Hall sensor,&#160;which&#160;determines distance as a&#160;function of&#160;<br/>magnetic&#160;field&#160;strength&#160;and&#160;you may&#160;wish&#160;to use&#160;this&#160;distance&#160;value in&#160;your&#160;algorithm.&#160;The&#160;<br/>magnetic&#160;field&#160;and distance&#160;value do not run linear&#160;to one&#160;another.&#160;This nonlinearity&#160;of&#160;<br/>&#160;values&#160;would make&#160;formulation&#160;of&#160;the&#160;algorithm unnecessarily&#160;difficult.&#160;With&#160;the help of&#160;a&#160;<br/>characteristic curve,&#160;you can&#160;first linearize&#160;the&#160;values&#160;before&#160;you input&#160;the&#160;values into&#160;your&#160;<br/>algorithm as input&#160;variables.<br/>
Another&#160;application area&#160;for&#160;characteristic maps is&#160;their&#160;use&#160;as substitutes&#160;for&#160;complex&#160;<br/>computations.&#160;For&#160;example, if&#160;there is a relationship&#160;y&#160;=&#160;f(x) and&#160;the&#160;function&#160;f&#160;is associated&#160;<br/>with a&#160;lot&#160;of&#160;computing effort,&#160;it&#160;is often simpler&#160;to&#160;simply&#160;compute&#160;the&#160;values&#160;over&#160;the&#160;<br/>potential range&#160;of&#160;x&#160;in advance and store&#160;the&#160;results in&#160;the&#160;form of&#160;a&#160;table (= characteristic&#160;<br/>curve).&#160;If&#160;the&#160;value&#160;x&#160;is now&#160;in&#160;the ECU,&#160;the&#160;value&#160;y&#160;does not&#160;need&#160;to&#160;be computed&#160;at&#160;the&#160;con­<br/>troller’s&#160;runtime, rather&#160;the&#160;map returns&#160;the&#160;result&#160;y&#160;to&#160;the&#160;input&#160;variable&#160;x. It may&#160;be neces­<br/>sary&#160;to interpolate between&#160;two&#160;values, but&#160;that&#160;would be&#160;the&#160;extent of&#160;the calculations.&#160;<br/>
How&#160;is&#160;this&#160;characteristic curve&#160;stored&#160;in&#160;memory?&#160;Are&#160;all&#160;x&#160;values input&#160;first and&#160;then all&#160;y&#160;<br/>values?&#160;Or&#160;does&#160;storage&#160;follow&#160;the&#160;pattern:&#160;x1,&#160;y1;&#160;x2,&#160;y2;&#160;x3,&#160;y3 …? Since&#160;various options are&#160;<br/>available,&#160;the&#160;type of&#160;memory&#160;storage&#160;is defined&#160;in a storage&#160;scheme in&#160;the&#160;A2L.&#160;<br/>
The&#160;convenience&#160;for&#160;the&#160;user&#160;comes&#160;from the&#160;ability&#160;to work&#160;with&#160;symbolic&#160;names for&#160;param­<br/>eters,&#160;the&#160;direct look&#160;at&#160;the&#160;physical&#160;values&#160;and&#160;access&#160;to complex&#160;elements such as charac­<br/>teristic maps,&#160;without having&#160;to concern oneself&#160;with complex&#160;storage schemes.<br/>
Another&#160;advantage&#160;is offered by&#160;the communication parameters.&#160;They&#160;are also defined in&#160;<br/>the&#160;A2L. In&#160;the&#160;communication&#160;between&#160;the&#160;measurement and calibration&#160;tool and&#160;the ECU,&#160;<br/>the&#160;parameter&#160;set&#160;from&#160;the&#160;A2L&#160;is used.&#160;The&#160;A2L&#160;contains&#160;everything&#160;that&#160;the measurement&#160;<br/>and&#160;calibration tool&#160;needs&#160;to&#160;communicate with the&#160;ECU.&#160;<br/>
<hr/>
<a name=70></a>74<br/>
2 ECU Description File&#160;A2L<br/>
<b>2.1&#160;Setting&#160;Up&#160;an&#160;A2L&#160;File&#160;for&#160;an&#160;XCP&#160;Slave&#160;</b><br/>
The&#160;A2L&#160;file&#160;is&#160;an&#160;ASCII­readable file,&#160;which&#160;describes the&#160;following&#160;with&#160;the&#160;help&#160;of&#160;<br/>keywords:<br/>&gt;&#160;&#160;Interface­specific&#160;parameters between&#160;measurement and&#160;calibration&#160;tool and&#160;A2L&#160;file&#160;<br/>
(the&#160;description is located at&#160;the beginning&#160;of&#160;the&#160;A2L&#160;file&#160;and is located in&#160;what is referred&#160;<br/>to&#160;as&#160;the AML&#160;tree),<br/>
&gt;&#160;&#160;Communication to the&#160;ECU,<br/>&gt;&#160;&#160;Storage&#160;scheme&#160;for&#160;characteristic curves&#160;and maps (keyword RECORD_LAYOUT),<br/>&gt;&#160;&#160;Conversion rules&#160;for&#160;converting raw&#160;values&#160;to physical&#160;values (keyword COMPU_METHOD),<br/>&gt;&#160;&#160;Measurement parameters (keyword MEASUREMENT),<br/>&gt;&#160;&#160;Calibration parameters (keyword CHARACTERISTIC) and<br/>&gt;&#160;&#160;Events&#160;that are relevant&#160;for&#160;triggering a measurement keyword EVENT),<br/>
A&#160;summary&#160;of&#160;parameters and measurement parameters is made&#160;with&#160;the help of&#160;groups&#160;<br/>(keyword GROUP).<br/>
Example of&#160;a measurement parameter&#160;with&#160;the&#160;name “Shifter_B3”:<br/>
&#160; &#160; /begin&#160;MEASUREMENT&#160;Shifter_B3 „Single&#160;bit signal&#160;(bit&#160;from a byte shifting)“<br/>&#160; &#160; &#160; UBYTE HighLow&#160;0 0 0 1<br/>&#160; &#160; &#160; READ_WRITE<br/>&#160; &#160; &#160; BIT_MASK&#160;0x8<br/>&#160; &#160; &#160; BYTE_ORDER MSB_LAST<br/>&#160; &#160; &#160; ECU_ADDRESS 0x124C02<br/>&#160; &#160; &#160; ECU_ADDRESS_EXTENSION 0x0<br/>&#160; &#160; &#160; FORMAT&#160;„%.3“<br/>&#160; &#160; &#160; /begin&#160;IF_DATA&#160;CANAPE_EXT<br/>&#160; &#160; &#160; &#160; 100<br/>&#160; &#160; &#160; &#160; LINK_MAP „byteShift“ 0x124C02 0x0 0 0x0 1 0x87 0x0<br/>&#160; &#160; &#160; &#160; DISPLAY&#160;0 0 20<br/>&#160; &#160; &#160; /end&#160;IF_DATA<br/>&#160; &#160; /end MEASUREMENT<br/>
Example of&#160;a parameter&#160;map&#160;with&#160;the&#160;name KF1:<br/>
&#160; &#160; /begin&#160;CHARACTERISTIC KF1 „8*8&#160;BYTE no&#160;axis“<br/>&#160; &#160; &#160; MAP 0xE0338&#160;__UBYTE_Z 0 Factor100 0 2.55<br/>&#160; &#160; &#160; ECU_ADDRESS_EXTENSION 0x0<br/>&#160; &#160; &#160; EXTENDED_LIMITS 0 2.55<br/>&#160; &#160; &#160; BYTE_ORDER MSB_LAST<br/>&#160; &#160; &#160; BIT_MASK&#160;0xFF<br/>&#160; &#160; &#160; /begin&#160;AXIS_DESCR<br/>&#160; &#160; &#160; &#160; FIX_AXIS NO_INPUT_QUANTITY&#160;BitSlice.CONVERSION 8 0 7<br/>&#160; &#160; &#160; &#160; EXTENDED_LIMITS 0 7<br/>
<hr/>
<a name=71></a>2.1 Setting Up an&#160;A2L&#160;File&#160;for&#160;an&#160;XCP Slave<br/>
75<br/>
&#160; &#160; &#160; &#160; READ_ONLY<br/>&#160; &#160; &#160; &#160; BYTE_ORDER MSB_LAST<br/>&#160; &#160; &#160; &#160; FORMAT&#160;„%.0“<br/>&#160; &#160; &#160; &#160; FIX_AXIS_PAR_DIST&#160;0 1 8<br/>&#160; &#160; &#160; /end&#160;AXIS_DESCR<br/>&#160; &#160; &#160; /begin&#160;AXIS_DESCR<br/>&#160; &#160; &#160; &#160; FIX_AXIS NO_INPUT_QUANTITY&#160;BitSlice.CONVERSION 8 0 7<br/>&#160; &#160; &#160; &#160; EXTENDED_LIMITS 0 7<br/>&#160; &#160; &#160; &#160; READ_ONLY<br/>&#160; &#160; &#160; &#160; BYTE_ORDER MSB_LAST<br/>&#160; &#160; &#160; &#160; FORMAT&#160;„%.0“<br/>&#160; &#160; &#160; &#160; FIX_AXIS_PAR_DIST&#160;0 1 8<br/>&#160; &#160; &#160; /end&#160;AXIS_DESCR<br/>&#160; &#160; &#160; /begin&#160;IF_DATA&#160;CANAPE_EXT<br/>&#160; &#160; &#160; &#160; 100<br/>&#160; &#160; &#160; &#160; LINK_MAP „map3_8_8_uc“ 0xE0338&#160;0x0 0 0x0 1 0x87 0x0<br/>&#160; &#160; &#160; &#160; DISPLAY&#160;0 0 255<br/>&#160; &#160; &#160; /end&#160;IF_DATA<br/>&#160; &#160; &#160; FORMAT&#160;„%.3“<br/>&#160; &#160; /end CHARACTERISTIC<br/>
The&#160;ASCII&#160;text is&#160;not easy&#160;to understand.&#160;You&#160;will&#160;find&#160;a description of&#160;its structure in&#160;ASAM&#160;<br/>XCP Part 2 Protocol Layer&#160;Specification in chapter&#160;2.<br/>
The&#160;sections&#160;below&#160;describe&#160;how&#160;to create&#160;an&#160;A2L. Let us&#160;focus&#160;on&#160;the actual contents of&#160;an&#160;<br/>A2L&#160;and&#160;their&#160;meanings&#160;and&#160;leave&#160;the&#160;details&#160;of&#160;the&#160;A2L&#160;description language&#160;to an editor.&#160;<br/>The&#160;A2L&#160;Editor&#160;that is supplied&#160;with CANape is used&#160;here.&#160;<br/>
<b>2.2 Manually&#160;Creating&#160;an&#160;A2L&#160;File</b><br/>
The&#160;A2L&#160;mainly&#160;describes&#160;the&#160;contents of&#160;the&#160;memory&#160;of&#160;the&#160;XCP Slave.&#160;The contents depend&#160;<br/>on&#160;the&#160;application in&#160;the&#160;Slave,&#160;which&#160;was developed as C code.&#160;After&#160;the compiler/linker&#160;run&#160;<br/>of&#160;the application code, important elements of&#160;an&#160;A2L&#160;file&#160;already&#160;exist in&#160;the linker­map&#160;file:&#160;<br/>the names of&#160;the objects,&#160;their&#160;data&#160;types and memory&#160;addresses.&#160;Still&#160;lacking&#160;are&#160;the&#160;<br/>parameters&#160;for&#160;communication between&#160;XCP Master&#160;and Slave. Other&#160;information is usually&#160;<br/>needed&#160;such&#160;as&#160;minimum and&#160;maximum&#160;values&#160;of&#160;parameters, conversion rules, storage&#160;<br/>schemes&#160;for&#160;characteristic maps etc.<br/>
Let us&#160;begin&#160;by&#160;creating&#160;an&#160;empty&#160;A2L&#160;and&#160;the&#160;communication parameters: If&#160;you&#160;wish&#160;to&#160;<br/>create an&#160;A2L&#160;that describes&#160;an ECU&#160;with&#160;an XCP­on­CAN&#160;interface,&#160;for&#160;example,&#160;you cre­<br/>ate a new&#160;device in CANape and select&#160;XCP on CAN as&#160;the&#160;interface.&#160;Then&#160;you can supple­<br/>ment&#160;this&#160;with other&#160;communication­specific&#160;information (e.g.&#160;CAN identifiers).&#160;After&#160;saving&#160;<br/>the&#160;file,&#160;you have an&#160;A2L&#160;that contains&#160;the&#160;entire communication content of&#160;the&#160;A2L. Still&#160;<br/>lacking&#160;are&#160;the&#160;definitions&#160;of&#160;the actual measurement and calibration parameters.&#160;<br/>
<hr/>
<a name=72></a>76<br/>
2 ECU Description File&#160;A2L<br/>
In&#160;the A2L&#160;Editor,&#160;the&#160;linker­map&#160;file&#160;is associated&#160;to&#160;the&#160;A2L. In a selection dialog,&#160;the user&#160;<br/>can now&#160;select&#160;those&#160;parameters&#160;from&#160;the&#160;map&#160;file&#160;which&#160;it needs&#160;in&#160;the&#160;A2L: scalar&#160;<br/>&#160;measurement and calibration parameters, characteristic curves and maps.&#160;The user&#160;can&#160;<br/>gradually&#160;add&#160;the&#160;desired parameters&#160;to&#160;the&#160;A2L&#160;step by&#160;step and group&#160;them. Other&#160;object­<br/>specific&#160;information is also&#160;added using&#160;the&#160;editor.&#160;<br/>
What&#160;should&#160;be done&#160;when&#160;you&#160;modify&#160;your&#160;code,&#160;recompile it&#160;and&#160;link&#160;it?&#160;It is&#160;highly&#160;proba­<br/>ble&#160;that&#160;the addresses&#160;of&#160;objects&#160;will&#160;change.&#160;Essentially, it&#160;is not&#160;necessary&#160;to generate a&#160;<br/>new&#160;A2L. If&#160;you&#160;wish&#160;to have objects just added&#160;to&#160;the&#160;code also be available in&#160;the&#160;A2L,&#160;you&#160;<br/>must of&#160;course&#160;add&#160;them&#160;to&#160;the&#160;A2L.&#160;Address&#160;updating&#160;is always necessary&#160;in&#160;the&#160;A2L.&#160;This&#160;<br/>is&#160;done&#160;with&#160;the&#160;editor; it searches&#160;for&#160;the&#160;relevant entry&#160;in&#160;the&#160;linker­map&#160;file&#160;based&#160;on&#160;the&#160;<br/>name of&#160;the&#160;A2L&#160;object, reads&#160;out&#160;the&#160;address&#160;and updates&#160;it in&#160;the&#160;A2L.<br/>
If&#160;your&#160;application changes&#160;very&#160;dynamically&#160;– objects are renamed, data&#160;types are adapted,&#160;<br/>parameters&#160;are deleted&#160;and others&#160;added&#160;–&#160;then&#160;the&#160;manual&#160;work&#160;method is impractical.&#160;To&#160;<br/>generate&#160;an A2L&#160;from a C code, other&#160;tools are available&#160;for&#160;automatic processing.&#160;<br/>
On&#160;the&#160;Vector&#160;homepage&#160;you will find&#160;information&#160;on&#160;the&#160;“ASAP2&#160;Tool­Set“ with which&#160;you&#160;<br/>can automate&#160;the&#160;generation of&#160;A2Ls&#160;from&#160;the&#160;source code in a batch process.<br/>
<b>2.3&#160;A2L&#160;Contents&#160;versus ECU Implementation</b><br/>
When&#160;an&#160;XCP Master&#160;tool reads&#160;in an&#160;A2L&#160;that does&#160;not&#160;fully&#160;match&#160;the ECU, misunder­<br/>standings&#160;in&#160;the&#160;communication&#160;might occur. For&#160;example, another&#160;value related&#160;to&#160;time­<br/>stamp resolution&#160;might be in&#160;the&#160;A2L&#160;file&#160;that differs&#160;from&#160;the&#160;value implemented in&#160;the&#160;<br/>ECU. If&#160;this&#160;is&#160;the&#160;case,&#160;the&#160;problem must be&#160;detected&#160;and&#160;solved.&#160;The user&#160;gets support&#160;<br/>from&#160;the&#160;Master,&#160;who&#160;can poll&#160;the&#160;Slave&#160;via&#160;the&#160;protocol&#160;to determine&#160;what&#160;was really&#160;imple­<br/>mented in&#160;the&#160;Slave.&#160;<br/>
XCP offers a number&#160;of&#160;functions&#160;that&#160;were developed&#160;for&#160;automatic detection of&#160;the Slave.&#160;<br/>Of&#160;course,&#160;this&#160;assumes&#160;that automatic detection is implemented in&#160;the Slave. If&#160;the Master&#160;<br/>polls&#160;the&#160;Slave and&#160;the Slave’s responses&#160;do not&#160;agree&#160;with&#160;the parameter&#160;set&#160;of&#160;the&#160;A2L&#160;<br/>description&#160;file,&#160;the&#160;Master&#160;must decide&#160;which&#160;settings&#160;to use. In CANape,&#160;the information&#160;<br/>that is read out by&#160;the&#160;Slave is given&#160;a higher&#160;priority&#160;than&#160;the&#160;information&#160;from&#160;the&#160;A2L.<br/>
<hr/>
<a name=73></a>2.3&#160;A2L&#160;Contents&#160;versus ECU Implementation<br/>
77<br/>
Here&#160;is&#160;an&#160;overview&#160;of&#160;possible&#160;commands&#160;that are&#160;used&#160;to&#160;find out something about&#160;the&#160;<br/>XCP implementation in&#160;the&#160;Slave:<br/>
GET_DAQ_PROCESSOR_INFO<br/>Returns&#160;general information&#160;on&#160;the&#160;DAQ&#160;lists:&#160;MAX_DAQ, MAX_EVENT_CHANNEL,&#160;<br/>MIN_DAQ<br/>
GET_DAQ_RESOLUTION_INFO&#160;<br/>Maximum parameter&#160;of&#160;an ODT&#160;entry&#160;for&#160;DAQ/STIM,&#160;time interval information<br/>
GET_DAQ_EVENT_INFO (Event_channel_number)<br/>Returns&#160;information&#160;for&#160;a specific&#160;time interval: Name and resolution of&#160;the&#160;time interval,&#160;<br/>number&#160;of&#160;DAQ&#160;lists&#160;that may&#160;be assigned&#160;to&#160;this&#160;time interval …<br/>
GET_DAQ_LIST_INFO (DAQ_List_Number)<br/>Returns&#160;information&#160;on&#160;the&#160;selected&#160;DAQ&#160;list: MAX_ODT, MAX_ODT_ENTRIES exist as pre­<br/>defined&#160;DAQ lists …<br/>
<hr/>
<a name=74></a>3 Calibration Concepts<br/>
79<br/>
<b>3 Calibration&#160;Concepts</b><br/>
<hr/>
<a name=75></a>80<br/>
3 Calibration Concepts<br/>
ECU parameters&#160;are&#160;constant parameters&#160;that are&#160;adapted and optimized&#160;during&#160;the&#160;<br/>development of&#160;the&#160;ECU or&#160;an&#160;ECU&#160;variant.&#160;This&#160;is&#160;an&#160;iterative process, in&#160;which&#160;the optimal&#160;<br/>value of&#160;a parameter&#160;is&#160;found by&#160;repeated measurements and changes.&#160;<br/>
The calibration concept&#160;answers&#160;the question of&#160;how&#160;parameters in&#160;the&#160;ECU&#160;can&#160;be changed&#160;<br/>during&#160;an&#160;ECU’s development and calibration phases.&#160;There&#160;is not one calibration concept&#160;<br/>that exists, rather&#160;several.&#160;Which&#160;concept is&#160;utilized usually&#160;depends&#160;very&#160;much on&#160;the capa­<br/>bilities&#160;and resources&#160;of&#160;the&#160;microcontroller&#160;that is used.&#160;<br/>Normally, parameters are stored in&#160;the production ECU’s&#160;flash&#160;memory.&#160;The underlying pro­<br/>gram&#160;variables&#160;are&#160;defined&#160;as&#160;constants in&#160;the&#160;software.&#160;To make parameters modifiable&#160;at&#160;<br/>runtime during&#160;an ECU’s development, additional RAM memory&#160;is needed.<br/>
A&#160;calibration concept is concerned&#160;with such&#160;questions&#160;as&#160;these: How&#160;do&#160;the parameters ini­<br/>tially&#160;find&#160;their&#160;way&#160;from flash&#160;to&#160;RAM?&#160;How&#160;is&#160;the&#160;microcontroller’s&#160;access to&#160;RAM&#160;rerouted?&#160;<br/>What does&#160;the&#160;solution look&#160;like&#160;when&#160;there are more parameters&#160;than can be simultane­<br/>ously&#160;stored in RAM? How&#160;are&#160;the&#160;parameters copied back&#160;into&#160;flash?&#160;Are changes&#160;to&#160;the&#160;<br/>parameters persistent, i.e. are&#160;they&#160;preserved&#160;when&#160;the&#160;ECU is&#160;turned off?<br/>A&#160;distinction is made between&#160;transparent and non­transparent calibration concepts.&#160;Trans­<br/>parent means&#160;that&#160;the&#160;calibration&#160;tool does&#160;not need&#160;to be&#160;concerned&#160;with&#160;the above&#160;<br/>&#160;questions,&#160;because&#160;all necessary&#160;mechanisms are implemented in&#160;the ECU.&#160;<br/>Several methods are briefly&#160;introduced in&#160;the&#160;following.<br/>
<b>3.1&#160;Parameters in&#160;Flash</b><br/>
The software developer&#160;defines&#160;in&#160;the source code&#160;whether&#160;a&#160;parameter&#160;is&#160;a&#160;variable or&#160;a&#160;<br/>constant, i.e.&#160;whether&#160;a parameter&#160;is stored in&#160;flash&#160;or&#160;in RAM&#160;memory.<br/>
C code example:&#160;<br/>
const&#160;float factor&#160;=&#160;0.5;&#160;<br/>
The “factor” parameter&#160;represents a constant&#160;with&#160;the&#160;value 0.5.&#160;During compiling and link­<br/>ing&#160;of&#160;the code, memory&#160;space is provided in&#160;flash&#160;for&#160;the&#160;“factor” object.&#160;The object is allo­<br/>cated&#160;an&#160;address&#160;that lies&#160;in&#160;the&#160;data area&#160;of&#160;the&#160;flash&#160;memory.&#160;The&#160;value 0.5 is&#160;found at&#160;<br/>the&#160;relevant address&#160;in&#160;the&#160;hex&#160;file&#160;and&#160;the&#160;address&#160;appears in&#160;the linker­map&#160;file.<br/>
The&#160;simplest&#160;conceivable calibration concept involves&#160;modifying&#160;the&#160;value in C code, gener­<br/>ating&#160;a new&#160;hex&#160;file&#160;and&#160;flashing.&#160;However,&#160;this&#160;method is&#160;very&#160;laborious, because&#160;every&#160;<br/>value&#160;change&#160;must be&#160;made&#160;in&#160;code, resulting&#160;in&#160;the&#160;need&#160;for&#160;a compiler/linker&#160;run&#160;with sub­<br/>sequent&#160;flashing.&#160;An alternative approach&#160;would be&#160;to only&#160;modify&#160;the&#160;value in&#160;the hex&#160;file&#160;<br/>and&#160;then&#160;reflash&#160;this&#160;file. Every&#160;calibration&#160;tool is&#160;capable of&#160;doing&#160;this. It is referred&#160;to as&#160;<br/>“offline&#160;calibration” of&#160;the&#160;hex&#160;file,&#160;which&#160;is a&#160;very&#160;commonly&#160;used method.<br/>
<hr/>
<a name=76></a>3.1 Parameters in Flash<br/>
81<br/>
Under&#160;some&#160;circumstances,&#160;with&#160;certain&#160;compilers it may&#160;be&#160;necessary&#160;to explicitly&#160;ensure&#160;<br/>that parameters are always also&#160;stored in&#160;flash&#160;memory&#160;and not integrated in&#160;the code,&#160;for&#160;<br/>example and&#160;therefore do not appear&#160;at all in&#160;the&#160;linker­map&#160;file. Usually, one does not&#160;want&#160;<br/>to leave&#160;to chance&#160;where&#160;a constant is&#160;created&#160;in&#160;flash&#160;memory.&#160;The necessary&#160;means&#160;for&#160;<br/>accomplishing&#160;this&#160;are almost always compiler­specific pragma instructions.&#160;To prevent&#160;the&#160;<br/>compiler&#160;from embedding&#160;them&#160;in&#160;the&#160;code, it is&#160;generally&#160;sufficient&#160;to use&#160;the&#160;“volatile”&#160;<br/>attribute&#160;for&#160;constant parameters.&#160;A&#160;typical definition&#160;of&#160;a&#160;flash&#160;constant appears as in&#160;the&#160;<br/>following&#160;example:<br/>&#160;<br/>C code example:&#160;<br/>
#pragma section “FLASH_Parameter”<br/>volatile const&#160;float&#160;factor&#160;= 0.5;<br/>
It is&#160;normally&#160;not possible&#160;to calibrate&#160;parameters&#160;in&#160;flash&#160;online. Indeed, most microcon­<br/>trollers&#160;are&#160;able to&#160;program their&#160;flash&#160;themselves,&#160;which&#160;is&#160;necessary&#160;for&#160;the&#160;purposes&#160;of&#160;<br/>re­programming&#160;in&#160;the&#160;field.&#160;Nonetheless,&#160;flash memory&#160;always has&#160;the property&#160;of&#160;being&#160;<br/>organized into larger&#160;blocks (sectors),&#160;which can only&#160;be erased&#160;as a&#160;whole. It is practically&#160;<br/>impossible&#160;to&#160;flash&#160;just individual&#160;parameters, because&#160;the&#160;ECU normally&#160;does not have&#160;the&#160;<br/>resources&#160;to buffer&#160;the&#160;rest&#160;of&#160;the&#160;sector&#160;and reprogram it. In addition,&#160;this process&#160;would&#160;<br/>take too&#160;much time.<br/>
Some ECUs have&#160;the ability&#160;to store data in&#160;what&#160;is known as&#160;an EEPROM&#160;memory.&#160;In con­<br/>trast&#160;to&#160;flash&#160;memories,&#160;EEPROM memories&#160;can erase&#160;and program each memory&#160;cell indi­<br/>vidually.&#160;The amount&#160;of&#160;available EEPROM&#160;memory&#160;is always&#160;considerably&#160;less&#160;than&#160;the&#160;<br/>available&#160;flash&#160;memory&#160;and&#160;it is&#160;usually&#160;limited&#160;to just a&#160;few&#160;kilobytes. EEPROM memory&#160;is&#160;<br/>often used&#160;to&#160;store programmable parameters&#160;in&#160;the service shop&#160;or&#160;to implement&#160;a&#160;persis­<br/>tence mechanism&#160;in&#160;the&#160;ECU, e.g.&#160;for&#160;the&#160;odometer. Online&#160;calibration&#160;would be conceivable&#160;<br/>here, but it is seldom used,&#160;because&#160;access&#160;to EEPROM cells&#160;is relatively&#160;slow&#160;and during&#160;the&#160;<br/>booting&#160;process&#160;EEPROM parameters&#160;are&#160;usually&#160;copied over&#160;to RAM memory,&#160;where it is&#160;<br/>possible&#160;to access&#160;them&#160;directly. ECUs&#160;which&#160;have&#160;no&#160;EEPROM memory&#160;often implement&#160;<br/>what is&#160;known&#160;as&#160;an&#160;EEPROM emulation.&#160;In&#160;this&#160;method, multiple small&#160;flash sectors are&#160;<br/>used&#160;in&#160;alternation&#160;to record parameter&#160;changes,&#160;so&#160;that&#160;the&#160;last&#160;valid&#160;value can always be&#160;<br/>determined.&#160;Online&#160;calibration&#160;would also&#160;be conceivable&#160;with&#160;this method.<br/>In both cases,&#160;the&#160;relevant memory&#160;accesses&#160;would&#160;then&#160;be intercepted in&#160;the software&#160;<br/>components&#160;of&#160;the&#160;XCP driver&#160;and implemented&#160;with&#160;the&#160;software routines of&#160;the&#160;EEPROM&#160;<br/>or&#160;the&#160;EEPROM emulation.&#160;The&#160;Vector&#160;XCP Professional&#160;driver&#160;offers&#160;the software hooks&#160;<br/>needed&#160;for&#160;this.<br/>
<hr/>
<a name=77></a>82<br/>
3 Calibration Concepts<br/>
<b>3.2 Parameters in&#160;RAM</b><br/>
The&#160;most&#160;frequently&#160;used&#160;approach&#160;to modifying&#160;parameters at runtime (“online calibra­<br/>tion”) is&#160;to create&#160;the&#160;parameters in&#160;the&#160;available RAM memory.&#160;<br/>
C code example:&#160;<br/>
#pragma section “RAM_Parameter”<br/>volatile float factor&#160;=&#160;0.5;&#160;<br/>
This&#160;defines&#160;the&#160;parameter&#160;“factor” as a RAM&#160;variable&#160;with&#160;the initial&#160;value 0.5. During com­<br/>piling&#160;and linking&#160;of&#160;the&#160;code, memory&#160;space is reserved&#160;for&#160;the object “factor” in RAM and&#160;<br/>the&#160;associated RAM address&#160;appears in&#160;the&#160;linker­map&#160;file.&#160;The initial&#160;value 0.5 is stored in&#160;<br/>flash&#160;memory&#160;and at&#160;the&#160;relevant location in&#160;the&#160;hex&#160;file.&#160;The&#160;addresses&#160;of&#160;the initial&#160;values&#160;<br/>in&#160;flash&#160;memory&#160;are defined&#160;by&#160;parameterization of&#160;the&#160;linker, but&#160;they&#160;do not appear&#160;in&#160;the&#160;<br/>linker­map file.&#160;<br/>During&#160;booting&#160;of&#160;the&#160;ECU, all RAM&#160;variables&#160;are initialized once&#160;with&#160;their&#160;initial&#160;values&#160;<br/>from&#160;flash&#160;memory.&#160;This&#160;is usually&#160;executed in&#160;the&#160;start­up code of&#160;the compiler&#160;producer&#160;<br/>and&#160;the&#160;application&#160;programmer&#160;does&#160;not need&#160;to be&#160;concerned&#160;with it.&#160;The application uses&#160;<br/>the&#160;values&#160;of&#160;parameters&#160;located&#160;in RAM and&#160;they&#160;can&#160;be&#160;modified&#160;via normal&#160;XCP memory&#160;<br/>accesses.&#160;<br/>
From&#160;the&#160;perspective of&#160;the&#160;ECU software, calibration parameters in RAM are always still&#160;<br/>unchangeable, i.e.&#160;the&#160;application&#160;itself&#160;does&#160;not change&#160;them. Many&#160;compilers discover&#160;this&#160;<br/>fact by&#160;code analysis&#160;and simply&#160;optimize&#160;the&#160;necessary&#160;RAM memory&#160;space away. Nor­<br/>mally, it is&#160;therefore also&#160;necessary&#160;to prevent&#160;the&#160;compiler&#160;from optimizing by&#160;using&#160;the&#160;<br/>“volatile” attribute.<br/>
From&#160;the&#160;perspective&#160;of&#160;the&#160;calibration&#160;tool,&#160;the&#160;RAM area&#160;in&#160;which&#160;the parameters are&#160;<br/>located is referred&#160;to as calibration RAM (memory&#160;that can be calibrated).&#160;<br/>
FLASH<br/>
RAM<br/>
Calibration&#160;RAM<br/>
Parameters<br/>
<b>Figure 53:&#160;<br/>Initial parameter&#160;setting in RAM</b><br/>
The&#160;calibration&#160;RAM&#160;does&#160;not need&#160;to consist&#160;of&#160;a&#160;fully&#160;contiguous RAM area. It may&#160;also be&#160;<br/>distributed&#160;into multiple&#160;areas&#160;or&#160;even&#160;in&#160;any&#160;desired&#160;way. Nonetheless, it offers significant&#160;<br/>advantages&#160;for&#160;organizing&#160;the&#160;parameters in just a&#160;few&#160;contiguous RAM areas and isolating&#160;<br/>them&#160;from other&#160;RAM parameters such as changing&#160;state&#160;variables and intermediate&#160;<br/>results.&#160;This&#160;is especially&#160;important if&#160;offline&#160;calibration of&#160;the&#160;calibration RAM&#160;with a hex&#160;<br/>file&#160;should be enabled.&#160;At&#160;the&#160;user’s request,&#160;the&#160;calibration&#160;tool must be able&#160;to load&#160;the&#160;<br/>
<hr/>
<a name=78></a>3.2 Parameters in RAM<br/>
83<br/>
parameters&#160;that&#160;were modified&#160;offline&#160;into&#160;the&#160;ECU during&#160;the&#160;transition&#160;from offline cali­<br/>bration&#160;to online&#160;calibration.&#160;<br/>
This&#160;case occurs&#160;very&#160;frequently. For&#160;example,&#160;when&#160;calibrators reconnect&#160;with&#160;their&#160;ECU on&#160;<br/>the&#160;next work&#160;day, they&#160;want to&#160;resume work&#160;at the&#160;point&#160;at which they&#160;stopped the&#160;evening&#160;<br/>before. However, booting&#160;of&#160;the&#160;ECU causes&#160;the&#160;flashed&#160;contents&#160;to be copied&#160;to&#160;the RAM&#160;<br/>as an initial dataset.&#160;To let users resume&#160;with&#160;work&#160;accomplished on&#160;the previous day,&#160;the&#160;<br/>parameter&#160;set&#160;file&#160;saved&#160;the&#160;previous evening&#160;in&#160;the&#160;ECU’s RAM must be loaded.&#160;This load­<br/>ing&#160;process&#160;may&#160;be&#160;time optimized by&#160;limiting&#160;the&#160;number&#160;of&#160;necessary&#160;transmissions&#160;to a&#160;<br/>minimum. It is advantageous here if&#160;the&#160;tool can quickly&#160;and reliably&#160;determine – by&#160;forming&#160;<br/>a checksum over&#160;larger&#160;contiguous&#160;areas&#160;–&#160;whether&#160;there&#160;are&#160;differences. If&#160;there are&#160;no dif­<br/>ferences&#160;between&#160;the&#160;calibration&#160;RAM contents&#160;in&#160;the&#160;ECU and&#160;the&#160;file modified using&#160;the&#160;<br/>tool,&#160;this area does&#160;not need&#160;to be&#160;transferred.&#160;If&#160;the&#160;memory&#160;area&#160;with&#160;the calibration&#160;<br/>parameters&#160;is&#160;not clearly&#160;defined,&#160;or&#160;if&#160;it includes&#160;parameters&#160;that are&#160;modified by&#160;the ECU&#160;<br/>software, a checksum calculation&#160;always shows a difference and&#160;the parameter&#160;values are&#160;<br/>transmitted, either&#160;from&#160;the&#160;ECU&#160;to&#160;the&#160;XCP Master&#160;or&#160;in&#160;a reverse direction. Depending&#160;on&#160;<br/>the&#160;transmission speed&#160;and amount of&#160;data,&#160;this&#160;transmission could&#160;take several minutes.&#160;<br/>
Another&#160;advantage&#160;of&#160;clearly&#160;defined&#160;memory&#160;segments&#160;is&#160;that&#160;the memory&#160;area&#160;for&#160;initial&#160;<br/>values&#160;in&#160;flash&#160;memory&#160;can&#160;be&#160;used&#160;for&#160;offline&#160;calibration.&#160;The&#160;contents of&#160;the&#160;flash memory&#160;<br/>are defined&#160;using&#160;flashable&#160;hex&#160;files. If&#160;the&#160;calibration&#160;tool knows&#160;the location of&#160;parameters&#160;<br/>in&#160;the hex&#160;file, it can modify&#160;their&#160;values&#160;and implement new&#160;initial&#160;values&#160;in&#160;the ECU by&#160;<br/>flashing&#160;the&#160;modified&#160;hex&#160;file.&#160;<br/>The&#160;calibration&#160;tool not only&#160;needs&#160;to know&#160;the&#160;location&#160;of&#160;parameters in RAM, but also&#160;the&#160;<br/>initial&#160;values&#160;in&#160;flash.&#160;A&#160;prerequisite is&#160;that&#160;the&#160;RAM memory&#160;segment must be initialized by&#160;<br/>copying&#160;from&#160;an identically&#160;laid&#160;out&#160;memory&#160;segment&#160;in&#160;flash,&#160;as&#160;is&#160;the usual&#160;practice&#160;in&#160;<br/>most compilers/linkers.&#160;If&#160;the&#160;addresses&#160;of&#160;parameters in&#160;RAM are in&#160;the&#160;A2L&#160;file, it is only&#160;<br/>necessary&#160;to&#160;let the&#160;tool&#160;know&#160;the&#160;offset to the&#160;start&#160;address&#160;of&#160;the&#160;calibration&#160;RAM, which&#160;<br/>it must add&#160;to get&#160;to&#160;the&#160;start address&#160;of&#160;the&#160;relevant&#160;flash&#160;area.&#160;This offset&#160;then applies&#160;to&#160;<br/>each&#160;individual parameter&#160;in&#160;the&#160;A2L.&#160;<br/>
The&#160;calibration&#160;tool can&#160;then&#160;either&#160;generate&#160;flashable&#160;hex&#160;files&#160;for&#160;this area itself, or&#160;it can&#160;<br/>place&#160;them&#160;directly&#160;on&#160;the&#160;original hex&#160;files&#160;of&#160;the&#160;linker&#160;to modify&#160;the&#160;initial&#160;values of&#160;para­<br/>meters&#160;in the&#160;hex&#160;file.<br/>
<hr/>
<a name=79></a>84<br/>
3 Calibration Concepts<br/>
<b>3.3 Flash&#160;Overlay</b><br/>
Many&#160;microcontrollers&#160;offer&#160;options&#160;for&#160;overlaying&#160;memory&#160;areas in&#160;flash&#160;with internal or&#160;<br/>external RAM.&#160;This&#160;process&#160;is referred&#160;to as&#160;flash&#160;emulation or&#160;flash overlay.&#160;A&#160;lot is possible,&#160;<br/>from&#160;the&#160;use&#160;of&#160;a Memory&#160;Management Unit all&#160;the&#160;way&#160;to dedicated mechanisms&#160;that pre­<br/>cisely&#160;serve&#160;this&#160;purpose. In&#160;this&#160;case&#160;the&#160;parameters&#160;are&#160;created as parameters in&#160;flash just&#160;<br/>as in calibration concept 1.&#160;This&#160;method offers enormous&#160;advantages&#160;compared&#160;to&#160;the&#160;<br/>described calibration concept 2 “Parameters in RAM”:<br/>&gt;&#160;&#160;No distinction is&#160;made&#160;between&#160;flash and&#160;RAM addresses.&#160;The&#160;flash addresses are&#160;always&#160;<br/>
located in&#160;the&#160;A2L&#160;file,&#160;the&#160;hex&#160;file&#160;and linker­map&#160;file.&#160;This&#160;produces clear&#160;relationships,&#160;<br/>the&#160;hex&#160;file&#160;is directly&#160;flashable&#160;and&#160;the&#160;A2L&#160;file&#160;matches&#160;it exactly.<br/>
&gt;&#160;&#160;The overlay&#160;can be activated&#160;or&#160;deactivated as a&#160;whole,&#160;which&#160;enables&#160;lightning­quick&#160;<br/>
swapping between&#160;values in&#160;flash and&#160;those&#160;in RAM.&#160;They&#160;are referred&#160;to&#160;as&#160;the&#160;RAM&#160;page&#160;<br/>and&#160;the&#160;flash&#160;page&#160;of&#160;a memory&#160;segment.&#160;XCP supports&#160;control of&#160;memory&#160;page switch­<br/>ing&#160;with special&#160;commands.&#160;<br/>
&gt;&#160;&#160;The&#160;memory&#160;pages&#160;might be&#160;switched&#160;separately, e.g.&#160;for&#160;XCP access and ECU access, i.e.&#160;<br/>
XCP could access&#160;a memory&#160;page&#160;while&#160;the&#160;ECU&#160;software&#160;works&#160;with&#160;the other&#160;page.&#160;This&#160;<br/>permits&#160;such&#160;operations&#160;as&#160;downloading&#160;of&#160;the&#160;offline&#160;calibration data&#160;to RAM,&#160;while&#160;the&#160;<br/>ECU is&#160;still&#160;working&#160;with&#160;the&#160;flash&#160;data;&#160;this&#160;avoids&#160;potential inconsistencies&#160;that could be&#160;<br/>problematic on a running&#160;ECU.<br/>
&gt;&#160;&#160;The&#160;overlay&#160;with RAM does&#160;not need&#160;to be complete and it can be adapted&#160;to&#160;the applica­<br/>
tion case. It is possible&#160;to&#160;work&#160;with less&#160;RAM&#160;than&#160;with&#160;flash.&#160;More on&#160;this later.<br/>
A&#160;typical&#160;procedure for&#160;connecting&#160;the&#160;calibration tool to the&#160;ECU with the&#160;subsequent&#160;<br/>download of&#160;values&#160;that&#160;were calibrated offline&#160;appears as&#160;follows:<br/>
Connects to the&#160;ECU&#160;<br/>
CONNECT<br/>
Connects&#160;XCP Master&#160;to RAM page&#160;<br/>
SET_CAL_PAGE&#160;XCP&#160;to RAM<br/>
Checksum&#160;calculation&#160;<br/>
CALC_CHECKSUM<br/>
When&#160;a difference has&#160;been&#160;detected in&#160;the&#160;checksum&#160;calculation over&#160;the RAM area,&#160;first&#160;<br/>the&#160;user&#160;is normally&#160;asked how&#160;to proceed.&#160;Should&#160;the&#160;contents of&#160;ECU RAM be sent&#160;to&#160;the&#160;<br/>Master,&#160;or&#160;should&#160;the contents of&#160;a&#160;file on&#160;the Master&#160;page be&#160;sent&#160;to&#160;the&#160;ECU’s&#160;RAM?&#160;If&#160;the&#160;<br/>user&#160;decides&#160;to&#160;write&#160;the&#160;offline changes&#160;to&#160;the&#160;ECU,&#160;the&#160;subsequent process appears as&#160;<br/>follows:<br/>
ECU should use&#160;the&#160;dataset of&#160;the&#160;flash&#160;page&#160;&#160;SET_CAL_PAGE ECU&#160;to FLASH<br/>Copy&#160;file&#160;from Master&#160;to&#160;the&#160;RAM page&#160;&#160;<br/>
DOWNLOAD …<br/>
ECU should use&#160;the&#160;dataset of&#160;the&#160;RAM page&#160;&#160;SET_CAL_PAGE ECU&#160;to RAM<br/>
Afterwards,&#160;the&#160;memory&#160;page is always&#160;switched over&#160;to&#160;RAM,&#160;so&#160;that&#160;parameters&#160;can&#160;be&#160;&#160;<br/>modified.&#160;But&#160;the&#160;user&#160;can also explicitly&#160;indicate&#160;which&#160;memory&#160;page should be active in&#160;the&#160;<br/>ECU. For&#160;example,&#160;the&#160;behavior&#160;of&#160;the&#160;RAM parameter&#160;set can be compared&#160;to&#160;that of&#160;the&#160;<br/>flash&#160;parameter&#160;set, or&#160;in&#160;an&#160;emergency&#160;it can&#160;be&#160;switched&#160;back&#160;to a proven&#160;parameter&#160;set&#160;<br/>in&#160;flash&#160;at lightning&#160;speed.<br/>
<hr/>
<a name=80></a>3.4 Dynamic Flash Overlay&#160;Allocation<br/>
85<br/>
<b>3.4 Dynamic&#160;Flash&#160;Overlay&#160;Allocation</b><br/>
The&#160;concepts&#160;for&#160;calibration RAM described so&#160;far&#160;are unproblematic if&#160;sufficient RAM is&#160;<br/>available&#160;for&#160;all parameters.&#160;But&#160;what if&#160;the&#160;total number&#160;of&#160;parameters does not&#160;fit into&#160;<br/>the&#160;available RAM area?&#160;<br/>
Here, it is advisable&#160;to overlay&#160;flash&#160;with RAM dynamically&#160;and do not overlay&#160;the affected&#160;<br/>flash&#160;memory&#160;with&#160;RAM until&#160;the&#160;actual&#160;write&#160;access&#160;to a parameter.&#160;This procedure&#160;can&#160;<br/>occur&#160;with a certain granularity&#160;and – depending&#160;on&#160;the&#160;implementation – it may&#160;be&#160;trans­<br/>parent to the&#160;calibration&#160;tool from the&#160;XCP&#160;perspective.&#160;If&#160;the&#160;XCP&#160;driver&#160;detects&#160;a write&#160;<br/>access&#160;to&#160;flash&#160;in&#160;the&#160;ECU&#160;which&#160;would lead&#160;to a change, a part of&#160;calibration RAM is used&#160;<br/>to&#160;copy&#160;over&#160;the relevant&#160;part&#160;of&#160;flash&#160;and activate&#160;the overlay&#160;mechanism&#160;for&#160;this&#160;part.&#160;This&#160;<br/>involves&#160;allocating&#160;the&#160;RAM, i.e. in a&#160;fixed layout and it is identified as utilized. However,&#160;the&#160;<br/>resources&#160;of&#160;the&#160;calibration RAM are limited.&#160;During&#160;the&#160;calibration process, RAM area&#160;that&#160;<br/>has&#160;already&#160;been allocated is no longer&#160;released,&#160;so&#160;the&#160;available calibration RAM dwindles&#160;<br/>with&#160;further&#160;requests.&#160;If&#160;the&#160;RAM resources&#160;are used&#160;up and a new&#160;allocation is required,&#160;the&#160;<br/>user&#160;is informed of&#160;the&#160;exhausted RAM resources.&#160;The&#160;user&#160;is offered&#160;the option of&#160;flashing&#160;<br/>or&#160;saving&#160;the&#160;changes&#160;made&#160;up&#160;to&#160;that point.&#160;This&#160;frees&#160;up&#160;the&#160;allocated RAM area&#160;again&#160;<br/>and&#160;the&#160;user&#160;can&#160;once&#160;again&#160;calibrate.&#160;The&#160;variant in&#160;which&#160;the&#160;ECU&#160;autonomously&#160;flashes&#160;<br/>the&#160;previously&#160;changed&#160;parameters is usually&#160;ruled out here&#160;for&#160;the reasons already&#160;cited in&#160;<br/>calibration concept “Parameter&#160;in Flash”.<br/>
In&#160;some&#160;cases,&#160;the&#160;download of&#160;a parameter&#160;set created&#160;offline might not be executable due&#160;<br/>to insufficient RAM resources.&#160;The&#160;only&#160;alternative is&#160;to&#160;flash&#160;it.&#160;The user&#160;can always cancel&#160;<br/>the&#160;changes&#160;from&#160;the&#160;tool and&#160;this&#160;releases&#160;the&#160;allocated RAM blocks again.<br/>
In&#160;this concept, page&#160;switching&#160;between&#160;the&#160;RAM and&#160;flash&#160;pages is also possible&#160;without&#160;<br/>any&#160;limitations.&#160;The&#160;parameters should be&#160;organized&#160;together&#160;in&#160;flash according&#160;to&#160;function,&#160;<br/>so&#160;that&#160;the&#160;available RAM blocks can be used&#160;as efficiently&#160;as possible.&#160;The software devel­<br/>oper&#160;then specifies&#160;that&#160;the&#160;parameters,&#160;which&#160;belong&#160;together&#160;thematically, also lie in a&#160;<br/>contiguous memory&#160;area.&#160;After&#160;copying&#160;to RAM,&#160;the&#160;parameters needed&#160;for&#160;tuning&#160;the par­<br/>ticular&#160;function&#160;are fully&#160;ready&#160;for&#160;use.&#160;<br/>
<hr/>
<a name=81></a>86<br/>
3 Calibration Concepts<br/>
<b>3.5 RAM&#160;Pointer&#160;Based Calibration&#160;Concept&#160;per&#160;AUTOSAR</b><br/>
This&#160;concept does&#160;not require necessarily&#160;the&#160;use&#160;of&#160;an&#160;AUTOSAR operating system; it can&#160;<br/>even&#160;be used&#160;in a different environment – e.g.&#160;without an&#160;operating system.&#160;The&#160;concept&#160;<br/>exhibits a key&#160;similarity&#160;to&#160;the&#160;previous concept.&#160;The&#160;primary&#160;difference is&#160;that&#160;the substitu­<br/>tion of&#160;flash&#160;for&#160;RAM is not implemented by&#160;hardware mechanisms, but by&#160;software mech­<br/>anisms&#160;instead.&#160;The&#160;calibration&#160;parameters&#160;are&#160;always&#160;referenced&#160;by&#160;pointers&#160;from&#160;the ECU&#160;<br/>software. Flash&#160;or&#160;RAM contents are accessed&#160;by&#160;changing&#160;this pointer.&#160;The&#160;flash parame­<br/>ters&#160;to be modified&#160;are copied&#160;to a defined&#160;block&#160;with available RAM.&#160;This method can be&#160;<br/>implemented&#160;fully&#160;transparently&#160;from&#160;the&#160;XCP perspective, just as in&#160;the previous method.&#160;<br/>As an&#160;alternative,&#160;the&#160;user&#160;of&#160;the&#160;calibration&#160;tool can&#160;explicitly&#160;select&#160;the parameters&#160;to be&#160;<br/>modified by&#160;preselecting&#160;the&#160;desired parameters.&#160;The&#160;advantage of&#160;this&#160;is&#160;that resource&#160;uti­<br/>lization&#160;and&#160;loading&#160;is&#160;visible&#160;to&#160;the&#160;user&#160;and&#160;the&#160;user&#160;is&#160;not surprised by&#160;a lack&#160;of&#160;memory&#160;in&#160;<br/>the&#160;midst of&#160;working.<br/>
<b>3.5.1&#160;Single&#160;Pointer&#160;Concept</b><br/>
The&#160;pointer&#160;table is located in RAM.&#160;When&#160;booting&#160;the&#160;ECU, all pointers indicate&#160;the para­<br/>meter&#160;values&#160;in&#160;flash.&#160;The&#160;location and parameters of&#160;the&#160;calibration RAM are indeed&#160;known,&#160;<br/>but it does&#160;not&#160;yet contain any&#160;parameter&#160;values&#160;after&#160;booting. Initially,&#160;the application&#160;<br/>works&#160;entirely&#160;from flash.<br/>
FLASH<br/>
Pointertable<br/>
RAM<br/>
Parameters<br/>
<b>Figure 54:&#160;<br/>Initial situation after&#160;booting</b><br/>
When&#160;the&#160;user&#160;selects&#160;a&#160;parameter&#160;from the&#160;A2L&#160;file&#160;for&#160;the&#160;first time&#160;after&#160;booting&#160;and&#160;<br/>wishes&#160;to write&#160;access&#160;it, this&#160;triggers&#160;a&#160;copying&#160;operation&#160;within the&#160;ECU first.&#160;The&#160;XCP&#160;<br/>Slave&#160;determines&#160;that&#160;the&#160;address&#160;to&#160;which&#160;the&#160;access&#160;should be made&#160;is located in&#160;the&#160;<br/>flash&#160;area, and&#160;it copies&#160;the&#160;parameter&#160;value&#160;to&#160;the&#160;calibration RAM.&#160;A&#160;change is also made&#160;<br/>in&#160;the&#160;pointer&#160;table&#160;to&#160;ensure&#160;that the&#160;application&#160;no&#160;longer&#160;gets the&#160;parameter&#160;value from&#160;<br/>flash,&#160;but instead&#160;from&#160;the&#160;RAM area:&#160;<br/>
<hr/>
<a name=82></a>3.5 RAM Pointer&#160;Based Calibration Concept per&#160;AUTOSAR<br/>
87<br/>
FLASH<br/>
Pointertable<br/>
RAM<br/>
Parameters<br/>
<b>Figure 55:&#160;<br/>Pointer&#160;change and copying&#160;to RAM</b><br/>
The&#160;application&#160;continues&#160;to get&#160;the&#160;parameter&#160;value&#160;via&#160;the&#160;pointer&#160;table. But since&#160;the&#160;<br/>pointer&#160;indicates&#160;the&#160;RAM address,&#160;the&#160;value is retrieved&#160;from&#160;there.&#160;As a result,&#160;the user&#160;can&#160;<br/>change&#160;the&#160;parameter&#160;value&#160;via&#160;XCP and observe&#160;the&#160;effects of&#160;the change in&#160;the measure­<br/>ment.&#160;The&#160;disadvantage&#160;of&#160;this&#160;method is&#160;that an&#160;entry&#160;in&#160;a pointer&#160;table&#160;must be&#160;available&#160;<br/>for&#160;each&#160;parameter&#160;and in&#160;turn&#160;the&#160;method is associated&#160;with substantial additional RAM&#160;<br/>memory&#160;requirements for&#160;the&#160;pointer&#160;table.&#160;<br/>
The&#160;next&#160;figure illustrates&#160;the&#160;problem.&#160;Three&#160;parameters of&#160;a PID controller&#160;(P,&#160;I and D) are&#160;<br/>contained&#160;in an ECU’s&#160;flash&#160;area.&#160;The&#160;RAM addresses&#160;and parameter&#160;values in RAM are also&#160;<br/>already&#160;changed&#160;in&#160;the&#160;pointer&#160;table.<br/>
<b>Parameter</b><br/>
<b>Flash</b><br/>
<b>Pointertable</b><br/>
<b>RAM</b><br/>
Address<br/>
Content<br/>
Address<br/>
Address<br/>
Content<br/>
<b>P</b><br/>
0x0000100A&#160;&#160;0x11<br/>
0x000A100A<br/>
0x000A100A&#160;0x44<br/>
<b>I</b><br/>
0x000012BC&#160;&#160;0x22<br/>
0x000A100B<br/>
0x000A100B&#160;0x55<br/>
<b>D</b><br/>
0x00007234&#160;&#160;0x33<br/>
0x000A100C<br/>
0x000A100C&#160;0x66<br/>
<b>Figure 56: Pointer&#160;table&#160;for&#160;individual parameters</b><br/>
Calibration concepts are&#160;very&#160;important, because RAM resources are scarce. Large RAM&#160;<br/>pointer&#160;tables&#160;would make a concept self­defeating.&#160;<br/>
To avoid having&#160;to create a pointer&#160;for&#160;each&#160;individual parameter&#160;and having&#160;the method be&#160;<br/>used as such,&#160;the parameters can&#160;be combined into&#160;structures.&#160;This&#160;requires&#160;just&#160;one&#160;pointer&#160;<br/>per&#160;structure.&#160;When&#160;the&#160;user&#160;selects a parameter, not only&#160;is&#160;this parameter&#160;copied&#160;to RAM,&#160;<br/>but so&#160;is&#160;the&#160;entire associated structure.&#160;The&#160;granularity&#160;of&#160;the structures is&#160;of&#160;key&#160;impor­<br/>tance here.&#160;With large&#160;structures only&#160;a&#160;few&#160;pointers are necessary.&#160;In&#160;turn,&#160;this means&#160;that&#160;<br/>with&#160;the&#160;decision&#160;for&#160;a specific&#160;parameter, a rather&#160;large&#160;associated structure is copied&#160;to&#160;<br/>the&#160;RAM area and&#160;this&#160;can cause&#160;the&#160;limits of&#160;calibration RAM space&#160;to be reached quickly.<br/>
<hr/>
<a name=83></a>88<br/>
3 Calibration Concepts<br/>
Example:&#160;<br/>The&#160;calibration RAM&#160;should be 400 bytes&#160;in size. Four&#160;structures&#160;are defined in&#160;the software&#160;<br/>with the&#160;following&#160;parameters:<br/>
Structure&#160;A: 250 bytes<br/>Structure B: 180 bytes<br/>Structure C: 120 bytes<br/>Structure D: 100 bytes<br/>
When&#160;the user&#160;selects a parameter&#160;from structure&#160;A,&#160;the&#160;250 bytes&#160;are copied&#160;from&#160;flash&#160;to&#160;<br/>the&#160;calibration RAM,&#160;and&#160;the&#160;user&#160;has&#160;XCP access&#160;to all parameters located in structure&#160;A.&#160;<br/>If&#160;the calibration&#160;task&#160;is limited&#160;to&#160;the&#160;parameters&#160;of&#160;this&#160;structure,&#160;the calibration RAM is&#160;<br/>fully&#160;sufficient. However, if&#160;the&#160;user&#160;selects&#160;another&#160;parameter&#160;located in a different struc­<br/>ture,&#160;e.g. structure C,&#160;these&#160;120&#160;bytes&#160;must also&#160;be copied&#160;to&#160;the&#160;calibration&#160;RAM.&#160;Since the&#160;<br/>calibration RAM can handle&#160;400&#160;bytes,&#160;the&#160;user&#160;can access&#160;all parameters of&#160;structures&#160;A&#160;<br/>and C simultaneously.<br/>
If&#160;another&#160;selected parameter&#160;is not located in structure C, but rather&#160;in structure B,&#160;the 180&#160;<br/>bytes&#160;of&#160;structure&#160;B&#160;would have&#160;to be&#160;copied&#160;to RAM in&#160;addition&#160;to&#160;the 250 bytes of&#160;struc­<br/>ture&#160;A. However, since&#160;the&#160;space in&#160;RAM is&#160;inadequate&#160;for&#160;this,&#160;the user&#160;indeed has&#160;access to&#160;<br/>the&#160;parameters of&#160;structure&#160;A, but not&#160;to&#160;the&#160;data of&#160;structure&#160;B, because&#160;the&#160;ECU cannot&#160;<br/>execute&#160;the&#160;copy&#160;command.<br/>
You can learn more about how&#160;this&#160;approach&#160;works in CANape. Start CANape&#160;with&#160;the&#160;<br/>&#160;“AUTOSAR Single Pointered Demo” project.&#160;You&#160;will&#160;find&#160;more information&#160;on its&#160;use in&#160;<br/>&#160;CANape on&#160;the&#160;“Introduction” page&#160;of&#160;the&#160;project.<br/>
You&#160;will&#160;find&#160;a source&#160;code&#160;example&#160;under&#160;the&#160;“Demos” category&#160;at&#160;the&#160;Vector&#160;Download&#160;<br/>Center.&#160;A&#160;code example on how&#160;to use&#160;the calibration concept is&#160;contained in&#160;the “XCP&#160;&#160;Sample&#160;<br/>Implementation” under&#160;&lt;Installation DIR&gt;\Samples\CAN\CAN MPC55xx\XCPDemo.<br/>
<b>3.5.2&#160;Double&#160;Pointer&#160;Concept</b><br/>
A&#160;disadvantage&#160;of&#160;the&#160;single&#160;pointer&#160;concept is&#160;that memory&#160;page switching is not easy&#160;to&#160;<br/>implement.&#160;The&#160;calibration&#160;tool could simply&#160;describe&#160;the&#160;pointer&#160;table completely&#160;for&#160;page&#160;<br/>swapping,&#160;but&#160;this&#160;is&#160;not&#160;feasible&#160;in&#160;a short period of&#160;time&#160;without resulting&#160;in&#160;temporary&#160;<br/>inconsistencies&#160;and&#160;side&#160;effects.&#160;A&#160;tool­transparent implementation&#160;would double&#160;the mem­<br/>ory&#160;space requirement&#160;for&#160;the pointer&#160;table, because&#160;when&#160;switching&#160;the memory&#160;page into&#160;<br/>flash,&#160;a copy&#160;of&#160;the&#160;previous pointer&#160;table&#160;would have&#160;to be created&#160;with RAM pointers.<br/>
For&#160;applications&#160;with large&#160;pointer&#160;tables, a&#160;transparent implementation or&#160;a&#160;fully&#160;consis­<br/>tent switching,&#160;there&#160;is&#160;the&#160;option of&#160;extending&#160;the&#160;method&#160;to a double pointer&#160;concept.&#160;To&#160;<br/>explain how&#160;this&#160;is done,&#160;we return once again&#160;to&#160;the&#160;initial RAM setting.&#160;<br/>
<hr/>
<a name=84></a>3.5 RAM Pointer&#160;Based Calibration Concept per&#160;AUTOSAR<br/>
89<br/>
Figure 57 represents&#160;the&#160;pointer&#160;table. It lies&#160;in RAM.&#160;As already&#160;mentioned,&#160;this&#160;table must&#160;<br/>be copied&#160;from&#160;flash&#160;into&#160;RAM.&#160;As a result,&#160;this&#160;table lies&#160;in&#160;flash&#160;memory.&#160;If&#160;another&#160;pointer&#160;<br/>is&#160;now&#160;used&#160;(a&#160;table&#160;pointer),&#160;which&#160;points&#160;to either&#160;the&#160;pointer&#160;table&#160;in RAM or&#160;in&#160;flash, one&#160;<br/>arrives&#160;at a double pointer&#160;solution.&#160;<br/>
FLASH<br/>
RAM<br/>
Pointertable<br/>
FLASH<br/>
Pointertable<br/>
RAM<br/>
Tablepointer<br/>
<b>Figure 57:&#160;<br/>Double pointer&#160;concept</b><br/>
The&#160;parameter&#160;values&#160;are&#160;initially&#160;accessed&#160;via&#160;the&#160;table&#160;pointer. If&#160;the&#160;table pointer&#160;indi­<br/>cates&#160;the pointer&#160;table in RAM,&#160;the application essentially&#160;accesses&#160;the actual parameters&#160;<br/>via&#160;the&#160;contents of&#160;the&#160;RAM pointer&#160;table.&#160;The&#160;low&#160;access&#160;speed and&#160;the creation of&#160;more&#160;<br/>program code are disadvantages&#160;of&#160;this solution.<br/>
<b>3.6 Flash&#160;Pointer&#160;Based Calibration&#160;Concept&#160;</b><br/>
This&#160;method&#160;was patented several&#160;years ago&#160;by&#160;the&#160;company&#160;ZF&#160;Friedrichshafen under&#160;the&#160;<br/>name “InCircuit2” and bears a strong resemblance&#160;to&#160;the pointer­based concept of&#160;AUTOSAR.&#160;<br/>Here&#160;too,&#160;the application in&#160;the&#160;ECU&#160;accesses&#160;parameter&#160;data&#160;using a&#160;pointer&#160;table. How­<br/>ever,&#160;this&#160;pointer&#160;table is not located in RAM, but in&#160;flash&#160;instead. Changes&#160;to&#160;the pointer&#160;<br/>table can&#160;therefore only&#160;be made by&#160;flash&#160;programming.&#160;A&#160;tool­transparent implementation&#160;<br/>is not possible.&#160;The&#160;advantage&#160;lies&#160;in&#160;the&#160;RAM memory&#160;that is saved since it no longer&#160;con­<br/>tains&#160;the&#160;pointer&#160;table.<br/>
You can&#160;find&#160;out how&#160;this&#160;approach&#160;works&#160;in CANape. Start CANape&#160;with&#160;the “InCircuit2”&#160;<br/>project.&#160;You&#160;will&#160;find&#160;more information on its use&#160;in CANape on&#160;the “Introduction” page of&#160;<br/>the&#160;project.<br/>
<hr/>
<a name=85></a>4 Application Areas&#160;of&#160;XCP<br/>
91<br/>
<b>4&#160;Application&#160;Areas&#160;of&#160;XCP</b><br/>
<hr/>
<a name=86></a>92<br/>
4 Application Areas&#160;of&#160;XCP<br/>
When&#160;ECU calibrators&#160;think&#160;about&#160;the use&#160;of&#160;XCP,&#160;they&#160;are usually&#160;fixated on use of&#160;the pro­<br/>tocol in&#160;the&#160;ECU.<br/>
Simulink<br/>
Slave<br/>
Prototype or<br/>
ECU Hardware<br/>
Slave<br/>
Measurement/<br/>
<b>XCP</b><br/>
Calibration&#160;<br/>
Master<br/>
Slave<br/>
PC<br/>
Hardware*<br/>
EXE/DLL<br/>
Slave<br/>
HIL/SIL Systems<br/>
Slave<br/>
<b>Figure 58:&#160;<br/>Application areas and&#160;</b><br/>
* Debug Interfaces, Memory Emulator ...<br/>
<b>application cases</b><br/>
In a survey&#160;of&#160;development processes, one&#160;encounters many&#160;different solution approaches&#160;<br/>for&#160;the&#160;development of&#160;electronics&#160;and software. HIL&#160;(Hardware in&#160;the Loop), SIL&#160;(Software&#160;<br/>in the&#160;Loop)&#160;and Rapid Prototyping are keywords here and&#160;they&#160;describe different scenarios.&#160;<br/>They&#160;always have a “plant” and a “controller” in common.&#160;<br/>
Manipulated&#160;&#160;Disturbance&#160;<br/>
Offset<br/>
Variable<br/>
Variable<br/>
Reference&#160;Variable<br/>
<b>Controller</b><br/>
<b>Plant</b><br/>
Controlled&#160;Variable<br/>
(Set&#160;Value)<br/>
(Actual&#160;Value)<br/>
<b>Figure 59: Plants and controllers</b><br/>
In&#160;the&#160;context of&#160;automotive&#160;development,&#160;the&#160;controller&#160;is&#160;represented&#160;by&#160;the&#160;ECU and&#160;the&#160;<br/>plant is&#160;the&#160;physical system&#160;to be controlled such&#160;as&#160;the&#160;transmission, engine, side mirrors,&#160;<br/>etc.<br/>
The rough subdivision is made&#160;between&#160;different&#160;development&#160;approaches&#160;according&#160;to&#160;<br/>whether&#160;the&#160;controller&#160;or&#160;the&#160;plant runs&#160;in&#160;real&#160;or&#160;simulated&#160;mode. Some&#160;combinations&#160;will&#160;<br/>be described in greater&#160;detail.&#160;<br/>
<hr/>
<a name=87></a>4.1 MIL: Model in&#160;the Loop&#160;<br/>
93<br/>
<b>4.1&#160;Model&#160;in&#160;the&#160;Loop&#160;(MIL)&#160;</b><br/>
Simulink<br/>
<b>Controller&#160;Model</b><br/>
<b>Plant&#160;Model</b><br/>
<b>Figure 60:&#160;<br/>Model in&#160;the Loop&#160;<br/>in Simulink</b><br/>
In&#160;this development environment, both&#160;the controller&#160;and&#160;the&#160;plant are simulated as a&#160;<br/>model.&#160;In&#160;the example shown,&#160;both&#160;models run in Simulink&#160;as&#160;the runtime&#160;environment.&#160;The&#160;<br/>capabilities&#160;of&#160;the&#160;Simulink&#160;runtime&#160;environment&#160;are&#160;available to&#160;you&#160;for&#160;analyzing the&#160;<br/>behavior.&#160;<br/>
To realize&#160;the&#160;convenience of&#160;a measurement and calibration&#160;tool like CANape in an early&#160;<br/>development phase, an&#160;XCP Slave&#160;can be&#160;integrated&#160;in&#160;the&#160;controller&#160;model.&#160;In an authoring&#160;<br/>step,&#160;the&#160;Slave generates&#160;the&#160;A2L&#160;that matches&#160;the&#160;model and&#160;the user&#160;already&#160;has&#160;the&#160;full&#160;<br/>range&#160;of&#160;convenient operating&#160;features&#160;with&#160;visualization&#160;of&#160;process&#160;flows in graphic&#160;win­<br/>dows, access&#160;to characteristic curves&#160;and maps and much more.<br/>
Simulink<br/>
<b>Controller&#160;Model</b><br/>
<b>Plant&#160;Model</b><br/>
<b>CANape</b><br/>
<b>Simulink</b><br/>
<b>Figure 61:&#160;</b><br/>
<b>XCP Server</b><br/>
<b>CANape as measurement&#160;</b><br/>
A2L<br/>
<b>and&#160;calibration&#160;tool&#160;<br/>with Simulink&#160;models</b><br/>
Neither&#160;a code generation step nor&#160;instrumentation of&#160;the&#160;model is necessary&#160;for&#160;this.&#160;Time­<br/>stamps are also&#160;included&#160;with&#160;transmissions over&#160;XCP. CANape completely&#160;adapts&#160;to&#160;the&#160;<br/>time&#160;behavior&#160;of&#160;the&#160;Simulink&#160;runtime&#160;environment here.&#160;Whether&#160;the model is running&#160;<br/>faster&#160;or&#160;slower&#160;than&#160;in real&#160;time is of&#160;no&#160;consequence. For&#160;example, if&#160;the&#160;functional devel­<br/>oper&#160;uses&#160;the&#160;Simulink&#160;Debugger&#160;in&#160;the&#160;model&#160;to step&#160;through&#160;the model, CANape still&#160;takes&#160;<br/>the&#160;time transmitted&#160;via&#160;XCP&#160;as the&#160;reference time.<br/>
<hr/>
<a name=88></a>94<br/>
4 Application Areas&#160;of&#160;XCP<br/>
<b>4.2 Software in&#160;the&#160;Loop&#160;(SIL)&#160;</b><br/>
Simulink<br/>
<b>Controller&#160;Model</b><br/>
<b>Plant&#160;Model</b><br/>
Code Generation<br/>
<b>Controller&#160;Model</b><br/>
<b>Figure 62:&#160;</b><br/>
<b>Windows DLL</b><br/>
<b>Software in&#160;the Loop&#160;<br/>with Simulink&#160;</b><br/>
<b>environment</b><br/>
In&#160;this&#160;development step, code&#160;is generated&#160;from&#160;the&#160;model&#160;of&#160;the controller,&#160;which is&#160;then&#160;<br/>used&#160;in&#160;a PC­based&#160;runtime&#160;environment. Naturally,&#160;the&#160;controller&#160;may&#160;also have been&#160;devel­<br/>oped&#160;without any&#160;sort of&#160;model­based approach.&#160;The&#160;plant continues&#160;to be simulated.&#160;XCP&#160;<br/>can be used&#160;to measure and calibrate&#160;the&#160;controller. If&#160;the&#160;controller&#160;originates&#160;from a&#160;<br/>&#160;Simulink&#160;model, a code generation step (Simulink&#160;Coder&#160;with&#160;the&#160;target “CANape”) is used&#160;<br/>to generate&#160;the&#160;C code&#160;for&#160;a DLL&#160;and&#160;the&#160;associated&#160;A2L. If&#160;the Controller&#160;development is&#160;<br/>conducted&#160;based&#160;on&#160;manually&#160;written&#160;code, it is&#160;embedded&#160;in&#160;a C++ project&#160;that is delivered&#160;<br/>with CANape.<br/>
After&#160;compiling&#160;and linking,&#160;the&#160;DLL&#160;is&#160;used&#160;in&#160;the&#160;CANape context.&#160;With&#160;the&#160;support of&#160;the&#160;<br/>XCP connection,&#160;the&#160;algorithms in&#160;the DLL&#160;can be measured and calibrated exactly&#160;as if&#160;the&#160;<br/>application&#160;were already&#160;integrated in an ECU.<br/>
Simulink<br/>
<b>Controller&#160;Model</b><br/>
<b>Plant&#160;Model</b><br/>
Code generation<br/>
<b>Controller&#160;Model</b><br/>
<b>CANape</b><br/>
<b>Windows DLL</b><br/>
A2L<br/>
<b>Figure 63:&#160;<br/>CANape as SIL&#160;<br/>development platform</b><br/>
<hr/>
<a name=89></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-89_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-89_2.png"/><br/>
4.3 HIL: Hardware in&#160;the Loop<br/>
95<br/>
<b>4.3 Hardware in&#160;the&#160;Loop&#160;(HIL)&#160;</b><br/>
Many&#160;different kinds&#160;of&#160;HIL&#160;systems are&#160;available.&#160;They&#160;range&#160;from&#160;very&#160;simple, cost­effec­<br/>tive systems all&#160;the&#160;way&#160;to&#160;very&#160;large&#160;and expensive expansion stages.&#160;The&#160;following&#160;figure&#160;<br/>shows&#160;the&#160;rough&#160;concept:<br/>
<b>Controller&#160;Model</b><br/>
HIL Platform<br/>
I/O<br/>
<b>Plant&#160;Model</b><br/>
ECU<br/>
<b>Figure 64:&#160;</b><br/>
<b>HIL&#160;solution</b><br/>
The&#160;controller&#160;algorithm runs&#160;in a microcontroller&#160;platform (e.g.&#160;the ECU),&#160;while&#160;the&#160;plant&#160;<br/>continues&#160;to be simulated.&#160;Depending&#160;on&#160;the&#160;parameters&#160;and&#160;the complexity&#160;of&#160;the plant&#160;<br/>and&#160;the necessary&#160;I/O,&#160;requirements of&#160;the HIL&#160;platform&#160;and&#160;the&#160;associated&#160;costs&#160;can&#160;rise&#160;<br/>steeply. Since&#160;the ECU runs&#160;in real&#160;time,&#160;the&#160;model of&#160;the&#160;plant must also be computed in&#160;<br/>real time.<br/>
To now&#160;introduce&#160;XCP&#160;for&#160;optimization appears&#160;trivial, because&#160;another&#160;ECU is being&#160;added.&#160;<br/>The&#160;whole system looks like&#160;this:<br/>
<b>Controller&#160;Model</b><br/>
A2L<br/>
HIL Platform<br/>
I/O<br/>
<b>CANape</b><br/>
<b>Plant&#160;Model</b><br/>
<b>Figure 65:&#160;<br/>HIL&#160;with&#160;CANape&#160;</b><br/>
ECU<br/>
<b>as measurement and&#160;<br/>&#160;calibration&#160;&#160;tool</b><br/>
From CANape,&#160;the&#160;user&#160;has&#160;access&#160;to&#160;the&#160;algorithms in&#160;the&#160;ECU over&#160;XCP.&#160;<br/>
<hr/>
<a name=90></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-90_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-90_2.png"/><br/>
96<br/>
4 Application Areas&#160;of&#160;XCP<br/>
The&#160;Vector&#160;Tool&#160;CANoe is also&#160;used by&#160;many&#160;customers as a&#160;HIL&#160;system.&#160;With&#160;CANoe,&#160;a&#160;HIL&#160;<br/>system might look&#160;like&#160;this:<br/>
<b>CANoe RT User PC</b><br/>
Ethernet<br/>
CANoe RT&#160;Server<br/>
CAN<br/>
LIN<br/>
<b>Plant&#160;Model</b><br/>
MOST<br/>
A2L<br/>
FlexRay<br/>
Digital I/O<br/>
Analog I/O<br/>
XCP<br/>
<b>CANape</b><br/>
ECU<br/>
<b>Figure 66:&#160;<br/>CANoe as HIL&#160;system</b><br/>
The&#160;ability&#160;to access&#160;XCP data directly&#160;from CANoe&#160;for&#160;testing&#160;purposes results in&#160;the&#160;fol­<br/>lowing&#160;variant&#160;as&#160;well:<br/>
<b>CANoe RT User PC</b><br/>
A2L<br/>
Ethernet<br/>
CANoe RT&#160;Server<br/>
CAN<br/>
LIN<br/>
<b>Plant&#160;Model</b><br/>
XCP<br/>
MOST<br/>
FlexRay<br/>
Digital I/O<br/>
Analog I/O<br/>
<b>Figure 67:&#160;<br/>CANoe as HIL&#160;system&#160;<br/>with&#160;XCP&#160;access&#160;</b><br/>
ECU<br/>
<b>to&#160;the&#160;ECU</b><br/>
Here&#160;the&#160;model of&#160;the&#160;plant runs&#160;on&#160;the&#160;CANoe real­time server.&#160;At&#160;the same&#160;time,&#160;XCP&#160;<br/>access&#160;to&#160;the ECU&#160;is also&#160;realized&#160;from&#160;CANoe.&#160;This&#160;gives&#160;a&#160;tool&#160;simultaneous&#160;access&#160;to&#160;the&#160;<br/>plant and&#160;the&#160;controller.&#160;<br/>
<hr/>
<a name=91></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-91_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-91_2.png"/><br/>
4.3 HIL: Hardware in&#160;the Loop<br/>
97<br/>
To round out&#160;the&#160;picture,&#160;yet another&#160;HIL&#160;solution option should be mentioned.&#160;The plant&#160;<br/>might also&#160;run as a DLL&#160;in CANape.&#160;This&#160;gives&#160;the&#160;user&#160;full access&#160;to&#160;the plant and&#160;to&#160;the&#160;<br/>controller&#160;over&#160;XCP.&#160;<br/>
ECU<br/>
<b>CANape</b><br/>
<b>Plant&#160;Model</b><br/>
A2L<br/>
<b>Windows DLL</b><br/>
XCP<br/>
Plant<br/>
A2L<br/>
XCP<br/>
ECU<br/>
<b>Figure 68: CANape as HIL&#160;solution</b><br/>
<b>4.4 Rapid&#160;Control&#160;Prototyping&#160;(RCP)&#160;</b><br/>
In&#160;this&#160;development phase,&#160;the&#160;control algorithm runs&#160;on&#160;real­time hardware instead of&#160;an&#160;<br/>ECU.&#160;This&#160;situation often&#160;occurs&#160;when&#160;the&#160;necessary&#160;ECU&#160;hardware&#160;is not&#160;yet available.&#160;<br/>&#160;Several platforms come in question as suitable hardware:&#160;from simple evaluation boards all&#160;<br/>the&#160;way&#160;to special automotive­level&#160;hardware&#160;solutions,&#160;depending&#160;on&#160;which additional&#160;<br/>requirements need&#160;to&#160;be&#160;fulfilled.&#160;Here&#160;too,&#160;integration&#160;with&#160;XCP&#160;helps&#160;in&#160;setting&#160;up&#160;an&#160;OEM­<br/>independent tool&#160;chain.<br/>
<b>Controller&#160;Model</b><br/>
<b>CANape</b><br/>
<b>EVA&#160;Board</b><br/>
A2L<br/>
XCP<br/>
I/O<br/>
Plant<br/>
<b>Figure 69: Solution&#160;for&#160;Rapid Control Prototyping</b><br/>
The&#160;concepts&#160;“Rapid” and&#160;“Prototyping”&#160;describe&#160;the&#160;task&#160;very&#160;well.&#160;The aim is&#160;to develop a&#160;<br/>functional&#160;prototype&#160;as&#160;quickly&#160;as&#160;possible,&#160;to use&#160;and&#160;test&#160;it in&#160;the&#160;runtime environment.&#160;<br/>This&#160;just requires&#160;simple&#160;work&#160;steps&#160;throughout&#160;the&#160;entire process.<br/>
<hr/>
<a name=92></a>98<br/>
4 Application Areas&#160;of&#160;XCP<br/>
In&#160;the&#160;literature,&#160;the&#160;RCP approach is&#160;frequently&#160;subdivided&#160;into&#160;two areas:&#160;fullpassing&#160;and&#160;<br/>bypassing.<br/>
As depicted in Figure 69,&#160;the&#160;entire controller&#160;runs&#160;on separate real­time hardware.&#160;This&#160;<br/>method is known as&#160;fullpassing, because&#160;the&#160;entire controller&#160;runs on&#160;the controller&#160;hard­<br/>ware. It must&#160;have&#160;the necessary&#160;I/O&#160;to be able&#160;to interface&#160;with&#160;the&#160;plant.&#160;Very&#160;often,&#160;it is&#160;<br/>only&#160;possible&#160;to fulfill technical&#160;requirements&#160;for&#160;the&#160;I/O with&#160;suitable&#160;power&#160;electronics.&#160;<br/>
It is not only&#160;the&#160;I/O&#160;that represents a challenge;&#160;often&#160;functional elements of&#160;the ECU&#160;soft­<br/>ware (e.g.&#160;network&#160;management) are needed&#160;to enable&#160;functionality&#160;in a more complex&#160;net­<br/>work. However, if&#160;a complete ECU is used&#160;for&#160;Rapid Control Prototyping instead of&#160;a general&#160;<br/>controller&#160;platform,&#160;the&#160;complexity&#160;of&#160;the&#160;flash&#160;process,&#160;the&#160;size of&#160;the overall software, etc.&#160;<br/>all&#160;work&#160;against&#160;the&#160;requirement&#160;for&#160;“rapid” development.&#160;<br/>
In summary:&#160;the&#160;use of&#160;an entire ECU&#160;as&#160;the runtime environment&#160;for&#160;the&#160;controller&#160;offers&#160;<br/>the&#160;advantage&#160;that&#160;the&#160;necessary&#160;hardware&#160;and&#160;software&#160;infrastructure&#160;for&#160;the plant exists.&#160;<br/>The disadvantage lies in&#160;the high&#160;degree of&#160;complexity.&#160;The concept&#160;of&#160;bypassing&#160;was&#160;devel­<br/>oped&#160;to exploit&#160;the&#160;advantages of&#160;the&#160;ECU infrastructure&#160;without being burdened by&#160;the&#160;<br/>disadvantages&#160;of&#160;high&#160;complexity.<br/>
<b>4.5 Bypassing&#160;</b><br/>
When&#160;bypassing&#160;occurs,&#160;data&#160;is recorded&#160;from&#160;the ECU&#160;and processed&#160;outside&#160;the&#160;ECU,&#160;and&#160;<br/>the&#160;result&#160;is&#160;written&#160;back&#160;to&#160;the&#160;ECU.&#160;As&#160;both measurement and&#160;writing&#160;to&#160;the&#160;ECU must&#160;<br/>occur&#160;in sync&#160;with&#160;the ECU&#160;processes,&#160;DAQ&#160;and STIM&#160;mechanisms&#160;are&#160;used.&#160;At&#160;least&#160;two&#160;<br/>DAQ lists are required, one&#160;with&#160;the&#160;DAQ direction (from Slave&#160;to Master) and one&#160;with&#160;the&#160;<br/>STIM direction (from Master&#160;to Slave).<br/>
In&#160;Figure&#160;70,&#160;the&#160;ECU is&#160;connected&#160;to&#160;the&#160;plant.&#160;The&#160;necessary&#160;I/O and software compo­<br/>nents are available in&#160;the&#160;ECU. In&#160;the&#160;bypassing&#160;hardware, an algorithm&#160;A1 runs,&#160;which&#160;<br/>occurs in&#160;Version&#160;A&#160;of&#160;the&#160;ECU.&#160;A1 is a new&#160;variant of&#160;the&#160;algorithm and should now&#160;be&#160;tried&#160;<br/>out on&#160;the&#160;real plant.<br/>
<hr/>
<a name=93></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-93_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-93_2.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-93_3.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-93_4.png"/><br/>
4.5 Bypassing<br/>
99<br/>
ECU<br/>
A2L<br/>
XCP<br/>
Bypassing Hardware<br/>
<b>CANape</b><br/>
Bypassing<br/>
Hardware<br/>
A2L<br/>
XCP<br/>
I/O<br/>
<b>Controller&#160;Model</b><br/>
ECU<br/>
Plant<br/>
<b>Figure 70: Basic principle of&#160;bypassing</b><br/>
The&#160;bypassing&#160;hardware&#160;(a&#160;VN8900 device&#160;in&#160;the&#160;figure) and&#160;the ECU&#160;are interconnected&#160;<br/>over&#160;XCP. One&#160;goal here is&#160;to get&#160;the&#160;data needed&#160;for&#160;algorithm&#160;A1&#160;from&#160;the ECU by&#160;DAQ;&#160;<br/>another&#160;goal is&#160;to stimulate&#160;the&#160;results&#160;of&#160;A1 back&#160;into&#160;the&#160;ECU.&#160;The&#160;following&#160;figure&#160;illus­<br/>trates&#160;the&#160;schematic flow:<br/>
Bypassing Hardware<br/>
<b>Algorithm&#160;A’</b><br/>
<b>2.</b><br/>
<b>Bypassing</b><br/>
<b>Coordinator</b><br/>
<b>3.</b><br/>
<b>1.&#160;XCP&#160;4.</b><br/>
<b>Algorithm&#160;A</b><br/>
ECU<br/>
<b>Figure 71:&#160;<br/>Bypassing&#160;flow</b><br/>
Depicted&#160;in&#160;the&#160;ECU&#160;is&#160;a blue&#160;function&#160;block&#160;in&#160;which&#160;the&#160;algorithm&#160;A&#160;runs.&#160;To ensure&#160;that&#160;A1&#160;<br/>can now&#160;be used,&#160;the&#160;data enters algorithm&#160;A&#160;as an input&#160;variable and it is measured&#160;from&#160;<br/>the&#160;ECU by&#160;DAQ.&#160;<br/>
Step 1: In&#160;the&#160;ECU,&#160;the&#160;data is recorded and sent&#160;to&#160;the&#160;bypassing&#160;tool before&#160;the original&#160;<br/>function is calculated in&#160;the&#160;ECU. Normally,&#160;the&#160;input data in&#160;functions&#160;A&#160;and&#160;A1 is are&#160;<br/>identical.&#160;<br/>Step 2:&#160;The&#160;data&#160;transferred&#160;via DAQ is now&#160;transferred&#160;to algorithm&#160;A1.<br/>Step 3:&#160;The&#160;results of&#160;the&#160;calculation of&#160;algorithm&#160;A1 are&#160;transferred&#160;to&#160;the bypassing&#160;tool.&#160;<br/>Step&#160;4:&#160;The&#160;data is&#160;transferred into&#160;the&#160;ECU&#160;via STIM.&#160;The&#160;ECU calculates algorithm&#160;A&#160;dur­<br/>ing&#160;this&#160;time. If&#160;the&#160;stimulated results are available and calculation of&#160;algorithm&#160;A&#160;is com­<br/>
<hr/>
<a name=94></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-94_1.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-94_2.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-94_3.png"/><br/>
<img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-94_4.png"/><br/>
100<br/>
4 Application Areas&#160;of&#160;XCP<br/>
plete,&#160;the&#160;values&#160;calculated in&#160;the ECU are&#160;typically&#160;overwritten&#160;by&#160;the stimulated&#160;values of&#160;<br/>algorithm A1.<br/>
This&#160;makes&#160;it possible&#160;to use&#160;the&#160;value&#160;computed&#160;by&#160;algorithm&#160;A1 and not&#160;from&#160;A&#160;in&#160;the&#160;<br/>ECU’s overall control process.&#160;This&#160;method permits using&#160;a combination of&#160;the rapid substi­<br/>tution&#160;of&#160;algorithms&#160;on&#160;the&#160;bypassing&#160;hardware&#160;that incorporates&#160;the I/O and&#160;the ECU’s&#160;<br/>basic software.&#160;<br/>
Of&#160;course, performance&#160;limits&#160;of&#160;the&#160;transport protocol also&#160;affect bypassing. If&#160;short&#160;<br/>bypassing&#160;times&#160;are needed,&#160;access&#160;to&#160;the&#160;ECU by&#160;DAQ&#160;and STIM&#160;may&#160;also be performed&#160;via&#160;<br/>the&#160;controller’s&#160;debugging&#160;or&#160;trace&#160;interfaces.&#160;The&#160;Vector&#160;VX1000&#160;measurement and cali­<br/>bration hardware converts&#160;the&#160;data into an&#160;XCP­on­Ethernet data stream&#160;from&#160;the control­<br/>ler&#160;interface. In&#160;this&#160;process,&#160;up&#160;to one&#160;megabyte of&#160;data can be&#160;transported into&#160;the ECU.<br/>
XCP<br/>
Bypassing Hardware<br/>
Bypassing<br/>
<b>CANape</b><br/>
Hardware<br/>
A2L<br/>
XCP<br/>
Measurement &amp; Calibration<br/>
Hardware&#160;VX1000<br/>
Debugging and&#160;<br/>
Trace Interface<br/>
I/O<br/>
<b>Controller&#160;Model</b><br/>
ECU<br/>
Plant<br/>
<b>Figure 72: Bypassing&#160;with real-time bypassing hardware and&#160;fast ECU access</b><br/>
In&#160;the&#160;figure, ECU access&#160;occurs&#160;via&#160;XCP on Ethernet, and calculation of&#160;the bypass&#160;algo­<br/>rithm&#160;occurs on separate bypassing&#160;hardware (VN8900&#160;network&#160;interface)&#160;with&#160;a&#160;real­time&#160;<br/>operating&#160;system.&#160;This&#160;means&#160;that&#160;the&#160;variance of&#160;the&#160;calculation&#160;time is considerably&#160;<br/>smaller&#160;than&#160;with calculation on a laptop, as&#160;the&#160;processing&#160;time is not affected by&#160;other&#160;<br/>applications.<br/>
<hr/>
<a name=95></a>4.6 Shortening Iteration Cycles&#160;with&#160;Virtual ECUs<br/>
101<br/>
<b>4.6 Shortening&#160;Iteration&#160;Cycles&#160;with&#160;Virtual&#160;ECUs&#160;</b><br/>
Stimulation&#160;with data is necessary&#160;to optimize&#160;the&#160;algorithm in&#160;the ECU&#160;with&#160;the help of&#160;<br/>XCP.&#160;This&#160;can&#160;be done&#160;in&#160;the&#160;ECU in&#160;the&#160;framework&#160;of&#160;test&#160;drives. But&#160;there&#160;is&#160;yet another&#160;<br/>solution&#160;that is available&#160;with&#160;XCP, in&#160;which&#160;the&#160;algorithm does&#160;not run on an ECU; rather&#160;it&#160;<br/>runs&#160;on&#160;the&#160;PC in&#160;the&#160;form of&#160;executable&#160;code&#160;or&#160;as&#160;a model&#160;in Simulink&#160;in&#160;the&#160;form of&#160;a&#160;<br/>&#160;“virtual ECU.”&#160;This&#160;virtual ECU does&#160;not need&#160;to run&#160;in&#160;real&#160;time, because in&#160;this case no con­<br/>nection&#160;to a real&#160;system exists.&#160;It can&#160;run&#160;significantly&#160;faster&#160;– depending on&#160;the PC’s com­<br/>puting&#160;power.&#160;<br/>
The&#160;algorithm is&#160;stimulated&#160;by&#160;a previously&#160;logged&#160;measurement&#160;file,&#160;which contains&#160;all&#160;<br/>&#160;signals&#160;that are needed&#160;as input signals&#160;for&#160;the&#160;algorithm.&#160;The&#160;connection&#160;to CANape is set&#160;<br/>up over&#160;XCP.&#160;The&#160;user&#160;can&#160;perform&#160;the&#160;parameterization&#160;and measurement configuration.&#160;<br/>Afterwards, execution is started.&#160;Here&#160;the data&#160;from&#160;the&#160;test&#160;drive is&#160;fed into&#160;the algorithm&#160;<br/>as stimulation and&#160;the&#160;desired measurement parameters&#160;from&#160;the application are simulta­<br/>neously&#160;measured out and saved&#160;to a measurement&#160;file.&#160;<br/>
Para-<br/>
MDF<br/>
meter<br/>
test&#160;drive<br/>
Application<br/>
5.&#160;Analyze<br/>
1. Set parameters<br/>
2. Start<br/>
<b>Simulink/</b><br/>
<b>CANape</b><br/>
<b>DLL</b><br/>
3. Send&#160;test drive data<br/>
4. Measurement data<br/>
Slave<br/>
New<br/>
MDF<br/>
<b>Figure 73:&#160;<br/>Short calibration cycles&#160;<br/>with&#160;virtual&#160;ECUs</b><br/>
<hr/>
<a name=96></a>102<br/>
4 Application Areas&#160;of&#160;XCP<br/>
After&#160;the&#160;calculation has&#160;been&#160;completed, a new&#160;measurement&#160;file is available&#160;to&#160;the user&#160;<br/>for&#160;analysis&#160;of&#160;ECU behavior.&#160;The&#160;length&#160;of&#160;time&#160;of&#160;the&#160;new&#160;measurement&#160;file&#160;precisely&#160;<br/>matches&#160;the&#160;length of&#160;the&#160;input measurement&#160;file. If&#160;the&#160;duration of&#160;a&#160;test drive is one hour,&#160;<br/>the algorithm on&#160;the&#160;PC might&#160;calculate&#160;the&#160;entire&#160;test&#160;drive in just&#160;a&#160;few&#160;seconds.&#160;Then&#160;a&#160;<br/>measurement result exists,&#160;which&#160;corresponds&#160;to a&#160;test&#160;of&#160;one&#160;hour&#160;duration. Based on&#160;the&#160;<br/>data analysis,&#160;the&#160;user&#160;makes&#160;decisions about parameterization and&#160;the iteration cycle is&#160;<br/>repeated.&#160;<br/>
&#160;<br/>
<b>CANape</b><br/>
<b>Application&#160;as&#160;EXE&#160;or&#160;DLL&#160;on&#160;PC</b><br/>
Parameterization<br/>
Set&#160;values&#160;in<br/>
via XCP<br/>
workspace&#160;&#160;<br/>
Start<br/>
Start<br/>
Send&#160;measurement<br/>
Calculate&#160;model<br/>
data<br/>
Receive&#160;new<br/>
Send&#160;measurement&#160;<br/>
measurement data<br/>
values from the model<br/>
Analyze&#160;the<br/>
End&#160;model&#160;calculation<br/>
new data&#160;<br/>
New&#160;software&#160;version<br/>
<b>Figure 74:&#160;<br/>Process&#160;flow&#160;with&#160;<br/>&#160;virtual&#160;&#160;ECUs</b><br/>
To shorten&#160;the&#160;iteration&#160;cycles,&#160;the algorithm is&#160;always&#160;stimulated&#160;with&#160;the same data.&#160;That&#160;<br/>makes&#160;the results&#160;with different&#160;parameters&#160;much more comparable,&#160;because&#160;the&#160;results&#160;<br/>are only&#160;influenced by&#160;the&#160;parameters&#160;that differ.<br/>
This process&#160;can&#160;of&#160;course be automated.&#160;The integrated script&#160;language&#160;of&#160;CANape&#160;per­<br/>forms an analysis of&#160;the&#160;measurement results,&#160;from&#160;which&#160;parameter&#160;calibration settings&#160;<br/>are derived and automatically&#160;executed.&#160;It is also&#160;possible&#160;to have&#160;the process controlled by&#160;<br/>an external optimization&#160;tool such&#160;as MATLAB over&#160;the&#160;CANape automation interface.<br/>
<hr/>
<a name=97></a>5 Example of&#160;an&#160;XCP Implementation<br/>
105<br/>
<b>5 Example&#160;of&#160;an&#160;XCP&#160;Implementation</b><br/>
<hr/>
<a name=98></a>106<br/>
5 Example of&#160;an&#160;XCP Implementation<br/>
To make it possible&#160;for&#160;an ECU&#160;to&#160;communicate over&#160;XCP,&#160;it is necessary&#160;to&#160;integrate an&#160;XCP&#160;<br/>driver&#160;in&#160;the ECU’s application.&#160;The example described below&#160;is&#160;of&#160;the&#160;XCP&#160;driver&#160;which&#160;you&#160;<br/>can download&#160;free&#160;of&#160;charge&#160;at&#160;the&#160;Download Center&#160;of&#160;the&#160;Vector&#160;website (www.vector.<br/>com/xcp­driver).&#160;This&#160;packet also&#160;contains&#160;some&#160;sample&#160;implementations&#160;for&#160;various&#160;trans­<br/>port layers&#160;and&#160;target platforms.&#160;The&#160;driver&#160;consists&#160;of&#160;the&#160;protocol­Layer&#160;with&#160;the basic&#160;<br/>functionality&#160;needed&#160;for&#160;measurement and&#160;calibration. It does&#160;not include&#160;features such as&#160;<br/>Cold&#160;Start&#160;Measurement,&#160;Stimulation or&#160;flashing.&#160;You&#160;can purchase&#160;a&#160;full implementation&#160;<br/>as a product&#160;that is integrated in&#160;the&#160;Vector&#160;CANbedded&#160;or&#160;AUTOSAR environment.<br/>
The&#160;XCP protocol layer&#160;is&#160;placed over&#160;the&#160;XCP&#160;transport layer,&#160;which in&#160;turn is based&#160;on&#160;the&#160;<br/>actual bus communication.&#160;The&#160;implementation of&#160;the&#160;XCP protocol layer&#160;only&#160;consists of&#160;a&#160;<br/>single&#160;C&#160;file&#160;and a&#160;few&#160;H&#160;files&#160;(xcpBasix.c,&#160;xcpBasic.h,&#160;xcp_def.h and&#160;xcp_cfg.h).&#160;The examples&#160;<br/>include&#160;implementations&#160;for&#160;various&#160;transport layers, e.g.&#160;Ethernet and RS232. In&#160;the case of&#160;<br/>CAN,&#160;the&#160;transport layer&#160;is normally&#160;very&#160;simple and&#160;the&#160;various&#160;XCP message&#160;types&#160;are&#160;<br/>mapped directly&#160;to CAN messages.&#160;There are&#160;then&#160;separate&#160;fixed identifiers&#160;for&#160;the&#160;Tx&#160;and&#160;<br/>Rx&#160;directions.<br/>
The software interface between&#160;the&#160;transport&#160;and protocol layers is&#160;very&#160;simple.&#160;It&#160;contains&#160;<br/>just&#160;a few&#160;functions:<br/>&gt;&#160;&#160;When&#160;the&#160;Slave receives&#160;an&#160;XCP message&#160;over&#160;the&#160;bus, it&#160;first arrives in&#160;the communica­<br/>
tion&#160;driver,&#160;which&#160;routes the&#160;message to&#160;the&#160;XCP&#160;transport&#160;layer.&#160;The&#160;transport&#160;layer&#160;<br/>informs the&#160;protocol&#160;layer&#160;about the&#160;message&#160;with the&#160;function&#160;call&#160;XcpCommand().<br/>
&gt;&#160;&#160;If&#160;the&#160;XCP protocol layer&#160;wishes&#160;to send&#160;a message&#160;(e.g.&#160;a response&#160;to an&#160;XCP command&#160;<br/>
from&#160;the&#160;Master&#160;or&#160;a DAQ&#160;message),&#160;the&#160;message&#160;is&#160;routed&#160;to&#160;the&#160;transport layer&#160;by&#160;a call&#160;<br/>of&#160;the&#160;ApplXcpSend() function.<br/>
&gt;&#160;&#160;The&#160;transport layer&#160;informs&#160;the&#160;protocol layer&#160;that&#160;the&#160;message&#160;was successfully&#160;sent by&#160;<br/>
the&#160;function&#160;call XcpSendCallBack().<br/>
<hr/>
<a name=99></a>5 Example of&#160;an&#160;XCP Implementation<br/>
107<br/>
<b>Application</b><br/>
ointer<br/>etP<br/>
vent<br/>
ackground<br/>
cpG<br/>
cpE<br/>
cpInit<br/>
cpB<br/>
pplX<br/>
X<br/>
X<br/>
X<br/>
A<br/>
<b>XCP&#160;Protocol&#160;Layer</b><br/>
and<br/>
end<br/>
alback<br/>
pplication&#160;– XCP Transport&#160;Layer Interface&#160;<br/>
m<br/>
A<br/>
cpS<br/>
om<br/>
endC<br/>
pplX<br/>
cpC<br/>
A<br/>
cpS<br/>
X<br/>
X<br/>
<b>XCP&#160;Transport&#160;Layer</b><br/>
<b>Physical&#160;Layer</b><br/>
<b>Figure 75:&#160;<br/>Incorporating&#160;</b><br/>
<b>Bus</b><br/>
<b>the&#160;XCP&#160;Slave&#160;<br/>in&#160;the ECU code</b><br/>
The interface between&#160;the application and&#160;the protocol&#160;layer&#160;can&#160;only&#160;be implemented&#160;via&#160;<br/>four&#160;functions:<br/>&gt;&#160;&#160;The&#160;application activates&#160;the&#160;XCP driver&#160;with&#160;the&#160;help&#160;of&#160;XcpInit().&#160;This call is made once&#160;<br/>
in&#160;the starting&#160;process.<br/>
&gt;&#160;&#160;With&#160;XcpEvent(),&#160;the&#160;application informs&#160;the&#160;XCP driver&#160;that a certain event has occurred&#160;<br/>
(e.g.&#160;“End of&#160;a computational cycle reached”).<br/>
&gt;&#160;&#160;The&#160;call&#160;XcpBackground() lets&#160;the&#160;XCP driver&#160;execute certain activities in background (e.g.&#160;<br/>
calculation of&#160;a checksum).<br/>
&gt;&#160;&#160;Since&#160;the addresses&#160;in&#160;A2L&#160;files are always defined&#160;as 40­bit&#160;values&#160;(32­bit address, 8­bit&#160;<br/>
address&#160;extension), the&#160;XCP&#160;driver&#160;uses&#160;the&#160;function&#160;ApplXcpGetPointer() to&#160;obtain&#160;a&#160;<br/>pointer&#160;from a&#160;A2L­conformant address.<br/>
These&#160;interfaces&#160;are sufficient&#160;to integrate basic&#160;functionalities&#160;for&#160;measurement and cali­<br/>bration.&#160;Other&#160;interfaces&#160;are only&#160;needed&#160;for&#160;extended&#160;functions such as page switching,&#160;<br/>identification or&#160;seed&#160;&amp; key.&#160;They&#160;are described in detail in documentation&#160;for&#160;the driver.<br/>
<hr/>
<a name=100></a>108<br/>
5 Example of&#160;an&#160;XCP Implementation<br/>
<b>5.1&#160;Description&#160;of&#160;Functions</b><br/>
<b>void&#160;XcpInit&#160;(void)</b><br/>
Task:&#160;&#160;<br/>Initialize&#160;the&#160;XCP&#160;driver.<br/>
Description:&#160;&#160;<br/>The&#160;application&#160;activates&#160;the&#160;XCP driver&#160;with&#160;XcpInit().&#160;This&#160;command must be executed&#160;<br/>exactly&#160;once before any&#160;sort of&#160;XCP driver&#160;function may&#160;be called.<br/>
<b>void&#160;XcpEvent&#160;(BYTE&#160;event)</b><br/>
Task:<br/>The application informs&#160;the&#160;XCP&#160;driver&#160;about&#160;which&#160;event occurred.&#160;A&#160;unique event&#160;number&#160;<br/>is assigned&#160;to each&#160;event here.&#160;<br/>
Description:<br/>In setting&#160;up&#160;the&#160;measurement configuration in&#160;the&#160;measurement and calibration&#160;tool,&#160;the&#160;<br/>user&#160;selects&#160;which&#160;measured&#160;values&#160;should be&#160;synchronously&#160;acquired&#160;with&#160;which events. The&#160;<br/>information&#160;on&#160;measured&#160;values&#160;and&#160;events originates&#160;from&#160;the&#160;A2L.&#160;The desired measure­<br/>ment configuration is communicated&#160;to&#160;the&#160;XCP driver&#160;in&#160;the&#160;form of&#160;DAQ&#160;lists.&#160;<br/>
Example of&#160;an event definition in an engine&#160;controller:<br/>XcpEvent (1);&#160;<br/>
// Event&#160;1&#160;stands&#160;for&#160;the&#160;10­ms task<br/>
XcpEvent (2);&#160;<br/>
// Event&#160;2&#160;stands&#160;for&#160;the&#160;100­ms task<br/>
XcpEvent (5);&#160;<br/>
// Event&#160;5&#160;stands&#160;for&#160;the&#160;1­ms task<br/>
XcpEvent (8);&#160;<br/>
// Event&#160;8 is used&#160;for&#160;ignition angle&#160;synchronous measurements<br/>
<b>BYTE&#160;XcpBackground&#160;(void)</b><br/>
Task:<br/>Execute background activities&#160;of&#160;the&#160;XCP driver.&#160;<br/>
Description:<br/>This&#160;function&#160;should be&#160;called&#160;periodically&#160;in&#160;a background&#160;or&#160;idle&#160;task. It is used by&#160;the&#160;&#160;<br/>XCP driver,&#160;for&#160;example,&#160;to compute&#160;the&#160;checksum, because&#160;the computation of&#160;a longer&#160;<br/>checksum&#160;in&#160;XcpCommand() could&#160;take&#160;an unacceptably&#160;long&#160;time.&#160;With each call of&#160;<br/>&#160;XcpBackground(), a partial checksum of&#160;256 bytes&#160;is computed.&#160;The duration of&#160;a&#160;checksum&#160;<br/>computation&#160;therefore&#160;depends&#160;on&#160;the&#160;call&#160;frequency&#160;of&#160;XcpBackground().&#160;There are no&#160;<br/>other&#160;requirements&#160;for&#160;the&#160;call&#160;frequency&#160;or&#160;periodicity.&#160;The&#160;return&#160;value 1 indicates&#160;that a&#160;<br/>checksum&#160;computation is currently&#160;running.&#160;<br/>
<hr/>
<a name=101></a>5.1 Description of&#160;Functions<br/>
109<br/>
<b>void&#160;XcpCommand (DWORD* pCommand)</b><br/>
Task:<br/>Interpret an&#160;XCP command.<br/>
Description:<br/>This&#160;function must be called each&#160;time&#160;the&#160;transport layer&#160;receives a&#160;XCP&#160;frame.&#160;The para­<br/>meter&#160;is&#160;a&#160;pointer&#160;to the&#160;frame.&#160;<br/>
<b>void&#160;ApplXcpSend (BYTE&#160;len, BYTE&#160;*msg)</b><br/>
Task:<br/>Transfer&#160;a frame to&#160;be&#160;sent to the&#160;transport&#160;layer.<br/>
Description:<br/>With this&#160;call, the&#160;protocol&#160;layer&#160;sends&#160;a&#160;message&#160;to the&#160;transport&#160;layer&#160;for&#160;transmission to&#160;<br/>the Master.&#160;The&#160;call&#160;XcpSendCallBack&#160;implements&#160;a&#160;handshake&#160;method&#160;between&#160;the&#160;proto­<br/>col and&#160;transport layers.&#160;<br/>
<b>BYTE&#160;XcpSendCallBack&#160;(void)</b><br/>
Task:<br/>The protocol&#160;layer&#160;uses&#160;this callback&#160;to&#160;inform&#160;the&#160;transport&#160;layer&#160;that&#160;the&#160;last&#160;message&#160;<br/>that was transferred to&#160;ApplXcpSend() was&#160;successfully&#160;transmitted.<br/>
Description:<br/>The&#160;protocol layer&#160;does&#160;not call an&#160;ApplXcpSend() command&#160;until&#160;XcpSendCallBack() indi­<br/>cates&#160;that the&#160;prior&#160;message&#160;was&#160;successfully&#160;transmitted.&#160;XcpSendCallBack()&#160;returns the&#160;<br/>value&#160;0 (FALSE) if&#160;the&#160;XCP driver&#160;is&#160;in&#160;idle. If&#160;there&#160;are&#160;more&#160;frames&#160;to be sent,&#160;ApplX­<br/>cpSend() is called directly&#160;from&#160;XcpSendCallBack().&#160;<br/>
<b>BYTE&#160;*ApplXcpGetPointer&#160;(BYTE&#160;addr_ext, DWORD&#160;addr)</b><br/>
Task:<br/>Convert&#160;an A2L­conformant address&#160;to a pointer.<br/>
Description:<br/>The&#160;function maps&#160;the&#160;40­bit&#160;A2L­conformant addressing&#160;(32­bit address + 8­bit address&#160;<br/>extension)&#160;that is sent by&#160;the&#160;XCP Master&#160;to a&#160;valid pointer.&#160;The address extension can be&#160;<br/>used,&#160;for&#160;example,&#160;to distinguish&#160;different address&#160;areas&#160;or&#160;memory&#160;types.<br/>
<hr/>
<a name=102></a>110<br/>
5 Example of&#160;an&#160;XCP Implementation<br/>
<b>5.2 Parameterization&#160;of&#160;the&#160;Driver</b><br/>
In many&#160;respects,&#160;the&#160;XCP driver&#160;is scalable and parameterizable&#160;to properly&#160;handle&#160;the&#160;<br/>wide&#160;variety&#160;of&#160;functional content,&#160;transport&#160;protocols and&#160;target&#160;platforms.&#160;All&#160;settings&#160;are&#160;<br/>made in&#160;the&#160;parameter&#160;file&#160;xcp_cfg.h. In&#160;the&#160;simplest&#160;case,&#160;they&#160;appear&#160;as&#160;follows:<br/>
/* Define&#160;protocol parameters */<br/>#define&#160;kXcpMaxCTO &#160; &#160; 8 &#160; &#160; &#160;/* Maximum CTO Message&#160;Length */<br/>#define&#160;kXcpMaxDTO &#160; &#160; 8 &#160; &#160; &#160;/* Maximum DTO Message&#160;Length */<br/>#define&#160;C_CPUTYPE_BIGENDIAN &#160; /* byte order&#160;Motorola */<br/>
/* Enable&#160;memory&#160;checksum&#160;*/<br/>#define&#160;XCP_ENABLE_CHECKSUM<br/>#define&#160;kXcpChecksumMethod XCP_CHECKSUM_TYPE_ADD14<br/>
/* Enable&#160;calibration */<br/>#define&#160;XCP_ENABLE_CALIBRATION<br/>#define&#160;XCP_ENABLE_SHORT_UPLOAD<br/>
/* Enable&#160;data acquisition */<br/>#define&#160;XCP_ENABLE_DAQ &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;<br/>#define&#160;kXcpDaqMemSize (512) /* Memory&#160;space reserved&#160;for&#160;DAQ */<br/>#define&#160;XCP_ENABLE_SEND_QUEUE<br/>
For&#160;a CAN&#160;transport layer,&#160;the&#160;appropriate&#160;CTO and&#160;DTO parameters of&#160;eight bytes are set.&#160;<br/>The driver&#160;must know&#160;whether&#160;it&#160;is running&#160;on a platform&#160;with Motorola or&#160;Intel&#160;byte&#160;order,&#160;<br/>in&#160;this case&#160;a Motorola­CPU (Big Endian).&#160;The&#160;remaining&#160;parameters activate&#160;the&#160;function­<br/>alities:&#160;measurement, calibration and checksum&#160;computation.&#160;The algorithm&#160;for&#160;checksum&#160;<br/>computation&#160;is&#160;configured&#160;(here summing&#160;of&#160;all bytes&#160;into a DWORD) and&#160;the parameter&#160;of&#160;<br/>the&#160;available memory&#160;is indicated&#160;for&#160;the&#160;measurement (here 512 bytes).&#160;The memory&#160;is pri­<br/>marily&#160;needed&#160;to&#160;store&#160;the DAQ&#160;lists and&#160;to&#160;buffer&#160;the data&#160;during&#160;the measurement.&#160;The&#160;<br/>parameter&#160;therefore determines&#160;the&#160;maximum possible number&#160;of&#160;measurement signals. In&#160;<br/>the&#160;driver&#160;documentation&#160;you&#160;will&#160;find more&#160;detailed&#160;information on estimating&#160;the&#160;neces­<br/>sary&#160;parameters.<br/>
<hr/>
<a name=103></a>6 Protocol Development Overview<br/>
111<br/>
<b>6 Protocol&#160;Development&#160;Overview</b><br/>
<hr/>
<a name=104></a>112<br/>
6 Protocol Development Overview<br/>
The&#160;following&#160;overview&#160;shows&#160;some of&#160;the&#160;essential developments of&#160;the&#160;XCP protocol,&#160;<br/>which&#160;was standardized in 2003.&#160;<br/>
<b>6.1.&#160;XCP&#160;Version&#160;1.1&#160;(2008)</b><br/>
&gt;&#160;&#160;Description of&#160;the same&#160;XCP&#160;interface using&#160;two&#160;different&#160;physical&#160;interfaces&#160;within&#160;the&#160;<br/>
same&#160;A2L&#160;(e.g.&#160;“XCP on&#160;Vehicle&#160;CAN” and “XCP on Calibration CAN”)<br/>
&gt;&#160;&#160;The&#160;new&#160;command&#160;WRITE_DAQ_MULTIPLE makes&#160;it possible&#160;to accelerate configuration&#160;<br/>
of&#160;the Slave.&#160;Two ODTs appearing in succession in a&#160;DAQ list can be communicated in a&#160;<br/>single&#160;step.&#160;<br/>
&gt;&#160;&#160;High&#160;time synchronization&#160;via&#160;“TIMESTAMP_EVENT.”&#160;Timestamp&#160;information&#160;is&#160;communi­<br/>
cated by&#160;the&#160;Slave.&#160;The&#160;trigger&#160;can be initiated&#160;via an external synchronization cable.&#160;<br/>
&gt;&#160;&#160;Compression of&#160;embedded&#160;A2L&#160;files<br/>
All expansions&#160;are optional.&#160;XCP 1.1 is&#160;thus&#160;compatible&#160;with&#160;XCP 1.0.<br/>
<b>6.2.&#160;XCP&#160;Version&#160;1.2&#160;(2013)</b><br/>
&gt;&#160;&#160;&#160;Parameters in&#160;the&#160;A2L&#160;for&#160;the definition of&#160;the required ECU&#160;resources&#160;via&#160;XCP­DAQ&#160;mea­<br/>
surement&#160;configurations (e.g.&#160;RAM&#160;usage,&#160;CPU&#160;execution&#160;time and&#160;required&#160;transfer&#160;band­<br/>width&#160;for&#160;CAN&#160;or&#160;Ethernet).&#160;The&#160;XCP Master&#160;can&#160;access&#160;the&#160;parameters, calculate&#160;<br/>resource usage&#160;for&#160;the&#160;measurement and&#160;warn&#160;the&#160;user&#160;if&#160;overshooting occurs.&#160;<br/>
&gt;&#160;&#160;Prioritization&#160;control by&#160;the&#160;Master&#160;for&#160;transfer&#160;of&#160;the&#160;measurement data&#160;via CAN.&#160;The&#160;<br/>
objective here is&#160;to not disturb&#160;the&#160;necessary&#160;communication&#160;flow&#160;of&#160;the&#160;vehicle CAN&#160;to&#160;<br/>the&#160;greatest&#160;degree&#160;possible.&#160;<br/>
&gt;&#160;&#160;Calculation of&#160;the&#160;required bandwidth and limits&#160;for&#160;the&#160;transfer&#160;of&#160;data&#160;via&#160;TCP or&#160;UDP<br/>&gt;&#160;&#160;Description of&#160;XCP on CAN FD<br/>
All expansions&#160;are optional.&#160;XCP 1.2 is&#160;thus&#160;compatible&#160;with&#160;XCP 1.1.<br/>
<hr/>
<a name=105></a>6.3.&#160;XCP&#160;Version 1.3 (2015)<br/>
113<br/>
<b>6.3.&#160;XCP&#160;Version&#160;1.3&#160;(2015)</b><br/>
&gt;&#160;&#160;Improvement of&#160;the&#160;time&#160;correlation&#160;of&#160;XCP Slaves&#160;using&#160;multicast&#160;solutions found&#160;on the&#160;<br/>
same network&#160;<br/>
&gt;&#160;&#160;&#160;Time&#160;synchronization&#160;between&#160;XCP Slave&#160;timestamp and&#160;external clock, e.g.&#160;via IEEE 1588<br/>&gt;&#160;&#160;Checking&#160;of&#160;the&#160;bypassing&#160;data&#160;flow&#160;and error&#160;handling<br/>
All expansions&#160;are optional.&#160;XCP 1.3 is&#160;thus&#160;compatible&#160;with&#160;XCP 1.2.<br/>
<hr/>
<a name=106></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-106_1.png"/><br/>
114<br/>
The&#160;Authors<br/>
<b>The&#160;Authors</b><br/>
<b>&#160;</b><br/>
&#160;<br/>
<b>Andreas Patzer</b><br/>
Mr. Patzer&#160;graduated in Electrical Engineering&#160;from&#160;the&#160;Technical University&#160;of&#160;<br/>Karlsruhe. In his&#160;studies&#160;he&#160;specialized in measurement and control engineering&#160;<br/>and information and industrial engineering.&#160;In 2003, he&#160;joined&#160;Vector&#160;Informatik&#160;<br/>GmbH in Stuttgart.&#160;Andreas&#160;Patzer&#160;has supported&#160;XCP projects&#160;from&#160;the&#160;very&#160;<br/>start, since&#160;XCP&#160;was standardized by&#160;ASAM e.V. in&#160;the&#160;same&#160;year&#160;he&#160;was hired.<br/>He&#160;currently&#160;manages&#160;the&#160;Customer&#160;Relations and Services&#160;area as a&#160;team&#160;<br/>leader&#160;for&#160;the&#160;Measurement &amp; Calibration product line.<br/>
<hr/>
<a name=107></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-107_1.png"/><br/>
The&#160;Authors<br/>
115<br/>
&#160;<br/>
<b>Rainer&#160;Zaiser</b><br/>
Mr. Zaiser&#160;has&#160;a degree&#160;in Electrical Engineering&#160;from&#160;the&#160;University&#160;of&#160;<br/>Stuttgart.&#160;After&#160;graduating,&#160;he&#160;came directly&#160;to&#160;Vector&#160;Informatik&#160;GmbH in&#160;<br/>autumn 1988,&#160;where he&#160;has&#160;helped&#160;to create many&#160;of&#160;the&#160;standards&#160;that have&#160;<br/>become established&#160;in&#160;the&#160;automotive industry&#160;such&#160;as DBC, MDF, CCP,&#160;A2L&#160;<br/>and&#160;to a large&#160;extent&#160;XCP. From&#160;the&#160;start, he&#160;headed&#160;up&#160;the&#160;Measurement &amp;&#160;<br/>Calibration and Network&#160;Interfaces&#160;product lines.<br/>
<hr/>
<a name=108></a>116<br/>
Table&#160;of&#160;Abbreviations&#160;and Acronyms<br/>
<b>Table&#160;of&#160;Abbreviations&#160;and&#160;Acronyms&#160;</b><br/>
A2L&#160;&#160;<br/>
File extension&#160;for&#160;an&#160;ASAM&#160;2MC language&#160;file<br/>
AML&#160;&#160;<br/>
ASAM&#160;2 Meta Language<br/>
ASAM&#160;&#160;<br/>
Association&#160;for&#160;Standardisation of&#160;Automation and Measuring Systems<br/>
BYP&#160;&#160;<br/>
Bypassing<br/>
CAL&#160;&#160;<br/>
Calibration<br/>
CAN&#160;&#160;<br/>
Controller&#160;Area Network<br/>
CCP&#160;&#160;<br/>
CAN Calibration Protocol<br/>
CMD&#160;&#160;<br/>
Command<br/>
CS&#160;&#160;<br/>
Checksum<br/>
CTO&#160;&#160;<br/>
Command&#160;Transfer&#160;Object<br/>
CTR&#160;&#160;<br/>
Counter<br/>
DAQ&#160;&#160;<br/>
Data&#160;Acquisition, Data&#160;Acquisition Packet<br/>
DTO&#160;&#160;<br/>
Data&#160;Transfer&#160;Object<br/>
ECU&#160;&#160;<br/>
Electronic Control Unit<br/>
ERR&#160;&#160;<br/>
Error&#160;Packet<br/>
EV&#160;&#160;<br/>
Event Packet<br/>
FIBEX&#160;<br/>
Field Bus Exchange&#160;Format&#160;<br/>
LEN&#160;&#160;<br/>
Length<br/>
MCD&#160;&#160;<br/>
Measurement Calibration and Diagnostics<br/>
MTA&#160;&#160;<br/>
Memory&#160;Transfer&#160;Address<br/>
ODT&#160;&#160;<br/>
Object Descriptor&#160;Table<br/>
PAG&#160;&#160;<br/>
Paging<br/>
PGM&#160;&#160;<br/>
Programming<br/>
PHY&#160;<br/>
&#160;Physical&#160;Layer&#160;respectively&#160;description of&#160;the chip&#160;connecting&#160;a&#160;link&#160;layer&#160;<br/>device&#160;to a physical medium,&#160;for&#160;example Ethernet PHY&#160;<br/>
PID&#160;&#160;<br/>
Packet Identifier<br/>
PTP&#160;<br/>
Precision&#160;Time&#160;Protocol&#160;<br/>
RES&#160;&#160;<br/>
Command Response&#160;Packet<br/>
SERV&#160;&#160;<br/>
Service Request Packet<br/>
SPI&#160;&#160;<br/>
Serial Peripheral Interface<br/>
STD&#160;&#160;<br/>
Standard<br/>
STIM&#160;&#160;<br/>
Data Stimulation Packet<br/>
TCP/IP&#160;&#160;<br/>
Transfer&#160;Control Protocol / Internet Protocol<br/>
TS&#160;&#160;<br/>
Timestamp<br/>
UDP/IP&#160;&#160;<br/>
Unified&#160;Data Protocol / Internet Protocol<br/>
USB&#160;&#160;<br/>
Universal Serial Bus<br/>
XCP&#160;&#160;<br/>
Universal Measurement and Calibration Protocol<br/>
Download&#160;<br/>
Sending&#160;of&#160;data&#160;from Master&#160;to Slave&#160;<br/>
Upload&#160;<br/>
Sending&#160;of&#160;data&#160;from Slave&#160;to Master<br/>
<hr/>
<a name=109></a>Literature&#160;&amp;&#160;Web Addresses<br/>
117<br/>
<b>Literature</b><br/>
XCP is specified&#160;by&#160;ASAM (Association&#160;for&#160;Standardisation of&#160;Automation and Measuring&#160;<br/>Systems).&#160;<br/>You&#160;will&#160;find&#160;details on&#160;the&#160;protocol and on&#160;ASAM at:&#160;<b>www.asam.net</b><br/>
<b>Web&#160;Addresses</b><br/>
Standardization committees:<br/>&gt;&#160;&#160;ASAM,&#160;XCP protocol­specific&#160;documents,&#160;A2L&#160;specification,&#160;<b>www.asam.net</b><br/>
Supplier&#160;of&#160;development software:<br/>&gt;&#160;&#160;MathWorks, information&#160;on&#160;MATLAB, Simulink&#160;and Simulink&#160;Coder,&#160;<b>www.mathworks.com</b>&#160;<br/>&gt;&#160;&#160;Vector&#160;Informatik&#160;GmbH, demo&#160;version of&#160;CANape,&#160;free&#160;of&#160;charge and openly&#160;available&#160;<br/>
XCP driver&#160;(basic&#160;version), comprehensive information on&#160;the&#160;topics of&#160;ECU&#160;calibration,&#160;<br/>testing&#160;and simulation,&#160;<b>www.vector.com</b><br/>
<hr/>
<a name=110></a>118<br/>
Table of&#160;Figures<br/>
<b>Table&#160;of&#160;Figures&#160;</b><br/>
Figure 1: Fundamental communication&#160;with a runtime environment&#160;..........................................8<br/>Figure 2:&#160;The&#160;Interface Model of&#160;ASAM...............................................................................................&#160;9<br/>Figure 3:&#160;An&#160;XCP Master&#160;can simultaneously&#160;communicate&#160;with multiple Slaves&#160;..................10<br/>Figure 4: Subdivision of&#160;the&#160;XCP protocol into protocol layer&#160;and&#160;transport layer&#160;................14<br/>Figure 5:&#160;XCP Slaves&#160;can be used&#160;in many&#160;different runtime environments&#160;............................15<br/>Figure 6:&#160;XCP packet&#160;..............................................................................................................................19<br/>Figure 7: Overview&#160;of&#160;XCP Packet Identifier&#160;(PID)&#160;.........................................................................19<br/>Figure 8:&#160;XCP communication model&#160;with CTO/DTO&#160;....................................................................20<br/>Figure 9: Message&#160;identification&#160;.........................................................................................................21<br/>Figure&#160;10: Timestamp&#160;............................................................................................................................21<br/>Figure 11: Data&#160;field&#160;in&#160;the&#160;XCP packet&#160;............................................................................................22<br/>Figure 12:&#160;The&#160;three&#160;modes&#160;of&#160;the&#160;XCP protocol: Standard, Block&#160;and Interleaved mode&#160;...24<br/>Figure 13: Overview&#160;of&#160;the&#160;CTO packet structure&#160;..........................................................................25<br/>Figure 14:&#160;Trace example&#160;from a calibration process&#160;.....................................................................30<br/>Figure 15:&#160;Transfer&#160;of&#160;a parameter&#160;set&#160;file&#160;to an ECU’s RAM&#160;.....................................................31<br/>Figure 16: Hex&#160;window&#160;..........................................................................................................................32<br/>Figure 17:&#160;Address&#160;information of&#160;the parameter&#160;“Triangle”&#160;from&#160;the&#160;A2L&#160;file&#160;......................33<br/>Figure 18: Polling&#160;communication in&#160;the CANape&#160;Trace&#160;window&#160;................................................34<br/>Figure 19: Events in&#160;the&#160;ECU&#160;...............................................................................................................35<br/>Figure 20: Event definition in an&#160;A2L&#160;.................................................................................................35<br/>Figure 21:&#160;Allocation of&#160;“Triangle”&#160;to possible&#160;events in&#160;the&#160;A2L&#160;................................................36<br/>Figure 22: Selecting&#160;events (measurement mode)&#160;for&#160;each&#160;measurement parameter&#160;.........36<br/>Figure 23: Excerpt&#160;from&#160;the&#160;CANape&#160;Trace&#160;window&#160;of&#160;a DAQ measurement&#160;.........................37<br/>Figure 24: ODT:&#160;Allocation of&#160;RAM addresses&#160;to DAQ DTO&#160;.........................................................38<br/>Figure 25: DAQ list&#160;with&#160;three&#160;ODTs&#160;..................................................................................................39<br/>Figure 26: Static DAQ lists&#160;...................................................................................................................40<br/>Figure 27: Dynamic DAQ lists&#160;..............................................................................................................41<br/>Figure 28: Event&#160;for&#160;DAQ and STIM&#160;...................................................................................................42<br/>Figure 29: Structure of&#160;the&#160;XCP packet&#160;for&#160;DTO&#160;transmissions..................................................43<br/>Figure 30: Identification&#160;field&#160;with absolute ODT&#160;numbers&#160;..........................................................44<br/>Figure 31: ID&#160;field&#160;with relative ODT&#160;and absolute DAQ numbers (one byte)&#160;.........................44<br/>Figure 32: ID&#160;field&#160;with relative ODT&#160;and absolute DAQ numbers (two bytes)&#160;......................44<br/>Figure 33:&#160;&#160;ID&#160;field&#160;with relative ODT&#160;and absolute DAQ numbers as&#160;well as&#160;fill byte&#160;<br/>
(total of&#160;four&#160;bytes)&#160;............................................................................................................45<br/>
Figure 34:&#160;XCP Slave&#160;with&#160;free­running clock&#160;&#160;.................................................................................46<br/>Figure 35:&#160;The&#160;clock&#160;of&#160;the&#160;XCP Slave is synchronized&#160;with&#160;the&#160;grandmaster&#160;clock&#160;&#160;.............47<br/>Figure 36: Definition of&#160;which&#160;bus nodes&#160;send&#160;which&#160;messages&#160;.................................................49<br/>Figure 37: Representation of&#160;a CAN network&#160;..................................................................................50<br/>Figure 38: Example of&#160;XCP­on­CAN&#160;communication&#160;.....................................................................51<br/>Figure 39: Representation of&#160;an&#160;XCP­on­CAN message&#160;...............................................................51<br/>Figure 40: Illustration of&#160;a CAN FD&#160;frame&#160;........................................................................................52<br/>Figure 41: Nodes&#160;K&#160;and L&#160;are redundantly&#160;interconnected&#160;...........................................................54<br/>Figure 42: Communication by&#160;slot definition&#160;...................................................................................54<br/>Figure 43: Representation of&#160;a FlexRay&#160;communication matrix..................................................55<br/>Figure 44: Representation of&#160;the&#160;FlexRay&#160;LPDUs&#160;...........................................................................56<br/>
<hr/>
<a name=111></a>Table of&#160;Figures<br/>
119<br/>
Figure 45:&#160;Allocation of&#160;XCP communication&#160;to LPDUs&#160;................................................................57<br/>Figure 46:&#160;XCP packet&#160;with&#160;TCP/IP or&#160;UDP/IP&#160;................................................................................58<br/>Figure 47:&#160;XCP­on­SxI packet&#160;..............................................................................................................59<br/>Figure 48: Memory&#160;representation&#160;.....................................................................................................61<br/>Figure 49: Representation of&#160;driver&#160;settings&#160;for&#160;the&#160;flash&#160;area&#160;..................................................63<br/>Figure 50: Representation of&#160;the&#160;block&#160;transfer&#160;mode&#160;..................................................................66<br/>Figure 51: Parameters in a calibration&#160;window&#160;...............................................................................72<br/>Figure 52: Signal&#160;response&#160;over&#160;time&#160;.................................................................................................72<br/>Figure 53: Initial parameter&#160;setting&#160;in RAM&#160;.....................................................................................82<br/>Figure 54: Initial situation after&#160;booting&#160;...........................................................................................86<br/>Figure 55: Pointer&#160;change&#160;and copying&#160;to RAM&#160;..............................................................................87<br/>Figure 56: Pointer&#160;table&#160;for&#160;individual parameters&#160;.........................................................................87<br/>Figure 57: Double pointer&#160;concept&#160;......................................................................................................89<br/>Figure 58:&#160;Application areas&#160;and application cases&#160;.......................................................................92<br/>Figure 59: Plants and controllers&#160;........................................................................................................92<br/>Figure 60: Model in&#160;the&#160;Loop in Simulink&#160;..........................................................................................93<br/>Figure 61: CANape as measurement and calibration&#160;tool&#160;with Simulink&#160;models&#160;...................93<br/>Figure 62: Software in&#160;the&#160;Loop&#160;with Simulink&#160;environment&#160;.......................................................94<br/>Figure 63: CANape as SIL&#160;development platform&#160;..........................................................................94<br/>Figure 64: HIL&#160;solution&#160;...........................................................................................................................95<br/>Figure 65: HIL&#160;with CANape as measurement and calibration&#160;tool&#160;...........................................95<br/>Figure 66: CANoe as HIL&#160;system&#160;.........................................................................................................96<br/>Figure 67: CANoe as HIL&#160;system&#160;with&#160;XCP access&#160;to&#160;the&#160;ECU&#160;...................................................96<br/>Figure 68: CANape as HIL&#160;solution&#160;.....................................................................................................97<br/>Figure 69: RCP solution&#160;.........................................................................................................................97<br/>Figure 70: Basic principle&#160;of&#160;bypassing&#160;..............................................................................................99<br/>Figure 71: Bypassing&#160;flow&#160;.....................................................................................................................99<br/>Figure 72: Bypassing&#160;with real­time bypassing hardware and&#160;fast ECU access&#160;.................&#160;100<br/>Figure 73: Short calibration cycles&#160;with&#160;virtual ECUs&#160;.................................................................&#160;101<br/>Figure 74: Process&#160;flow&#160;with&#160;virtual ECUs&#160;.....................................................................................&#160;102<br/>Figure 75: Incorporating&#160;the&#160;XCP Slave in&#160;the&#160;ECU code&#160;..........................................................&#160;107<br/>
<hr/>
<a name=112></a>120<br/>
Appendix&#160;–&#160;XCP Solutions at&#160;Vector<br/>
<b>Appendix&#160;–&#160;XCP&#160;Solutions&#160;at&#160;Vector</b><br/>
Vector&#160;made&#160;a significant effort in giving&#160;shape&#160;to&#160;the&#160;XCP standard. Its extensive know­<br/>how&#160;and&#160;vast experience&#160;were utilized&#160;to provide comprehensive&#160;XCP support:<br/>
<b>Tools<br/></b>&gt;&#160;&#160;The&#160;primary&#160;use&#160;area of&#160;<b>CANape</b>&#160;is in optimal parameterization (calibration) of&#160;electronic&#160;<br/>
control units&#160;(ECUs). During&#160;the&#160;system’s runtime,&#160;you calibrate&#160;parameter&#160;values and&#160;<br/>simultaneously&#160;acquire measured signals.&#160;The&#160;physical interface between&#160;CANape and&#160;the&#160;<br/>ECU is over&#160;XCP (for&#160;all standardized&#160;transport protocols) or&#160;CCP.&#160;<br/>
&gt;&#160;&#160;Complete&#160;tool chain&#160;for&#160;generating&#160;and managing&#160;the&#160;necessary&#160;A2L&#160;description&#160;files&#160;<br/>
(<b>ASAP2&#160;Tool-Set</b>&#160;and&#160;<b>CANape</b>&#160;with the&#160;<b>ASAP2 Editor</b>).<br/>
&gt;&#160;&#160;&#160;You&#160;&#160;use&#160;&#160;<b>CANoe.XCP</b>&#160;to access&#160;internal ECU&#160;values&#160;for&#160;testing&#160;and analysis&#160;tasks.<br/>
<b>ECU Interfaces<br/></b>The&#160;<b>VX1000</b>&#160;measurement and calibration hardware offers&#160;the&#160;option of&#160;equipping ECUs&#160;<br/>with&#160;an&#160;XCP­on­Ethernet interface.&#160;This&#160;involves&#160;connecting&#160;a Plug on Device (POD)&#160;to&#160;the&#160;<br/>ECU&#160;for&#160;direct access&#160;to&#160;the&#160;controller, e.g.&#160;over&#160;DAP,&#160;JTAG, Nexus, etc.&#160;The POD&#160;transmits&#160;<br/>the&#160;data&#160;to a base&#160;module,&#160;which&#160;operates&#160;as&#160;an&#160;XCP Slave&#160;and provides&#160;the data&#160;to&#160;the&#160;<br/>XCP Master&#160;on&#160;the&#160;PC over&#160;XCP on Ethernet.&#160;This&#160;makes&#160;it unnecessary&#160;to have an&#160;XCP&#160;<br/>Slave&#160;in&#160;the&#160;ECU.&#160;The&#160;user&#160;benefits&#160;from a high&#160;measurement data&#160;throughput rate of&#160;up&#160;to&#160;<br/>50 MByte/s and short measurement intervals of&#160;less&#160;than&#160;15 µs.<br/>
<b>Embedded Software<br/></b>Communication modules&#160;with separate&#160;transport layers&#160;for&#160;CAN, FlexRay&#160;and Ethernet:<br/>&gt;&#160;<b>&#160;XCP&#160;&#160;Basic</b>&#160;–&#160;free&#160;download at&#160;www.vector.com/xcp­driver, only&#160;contains basic&#160;XCP&#160;func­<br/>
tions.&#160;Configuration&#160;of&#160;the&#160;XCP protocol and&#160;modification&#160;of&#160;the&#160;transport layer&#160;are&#160;per­<br/>formed&#160;manually&#160;in&#160;the&#160;source&#160;code.&#160;You need&#160;to integrate&#160;XCP Basic in&#160;your&#160;project&#160;<br/>yourself.<br/>
&gt;&#160;&#160;<b>XCP&#160;Professional</b>&#160;– contains&#160;useful extensions&#160;to&#160;the&#160;ASAM specification and enables&#160;tool­<br/>
based&#160;configuration.&#160;Available&#160;for&#160;Vector&#160;CANbedded&#160;basic software.<br/>
&gt;&#160;&#160;<b>MICROSAR XCP</b>&#160;– contains&#160;the&#160;functional&#160;features&#160;of&#160;XCP Professional and is based on&#160;<br/>
AUTOSAR specifications.&#160;Available&#160;for&#160;Vector&#160;MICROSAR basic software.<br/>
<b>Services<br/></b>&gt;&#160;&#160;<b>Consultation</b>&#160;for&#160;using&#160;XCP in&#160;your&#160;projects&#160;<br/>&gt;&#160;<b>&#160;Integration</b>&#160;of&#160;XCP in&#160;your&#160;ECU<br/>
<b>Training<br/></b>&gt;&#160;&#160;You can&#160;learn about&#160;the&#160;underlying&#160;mechanisms&#160;and&#160;models of&#160;the protocol in&#160;the&#160;<b>“XCP&#160;</b><br/>
<b>Fundamentals&#160;Seminar”</b>.<br/>
&gt;&#160;&#160;&#160;In&#160;&#160;the&#160;&#160;<b>“CANape&#160;with&#160;XCP&#160;on&#160;FlexRay&#160;Workshop”</b>&#160;you learn&#160;about FlexRay&#160;fundamentals&#160;<br/>
and&#160;the&#160;special&#160;aspects of&#160;XCP on FlexRay&#160;are explained,&#160;in particular&#160;dynamic bandwidth&#160;<br/>management.<br/>
<hr/>
<a name=113></a><img src="ElectricPowerSteering_RH850_BMW_FAAR_WE_website/content/en/docs/Xcp/doc/XCP_ReferenceBook_V3.0_EN-113_1.png"/><br/>
Special&#160;XCP Support by&#160;CANape<br/>
121<br/>
<b>Special&#160;XCP&#160;Support&#160;by&#160;CANape<br/></b>CANape&#160;was&#160;the&#160;first&#160;MCD tool to&#160;support the&#160;XCP&#160;1.0&#160;specification&#160;and was&#160;also the first&#160;<br/>XCP on FlexRay&#160;Master&#160;on&#160;the&#160;market.<br/>
A&#160;special&#160;technical&#160;feature&#160;of&#160;XCP on FlexRay&#160;is dynamic bandwidth management. Here,&#160;<br/>CANape&#160;identifies&#160;the&#160;available&#160;bandwidth&#160;provided&#160;for&#160;XCP in&#160;the&#160;FlexRay&#160;ClusterP and it&#160;<br/>allocates&#160;this&#160;bandwidth&#160;to&#160;the&#160;momentary&#160;application data&#160;traffic dynamically&#160;and&#160;very&#160;<br/>efficiently.&#160;The&#160;available bandwidth is&#160;thereby&#160;optimally&#160;used&#160;for&#160;XCP communication.&#160;<br/>
Moreover,&#160;CANape has a&#160;DLL&#160;interface.&#160;It&#160;enables&#160;support&#160;of&#160;XCP on&#160;any&#160;desired (user­<br/>defined)&#160;transport layer.&#160;This&#160;lets&#160;you integrate any&#160;desired&#160;test&#160;instrumentation or&#160;proprie­<br/>tary&#160;protocols&#160;in CANape.&#160;A&#160;code&#160;generator&#160;supports&#160;you in&#160;creating&#160;the&#160;XCP­specific share&#160;<br/>of&#160;such a driver.<br/>
<hr/>
<a name=114></a>122<br/>
Index<br/>
<b>Index</b><br/>
<b>A</b><br/>
<b>F</b><br/>
A2L&#160;<br/>
9,&#160;10,&#160;25,&#160;35,&#160;40,&#160;42,&#160;56,&#160;57,&#160;62,&#160;63,&#160;68,&#160;&#160;FIBEX&#160;<br/>
55&#160;–&#160;57<br/>
71&#160;–&#160;76,&#160;94,&#160;108,&#160;109,&#160;116<br/>
Flash memory&#160;<br/>
16,&#160;17,&#160;61&#160;–&#160;64,&#160;67<br/>
Address extension&#160;<br/>
29,&#160;33,&#160;38,&#160;107,&#160;109<br/>
FLX_CHANNEL&#160;<br/>
56<br/>
AML&#160;<br/>
25,&#160;74,&#160;116<br/>
FLX_LPDU_ID&#160;<br/>
56<br/>
ASAM&#160;<br/>
7&#160;–&#160;9,&#160;60,&#160;116<br/>
FLX_SLOT_ID&#160;<br/>
56<br/>
ASAP2 Tool­Set&#160;<br/>
76<br/>
Fullpassing&#160;<br/>
98<br/>
<b>B</b><br/>
<b>G</b><br/>
Bandwith optimization&#160;<br/>
34<br/>
GET_CAL_PAGE&#160;<br/>
25,&#160;62<br/>
Bus load&#160;<br/>
34<br/>
GET_DAQ_EVENT_INFO&#160;<br/>
65,&#160;77<br/>
BYP&#160;<br/>
116<br/>
GET_DAQ_LIST_INFO&#160;<br/>
77<br/>
Bypassing&#160;<br/>
45,&#160;98,&#160;100<br/>
GET_DAQ_PROCESSOR_INFO&#160;<br/>
45,&#160;65,&#160;77<br/>
GET_DAQ_RESOLUTION_INFO&#160;<br/>
65,&#160;77<br/>
<b>C</b><br/>
Grandmaster&#160;clock&#160;<br/>
47,&#160;48<br/>
CAN&#160;<br/>
7,&#160;8,&#160;14,&#160;24,&#160;29,&#160;33,&#160;38,&#160;49,&#160;50,&#160;51,&#160;55,&#160;<br/>
&#160;75,&#160;116<br/>
<b>H</b><br/>
CAN FD&#160;<br/>
52<br/>
HIL&#160;<br/>
92,&#160;95&#160;–&#160;97<br/>
CCP&#160;<br/>
7,&#160;8,&#160;40,&#160;49,&#160;116<br/>
CMD&#160;<br/>
25,&#160;56,&#160;116<br/>
<b>I</b><br/>
CTO&#160;<br/>
21,&#160;22,&#160;25,&#160;116<br/>
IEEE 1588&#160;<br/>
47<br/>
CTR&#160;<br/>
58,&#160;59,&#160;116<br/>
IF_DATA&#160;<br/>
25<br/>
CYCLE_REPETITION&#160;<br/>
56<br/>
<b>K</b><br/>
<b>D</b><br/>
Commands&#160;<br/>
25<br/>
DAQ&#160;<br/>
22,&#160;32&#160;–&#160;45,&#160;65,&#160;67,&#160;77,&#160;99,&#160;100,&#160;106,&#160;&#160;Compile&#160;<br/>
76,&#160;80,&#160;82,&#160;94<br/>
108,&#160;116<br/>
DAQ_KEY_BYTE&#160;<br/>
45<br/>
<b>L</b><br/>
DBC&#160;<br/>
49<br/>
Linking&#160;<br/>
80,&#160;94<br/>
Double Pointer&#160;Concept&#160;<br/>
88<br/>
LPDU&#160;<br/>
56<br/>
DOWNLOAD&#160;<br/>
30,&#160;31,&#160;66<br/>
DTO&#160;<br/>
21,&#160;22,&#160;33,&#160;37,&#160;116<br/>
<b>M<br/></b>Maturity&#160;level&#160;<br/>
31&#160;<br/>
<b>E</b><br/>
MIL&#160;<br/>
93<br/>
ECU&#160;<br/>
9,&#160;74,&#160;98,&#160;99,&#160;116<br/>
MTA&#160;<br/>
30,&#160;116<br/>
ECU&#160;description&#160;file&#160;A2L&#160;<br/>
72&#160;– 77<br/>
Multicast&#160;46,&#160;<br/>
113<br/>
EEPROM&#160;<br/>
16,&#160;31,&#160;67<br/>
ERR&#160;<br/>
25,&#160;28,&#160;116<br/>
<b>O</b><br/>
Ethernet&#160;57&#160;–&#160;59<br/>
ODT&#160;<br/>
37&#160;–&#160;41,&#160;43,&#160;44,&#160;65,&#160;77,&#160;116<br/>
EV&#160;<br/>
29,&#160;116<br/>
OFFSET&#160;<br/>
56<br/>
Event&#160;<br/>
35,&#160;38&#160;–&#160;40,&#160;42,65,&#160;67,&#160;77,&#160;108<br/>
<hr/>
<a name=115></a>Index<br/>
123<br/>
<b>P<br/></b>PAG&#160;<br/>
116<br/>
Page&#160;<br/>
61&#160;–&#160;63<br/>
Page switching&#160;<br/>
62,&#160;63<br/>
Parameter&#160;<br/>
85<br/>
PGM&#160;<br/>
116<br/>
PID&#160;<br/>
8,&#160;19,&#160;21,&#160;25,&#160;43,&#160;116<br/>
Polling&#160;<br/>
33,&#160;34,&#160;36<br/>
PTP&#160;<br/>
47<br/>
<b>R<br/></b>RAM&#160;<br/>
16&#160;–&#160;18,&#160;30,&#160;31,&#160;37,&#160;39,&#160;63,&#160;67,&#160;80,&#160;82,&#160;<br/>
85,&#160;86,&#160;88<br/>
Reboot&#160;<br/>
32<br/>
RES&#160;<br/>
21,&#160;28,&#160;56,&#160;116<br/>
<b>S<br/></b>Sector&#160;&#160;<br/>
61 – 63<br/>
Segment&#160;<br/>
61 – 63<br/>
SEGMENT_NUMBER&#160;<br/>
62<br/>
SERV&#160;<br/>
29,&#160;116<br/>
SET_CAL_PAGE&#160;<br/>
25,&#160;62<br/>
SET_MTA&#160;<br/>
30<br/>
SHORT_UPLOAD&#160;<br/>
30,&#160;33,&#160;66<br/>
SIL&#160;<br/>
92,&#160;94<br/>
Single Pointer&#160;Concept&#160;<br/>
86<br/>
STIM&#160;<br/>
33,&#160;42,&#160;43,&#160;45,&#160;65,&#160;77,&#160;100,&#160;116<br/>
Stimulation&#160;<br/>
29,&#160;68,&#160;101<br/>
<b>T<br/></b>Task&#160;<br/>
108<br/>
TCP/IP&#160;<br/>
57,&#160;58,&#160;116<br/>
<b>U<br/></b>UDP/IP&#160;<br/>
57,&#160;58,&#160;116<br/>
USB&#160;<br/>
60,&#160;116<br/>
<b>V<br/></b>Virtual ECU&#160;<br/>
101<br/>
Volatile&#160;81,&#160;82<br/>VX1000&#160;<br/>
100<br/>
<hr/>
<a name=116></a><b>Get More Information</b><br/>
<b>Visit&#160;our&#160;Website&#160;for:<br/></b>&gt;&#160;News<br/>&gt;&#160;Products<br/>&gt;&#160;Demo Software<br/>&gt;&#160;Support<br/>&gt;&#160;Trainings&#160;Classes<br/>&gt;&#160;Addresses&#160;<br/>
16<br/>/20<br/>
0 | 12<br/>
<b>www.vector.com</b><br/>
V3.<br/>
<hr/>
<a name="outline"></a><h1>Document Outline</h1>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#5">Table of Contents</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#7">Introduction</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#11">1 Fundamentals of the XCP Protocol</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#17">1.1 XCP Protocol Layer</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#19">1.1.1 Identification Field</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#19">1.1.2 Timestamp</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#20">1.1.3 Data Field</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#20">1.2 Exchange of CTOs</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#20">1.2.1 XCP Command Structure</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#23">1.2.2 CMD</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#26">1.2.3 RES</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#26">1.2.4 ERR</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#27">1.2.5 EV</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#27">1.2.6 SERV</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#27">1.2.7 Calibrating Parameters in the Slave</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#30">1.3 Exchanging DTOs – Synchronous Data Exchange</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#31">1.3.1 Measurement Methods: Polling versus DAQ</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#32">1.3.2 DAQ Measurement Method</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#40">1.3.3 STIM Calibration Method</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#41">1.3.4 XCP Packet Addressing for DAQ and STIM</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#43">1.3.5 Bypassing = DAQ + STIM</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#43">1.3.6. Time Correlation and Synchronization</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#44">1.3.6.1 Multicast</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#45">1.3.6.2. Grandmaster Clock</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#47">1.4 XCP Transport Layers</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#47">1.4.1 CAN</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#50">1.4.2 CAN FD</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#52">1.4.3 FlexRay</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#55">1.4.4 Ethernet</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#57">1.4.5 SxI</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#58">1.4.6 USB</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#58">1.4.7 LIN</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#59">1.5 XCP Services</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#59">1.5.1 Memory Page Switching</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#61">1.5.2 Saving Memory Pages – Data Page Freezing</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#61">1.5.3 Flash Programming</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#63">1.5.4 Automatic Detection of the Slave</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#64">1.5.5 Block Transfer Mode for Upload, Download and Flashing</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#65">1.5.6 Cold Start Measurement (during Power-On)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#66">1.5.7 Security Mechanisms with XCP</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#67">2 ECU Description File A2L</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#70">2.1 Setting Up an A2L File for an XCP Slave</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#71">2.2 Manually Creating an A2L File</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#72">2.3 A2L Contents versus ECU Implementation</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#74">3 Calibration Concepts</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#75">3.1 Parameters in Flash</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#77">3.2 Parameters in RAM</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#79">3.3 Flash Overlay</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#80">3.4 Dynamic Flash Overlay Allocation</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#81">3.5 RAM Pointer Based Calibration Concept per AUTOSAR</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#81">3.5.1 Single Pointer Concept</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#83">3.5.2 Double Pointer Concept</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#84">3.6 Flash Pointer Based Calibration Concept</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#85">4 Application Areas of XCP</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#87">4.1 Model in the Loop (MIL)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#88">4.2 Software in the Loop (SIL)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#89">4.3 Hardware in the Loop (HIL)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#91">4.4 Rapid Control Prototyping (RCP)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#92">4.5 Bypassing</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#95">4.6 Shortening Iteration Cycles with Virtual ECUs</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#97">5 Example of an XCP Implementation</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#100">5.1 Description of Functions</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#102">5.2 Parameterization of the Driver</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#103">6 Protocol Development Overview</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#104">6.1. XCP Version 1.1 (2008)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#104">6.2. XCP Version 1.2 (2013)</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#105">6.3. XCP Version 1.3 (2015)</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#106">The Authors</a>
<ul>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#106">Andreas Patzer</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#107">Rainer Zaiser</a></li>
</ul>
</li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#108">Table of Abbreviations and Acronyms</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#109">Literature &amp; Web Addresses</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#110">Table of Figures</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#112">Appendix – XCP Solutions at Vector</a></li>
<li><a href="XCP_ReferenceBook_V3.0_ENs.html#114">Index</a></li>
</ul>
<hr/>
</body>
</html>
